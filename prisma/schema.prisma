// PhotoProOS - The Business OS for Professional Photographers
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum PlanName {
  free
  pro
  studio
  enterprise
}

enum ProjectStatus {
  draft
  pending
  delivered
  archived
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
  overdue
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

enum ContractStatus {
  draft
  sent
  signed
  expired
  cancelled
}

enum ClientIndustry {
  real_estate
  wedding
  portrait
  commercial
  architecture
  food_hospitality
  events
  headshots
  product
  other
}

enum ActivityType {
  gallery_created
  gallery_delivered
  gallery_viewed
  gallery_paid
  payment_received
  payment_failed
  client_added
  booking_created
  booking_confirmed
  invoice_sent
  invoice_paid
  contract_sent
  contract_signed
  email_sent
  file_uploaded
  file_downloaded
  settings_updated
}

enum NotificationType {
  payment_received
  gallery_viewed
  contract_signed
  booking_confirmed
  invoice_overdue
  system
}

enum TaskStatus {
  todo
  in_progress
  in_review
  blocked
  completed
  archived
}

enum TaskPriority {
  urgent
  high
  medium
  low
}

enum MemberRole {
  owner
  admin
  member
}

enum PortalMode {
  light
  dark
  auto // Follow system preference
}

enum ServiceCategory {
  real_estate
  portrait
  event
  commercial
  wedding
  product
  other
}

enum PropertyType {
  single_family
  condo
  townhouse
  multi_family
  land
  commercial
  other
}

enum EquipmentCategory {
  camera
  lens
  lighting
  drone
  tripod
  audio
  stabilizer
  backdrop
  other
}

enum CapabilityLevel {
  learning
  capable
  expert
}

enum LeadStatus {
  new
  contacted
  qualified
  closed
}

enum MarketingAssetType {
  flyer_portrait
  flyer_landscape
  social_square
  social_story
  postcard
  email_banner
  video_slideshow
}

enum PropertyWebsiteTemplate {
  modern
  classic
  luxury
  minimal
  commercial
}

enum LineItemType {
  service
  travel
  custom
  discount
  tax
}

enum BusinessType {
  solo
  team
  agency
}

enum DisplayMode {
  personal
  company
}

enum Industry {
  real_estate
  commercial
  events
  portraits
  food
  product
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Organization {
  id                  String   @id @default(cuid())
  clerkOrganizationId String?  @unique
  name                String
  slug                String   @unique
  plan                PlanName @default(free)

  // Stripe
  stripeCustomerId       String? @unique
  stripeSubscriptionId   String?
  stripeConnectAccountId String?
  stripeConnectOnboarded Boolean @default(false)

  // Branding
  logoUrl        String?
  logoLightUrl   String? // Logo variant for light backgrounds
  faviconUrl     String?
  primaryColor   String? @default("#3b82f6")
  secondaryColor String? @default("#8b5cf6")
  accentColor    String? @default("#22c55e")
  customDomain   String? @unique

  // Portal Appearance (free features)
  portalMode        PortalMode @default(dark) // light or dark mode for client-facing pages
  invoiceLogoUrl    String? // Separate logo for invoices (optional)

  // White-Label Options (paid plans only)
  hidePlatformBranding Boolean @default(false) // Hide "Powered by PhotoProOS"
  customEmailDomain    String? // For white-label email sending

  // Settings
  timezone String @default("America/New_York")
  currency String @default("USD")

  // Tax settings
  defaultTaxRate   Float?  @default(0) // Default tax rate as percentage (e.g., 8.25 for 8.25%)
  taxLabel         String? @default("Sales Tax") // Label shown on invoices (e.g., "Sales Tax", "VAT", "GST")

  // Travel fee settings
  homeBaseLocationId String?
  travelFeePerMile   Int?    @default(0) // in cents (e.g., 65 = $0.65/mile)
  travelFeeThreshold Float?  @default(0) // free miles before charging

  // ============================================================================
  // ONBOARDING & INDUSTRY SETTINGS
  // ============================================================================

  // Onboarding State
  onboardingCompleted   Boolean   @default(false)
  onboardingStep        Int       @default(0)
  onboardingCompletedAt DateTime?

  // Industry Selection (array of industry IDs)
  industries      Industry[] @default([real_estate])
  primaryIndustry Industry   @default(real_estate)

  // Enabled Modules/Features (array of module IDs like "galleries", "scheduling", etc.)
  enabledModules String[] @default([])

  // Business Profile (collected during onboarding)
  businessType    BusinessType?
  teamSize        String? // "1", "2-5", "6-10", "11-25", "25+"
  yearsInBusiness String? // "<1", "1-3", "3-5", "5-10", "10+"
  annualRevenue   String? // "<50k", "50-100k", "100-250k", "250k+"

  // Display Preferences (personal vs company branding)
  displayMode  DisplayMode @default(company)
  publicName   String? // What clients see (company or personal name)
  publicEmail  String? // Public-facing email
  publicPhone  String? // Public-facing phone
  website      String? // Company website

  // Stripe Trial/Payment
  trialStartedAt     DateTime?
  trialEndsAt        DateTime?
  paymentMethodAdded Boolean   @default(false)

  // Guided Tour Progress (JSON: { "dashboard": true, "galleries": false, ... })
  tourProgress Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members            OrganizationMember[]
  projects           Project[]
  clients            Client[]
  payments           Payment[]
  bookings           Booking[]
  bookingTypes       BookingType[]
  invoices           Invoice[]
  contracts          Contract[]
  contractTemplates  ContractTemplate[]
  activityLogs       ActivityLog[]
  notifications      Notification[]
  usageMeters        UsageMeter[]
  onboardingProgress OnboardingProgress?
  services           Service[]
  locations          Location[]
  equipment          Equipment[]
  homeBaseLocation   Location?            @relation("OrgHomeBase", fields: [homeBaseLocationId], references: [id])
  taskBoards         TaskBoard[]
  tasks              Task[]

  @@index([slug])
  @@index([plan])
}

model User {
  id          String  @id @default(cuid())
  clerkUserId String  @unique
  email       String  @unique
  fullName    String?
  avatarUrl   String?
  phone       String?

  // Personal info (collected during onboarding)
  firstName String?
  lastName  String?

  // Onboarding preferences
  hasSeenWelcome       Boolean  @default(false)
  tourCompletedModules String[] @default([])

  // Home base location (overrides org default for travel calculations)
  homeBaseLocationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships         OrganizationMember[]
  activityLogs        ActivityLog[]
  serviceCapabilities UserServiceCapability[]
  equipment           UserEquipment[]
  assignedBookings    Booking[]               @relation("AssignedBookings")
  homeBaseLocation    Location?               @relation("UserHomeBase", fields: [homeBaseLocationId], references: [id])
  assignedTasks       Task[]
  taskComments        TaskComment[]

  @@index([email])
  @@index([clerkUserId])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(member)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

// ============================================================================
// CLIENTS
// ============================================================================

model Client {
  id             String         @id @default(cuid())
  organizationId String
  email          String
  fullName       String?
  company        String?
  phone          String?
  address        String?
  industry       ClientIndustry @default(other)
  notes          String?

  // Metrics
  lifetimeRevenueCents Int @default(0)
  totalProjects        Int @default(0)

  // Portal access
  portalAccessToken String?   @unique
  lastPortalAccess  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects       Project[]
  bookings       Booking[]
  invoices       Invoice[]
  contracts      Contract[]
  payments       Payment[]
  clientSessions ClientSession[]
  tasks          Task[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([industry])
}

model ClientSession {
  id        String   @id @default(cuid())
  clientId  String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([token])
}

// ============================================================================
// SERVICES
// ============================================================================

model Service {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  category       ServiceCategory @default(other)
  description    String?
  priceCents     Int             @default(0)
  duration       String? // e.g., "2-3 hours"
  deliverables   String[] // Array of included items
  isActive       Boolean         @default(true)
  isDefault      Boolean         @default(false) // System-provided template
  sortOrder      Int             @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization          Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects              Project[] // Galleries using this service
  bookings              Booking[] // Bookings using this service
  userCapabilities      UserServiceCapability[] // Team members who can perform this service
  equipmentRequirements ServiceEquipmentRequirement[] // Equipment required for this service

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([isDefault])
}

// ============================================================================
// GALLERIES / PROJECTS
// ============================================================================

model Project {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String?
  serviceId      String?
  locationId     String?
  name           String
  description    String?
  status         ProjectStatus @default(draft)

  // Pricing
  priceCents Int    @default(0)
  currency   String @default("USD")

  // Gallery Settings
  coverImageUrl  String?
  password       String?
  expiresAt      DateTime?
  allowDownloads Boolean   @default(true)
  showWatermark  Boolean   @default(false)

  // Delivery
  deliveredAt   DateTime?
  viewCount     Int       @default(0)
  downloadCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  service         Service?          @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  location        Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  assets          Asset[]
  deliveryLinks   DeliveryLink[]
  payments        Payment[]
  favorites       GalleryFavorite[]
  comments        GalleryComment[]
  propertyWebsite PropertyWebsite?
  tasks           Task[]

  @@index([organizationId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([status])
  @@index([createdAt])
}

model Asset {
  id        String @id @default(cuid())
  projectId String

  // File info
  filename       String
  originalUrl    String
  thumbnailUrl   String?
  mediumUrl      String?
  watermarkedUrl String?

  // Metadata
  mimeType  String
  sizeBytes Int
  width     Int?
  height    Int?

  // EXIF data
  exifData Json?

  // Ordering
  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  favorites GalleryFavorite[]
  comments  GalleryComment[]

  @@index([projectId])
  @@index([sortOrder])
}

model DeliveryLink {
  id        String @id @default(cuid())
  projectId String
  slug      String @unique

  // Settings
  password  String?
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  // Analytics
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([slug])
}

model GalleryFavorite {
  id          String  @id @default(cuid())
  projectId   String
  assetId     String
  clientEmail String?
  sessionId   String?

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([projectId, assetId, clientEmail])
  @@index([projectId])
  @@index([assetId])
}

model GalleryComment {
  id          String  @id @default(cuid())
  projectId   String
  assetId     String? // Optional - if set, this is a per-photo comment; if null, it's a gallery-level comment
  clientEmail String?
  clientName  String?
  content     String

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset?  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([assetId])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String?
  invoiceId      String?
  clientId       String?

  // Amount
  amountCents Int
  currency    String        @default("USD")
  status      PaymentStatus @default(pending)

  // Stripe
  stripePaymentIntentId   String? @unique
  stripeCheckoutSessionId String? @unique
  stripeChargeId          String?

  // Client info
  clientEmail String?
  clientName  String?

  // Metadata
  description String?
  receiptUrl  String?

  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  invoice      Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// BOOKINGS
// ============================================================================

model BookingType {
  id              String  @id @default(cuid())
  organizationId  String
  name            String
  description     String?
  durationMinutes Int     @default(60)
  priceCents      Int     @default(0)
  color           String  @default("#3b82f6")
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings     Booking[]

  @@index([organizationId])
}

model Booking {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  bookingTypeId  String?
  serviceId      String?
  locationId     String?
  assignedUserId String?

  // Details
  title       String
  description String?
  status      BookingStatus @default(pending)

  // Time
  startTime DateTime
  endTime   DateTime
  timezone  String   @default("America/New_York")

  // Client info (for non-registered clients)
  clientName  String?
  clientEmail String?
  clientPhone String?

  // Location (legacy field kept for backwards compatibility)
  location      String?
  locationNotes String?
  isVirtual     Boolean @default(false)
  meetingUrl    String?

  // Travel calculations (cached from Distance Matrix API)
  distanceMiles     Float?
  travelTimeMinutes Int?
  travelFeeCents    Int?   @default(0)

  // Weather data (cached for performance)
  weatherCache    Json?
  weatherCachedAt DateTime?

  // Notes
  notes         String?
  internalNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client           Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  bookingType      BookingType?      @relation(fields: [bookingTypeId], references: [id], onDelete: SetNull)
  service          Service?          @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  locationRef      Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  assignedUser     User?             @relation("AssignedBookings", fields: [assignedUserId], references: [id], onDelete: SetNull)
  reminders        BookingReminder[]
  invoiceLineItems InvoiceLineItem[]
  tasks            Task[]

  @@index([organizationId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([assignedUserId])
  @@index([startTime])
  @@index([status])
}

model BookingReminder {
  id        String    @id @default(cuid())
  bookingId String
  sendAt    DateTime
  sent      Boolean   @default(false)
  sentAt    DateTime?

  createdAt DateTime @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([sendAt])
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  invoiceNumber  String

  // Status
  status InvoiceStatus @default(draft)

  // Amounts
  subtotalCents Int    @default(0)
  taxCents      Int    @default(0)
  discountCents Int    @default(0)
  totalCents    Int    @default(0)
  currency      String @default("USD")

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidAt    DateTime?

  // Client info
  clientName    String?
  clientEmail   String?
  clientAddress String?

  // Notes
  notes String?
  terms String?

  // Payment link
  stripePaymentLinkId String?
  paymentLinkUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  lineItems    InvoiceLineItem[]
  payments     Payment[]
  tasks        Task[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceLineItem {
  id          String       @id @default(cuid())
  invoiceId   String
  bookingId   String? // Link to booking for travel fees
  itemType    LineItemType @default(service)
  description String
  quantity    Int          @default(1)
  unitCents   Int
  totalCents  Int
  sortOrder   Int          @default(0)

  createdAt DateTime @default(now())

  // Relations
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([bookingId])
  @@index([itemType])
}

// ============================================================================
// CONTRACTS
// ============================================================================

model ContractTemplate {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  description    String?
  content        String  @db.Text
  isDefault      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contracts    Contract[]

  @@index([organizationId])
}

model Contract {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  templateId     String?

  // Details
  name    String
  content String         @db.Text
  status  ContractStatus @default(draft)

  // Metadata
  pdfUrl String?

  // Dates
  sentAt    DateTime?
  signedAt  DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?            @relation(fields: [clientId], references: [id], onDelete: SetNull)
  template     ContractTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  signers      ContractSigner[]
  auditLogs    ContractAuditLog[]

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
}

model ContractSigner {
  id         String  @id @default(cuid())
  contractId String
  email      String
  name       String?

  // Signing
  signatureUrl    String?
  signedAt        DateTime?
  signedIp        String?
  signedUserAgent String?

  // Token for signing
  signingToken   String    @unique
  tokenExpiresAt DateTime?

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([signingToken])
}

model ContractAuditLog {
  id         String  @id @default(cuid())
  contractId String
  action     String
  actorEmail String?
  actorIp    String?
  metadata   Json?

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([createdAt])
}

// ============================================================================
// ACTIVITY & NOTIFICATIONS
// ============================================================================

model ActivityLog {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?
  type           ActivityType
  description    String
  metadata       Json?

  // Related entities
  projectId  String?
  clientId   String?
  paymentId  String?
  bookingId  String?
  invoiceId  String?
  contractId String?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Notification {
  id             String           @id @default(cuid())
  organizationId String
  type           NotificationType
  title          String
  message        String
  linkUrl        String?
  read           Boolean          @default(false)
  readAt         DateTime?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([read])
  @@index([createdAt])
}

// ============================================================================
// USAGE & METERING
// ============================================================================

model UsageMeter {
  id             String @id @default(cuid())
  organizationId String
  month          String // "2025-01" format

  // Usage counts
  storageBytes     BigInt @default(0)
  galleriesCreated Int    @default(0)
  emailsSent       Int    @default(0)
  apiCalls         Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, month])
  @@index([organizationId])
  @@index([month])
}

model OnboardingProgress {
  id             String @id @default(cuid())
  organizationId String @unique

  // Legacy steps (kept for backwards compatibility)
  profileComplete     Boolean @default(false)
  brandingComplete    Boolean @default(false)
  firstGalleryCreated Boolean @default(false)
  stripeConnected     Boolean @default(false)

  // New Onboarding Wizard Steps
  welcomeViewed     Boolean @default(false) // Step 0
  personalComplete  Boolean @default(false) // Step 1: First/last name
  businessComplete  Boolean @default(false) // Step 2: Company, type, size
  brandingStepDone  Boolean @default(false) // Step 3: Display mode, public info
  industriesSet     Boolean @default(false) // Step 4: Industry selection
  featuresSelected  Boolean @default(false) // Step 5: Module selection
  goalsSet          Boolean @default(false) // Step 6: Business goals
  paymentStepDone   Boolean @default(false) // Step 7: Payment/trial setup
  tourStarted       Boolean @default(false) // Step 8: Guided tour

  // Wizard state
  currentStep Int     @default(0)
  skippedSteps String[] @default([]) // Steps user skipped

  // Goals selected during onboarding
  selectedGoals String[] @default([])

  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ============================================================================
// LOCATIONS & PROPERTY DETAILS
// ============================================================================

model Location {
  id             String @id @default(cuid())
  organizationId String

  // Google Places data
  placeId          String? // Google Place ID for caching
  formattedAddress String
  streetAddress    String?
  city             String?
  state            String?
  postalCode       String?
  country          String  @default("US")

  // Coordinates
  latitude  Float
  longitude Float

  // Metadata
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orgHomeBase     Organization[]   @relation("OrgHomeBase")
  userHomeBase    User[]           @relation("UserHomeBase")
  bookings        Booking[]
  projects        Project[]
  propertyDetails PropertyDetails?

  @@index([organizationId])
  @@index([placeId])
}

model PropertyDetails {
  id         String @id @default(cuid())
  locationId String @unique

  // Property data
  propertyType PropertyType?
  bedrooms     Int?
  bathrooms    Float? // 2.5 baths, etc.
  squareFeet   Int?
  lotSize      Int? // in sqft
  yearBuilt    Int?
  listingPrice Int? // in cents

  // MLS data
  mlsNumber         String?
  listingAgent      String?
  listingAgentPhone String?

  // Metadata
  dataSource String? // "attom", "zillow", "manual"
  fetchedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([mlsNumber])
}

// ============================================================================
// EQUIPMENT & TEAM CAPABILITIES
// ============================================================================

model Equipment {
  id             String            @id @default(cuid())
  organizationId String
  name           String
  category       EquipmentCategory
  description    String?
  serialNumber   String?
  purchaseDate   DateTime?
  valueCents     Int? // Equipment value in cents

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization        Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAssignments     UserEquipment[]
  serviceRequirements ServiceEquipmentRequirement[]

  @@index([organizationId])
  @@index([category])
}

model UserEquipment {
  id          String   @id @default(cuid())
  userId      String
  equipmentId String
  assignedAt  DateTime @default(now())
  notes       String?

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([userId, equipmentId])
  @@index([userId])
  @@index([equipmentId])
}

model UserServiceCapability {
  id        String          @id @default(cuid())
  userId    String
  serviceId String
  level     CapabilityLevel @default(capable)
  notes     String?

  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceId])
  @@index([userId])
  @@index([serviceId])
  @@index([level])
}

model ServiceEquipmentRequirement {
  id          String  @id @default(cuid())
  serviceId   String
  equipmentId String
  isRequired  Boolean @default(true) // vs. recommended

  // Relations
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([serviceId, equipmentId])
  @@index([serviceId])
  @@index([equipmentId])
}

// ============================================================================
// PROPERTY WEBSITES (Phase 2)
// ============================================================================

model PropertyWebsite {
  id        String @id @default(cuid())
  projectId String @unique

  // Property Info
  address      String
  city         String
  state        String
  zipCode      String
  price        Int? // in cents
  beds         Int?
  baths        Float?
  sqft         Int?
  lotSize      String?
  yearBuilt    Int?
  propertyType PropertyType?

  // Content
  headline       String?
  description    String?  @db.Text
  features       String[] // Array of feature highlights
  virtualTourUrl String? // Matterport, iGuide, etc.
  videoUrl       String?

  // Settings
  template     PropertyWebsiteTemplate @default(modern)
  isPublished  Boolean                 @default(false)
  isBranded    Boolean                 @default(true) // Show photographer branding
  showPrice    Boolean                 @default(true)
  showAgent    Boolean                 @default(true)
  customDomain String?                 @unique

  // SEO
  slug            String  @unique
  metaTitle       String?
  metaDescription String?

  // Analytics (denormalized for quick access)
  viewCount Int @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics       PropertyAnalytics[]
  marketingAssets MarketingAsset[]
  leads           PropertyLead[]
  tasks           Task[]

  @@index([slug])
  @@index([isPublished])
}

model PropertyAnalytics {
  id                String   @id @default(cuid())
  propertyWebsiteId String
  date              DateTime @default(now()) @db.Date

  // Traffic
  pageViews      Int  @default(0)
  uniqueVisitors Int  @default(0)
  avgTimeOnPage  Int? // seconds

  // Engagement
  tourClicks   Int @default(0)
  photoViews   Int @default(0)
  socialShares Int @default(0)

  // Traffic sources
  directTraffic Int @default(0)
  socialTraffic Int @default(0)
  emailTraffic  Int @default(0)
  searchTraffic Int @default(0)

  // Device breakdown
  mobileViews  Int @default(0)
  desktopViews Int @default(0)
  tabletViews  Int @default(0)

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@unique([propertyWebsiteId, date])
  @@index([propertyWebsiteId])
  @@index([date])
}

model PropertyLead {
  id                String @id @default(cuid())
  propertyWebsiteId String

  // Lead info
  name    String
  email   String
  phone   String?
  message String? @db.Text
  source  String? // website, social, email, etc.

  // Status
  status LeadStatus @default(new)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([status])
  @@index([createdAt])
}

model MarketingAsset {
  id                String @id @default(cuid())
  propertyWebsiteId String

  // Asset info
  type         MarketingAssetType
  name         String
  fileUrl      String
  thumbnailUrl String?

  // Generation metadata
  templateUsed String?
  settings     Json? // Custom settings used to generate

  createdAt DateTime @default(now())

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([type])
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

model TaskBoard {
  id             String @id @default(cuid())
  organizationId String

  name        String
  description String?
  color       String? // Board color for visual distinction
  icon        String? // Icon name (emoji or icon key)
  isDefault   Boolean @default(false) // Default board for org
  isArchived  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  columns      TaskColumn[]
  tasks        Task[]

  @@index([organizationId])
  @@index([isArchived])
}

model TaskColumn {
  id      String @id @default(cuid())
  boardId String

  name     String
  color    String? // Column header color
  position Int     @default(0) // Sort order
  limit    Int?    // WIP limit (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  board TaskBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([boardId])
  @@index([position])
}

model Task {
  id             String @id @default(cuid())
  organizationId String
  boardId        String
  columnId       String
  assigneeId     String? // Assigned team member (User id)

  // Core task fields
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  position    Int          @default(0) // Sort order within column

  // Dates
  startDate DateTime?
  dueDate   DateTime?
  completedAt DateTime?

  // Time tracking (in minutes)
  estimatedMinutes Int?
  actualMinutes    Int?

  // Tags/labels
  tags String[] @default([])

  // Linked entities (optional - task can link to any of these)
  clientId          String?
  projectId         String? // Gallery/Project
  bookingId         String?
  invoiceId         String?
  propertyWebsiteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  board           TaskBoard        @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column          TaskColumn       @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignee        User?            @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  client          Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project         Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  booking         Booking?         @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  invoice         Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  propertyWebsite PropertyWebsite? @relation(fields: [propertyWebsiteId], references: [id], onDelete: SetNull)
  subtasks        TaskSubtask[]
  comments        TaskComment[]

  @@index([organizationId])
  @@index([boardId])
  @@index([columnId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([clientId])
  @@index([projectId])
  @@index([bookingId])
}

model TaskSubtask {
  id     String @id @default(cuid())
  taskId String

  title       String
  isCompleted Boolean @default(false)
  position    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskComment {
  id       String @id @default(cuid())
  taskId   String
  authorId String

  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}
