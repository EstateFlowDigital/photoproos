// PhotoProOS - The Business OS for Professional Photographers
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum PlanName {
  free
  pro
  studio
  enterprise
}

enum ProjectStatus {
  draft
  pending
  delivered
  archived
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
  overdue
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
}

enum InvoiceStatus {
  draft
  sent
  paid
  overdue
  cancelled
}

enum ContractStatus {
  draft
  sent
  signed
  expired
  cancelled
}

enum ClientIndustry {
  real_estate
  wedding
  portrait
  commercial
  architecture
  food_hospitality
  events
  headshots
  product
  other
}

enum ActivityType {
  gallery_created
  gallery_delivered
  gallery_viewed
  gallery_paid
  payment_received
  payment_failed
  client_added
  booking_created
  booking_confirmed
  invoice_sent
  invoice_paid
  contract_sent
  contract_signed
  email_sent
  file_uploaded
  file_downloaded
  settings_updated
  order_created
  order_paid
}

enum NotificationType {
  payment_received
  gallery_viewed
  contract_signed
  booking_confirmed
  invoice_overdue
  system
}

enum TaskStatus {
  todo
  in_progress
  in_review
  blocked
  completed
  archived
}

enum TaskPriority {
  urgent
  high
  medium
  low
}

enum MemberRole {
  owner
  admin
  member
}

enum PortalMode {
  light
  dark
  auto // Follow system preference
}

enum ServiceCategory {
  real_estate
  portrait
  event
  commercial
  wedding
  product
  other
}

enum PropertyType {
  single_family
  condo
  townhouse
  multi_family
  land
  commercial
  other
}

enum EquipmentCategory {
  camera
  lens
  lighting
  drone
  tripod
  audio
  stabilizer
  backdrop
  other
}

enum CapabilityLevel {
  learning
  capable
  expert
}

enum LeadStatus {
  new
  contacted
  qualified
  closed
}

enum MarketingAssetType {
  flyer_portrait
  flyer_landscape
  social_square
  social_story
  postcard
  email_banner
  video_slideshow
}

enum WatermarkPosition {
  top_left
  top_center
  top_right
  center
  bottom_left
  bottom_center
  bottom_right
  tiled
  diagonal
}

enum DiscountType {
  percentage
  fixed_amount
}

enum PaymentPlanStatus {
  active
  completed
  cancelled
  overdue
}

enum DownloadFormat {
  original
  web_size
  high_res
  zip_all
}

enum PropertyWebsiteTemplate {
  modern
  classic
  luxury
  minimal
  commercial
}

enum LineItemType {
  service
  travel
  custom
  discount
  tax
}

enum BusinessType {
  solo
  team
  agency
}

enum DisplayMode {
  personal
  company
}

enum Industry {
  real_estate
  commercial
  events
  portraits
  food
  product
}

// Phase 1: New Enums
enum AvailabilityBlockType {
  time_off
  holiday
  personal
  maintenance
  other
}

enum TimeOffRequestStatus {
  pending
  approved
  rejected
}

enum CommunicationType {
  email
  call
  meeting
  note
  sms
}

enum CommunicationDirection {
  inbound
  outbound
  internal
}

enum SignatureType {
  drawn
  typed
  uploaded
}

enum RecurrencePattern {
  daily
  weekly
  biweekly
  monthly
  custom
}

enum CalendarProvider {
  google
  outlook
  apple
}

enum SyncDirection {
  import_only
  export_only
  both
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Organization {
  id                  String   @id @default(cuid())
  clerkOrganizationId String?  @unique
  name                String
  slug                String   @unique
  plan                PlanName @default(free)

  // Stripe
  stripeCustomerId       String? @unique
  stripeSubscriptionId   String?
  stripeConnectAccountId String?
  stripeConnectOnboarded Boolean @default(false)

  // Branding
  logoUrl        String?
  logoLightUrl   String? // Logo variant for light backgrounds
  faviconUrl     String?
  primaryColor   String? @default("#3b82f6")
  secondaryColor String? @default("#8b5cf6")
  accentColor    String? @default("#22c55e")
  customDomain   String? @unique

  // Portal Appearance (free features)
  portalMode     PortalMode @default(dark) // light or dark mode for client-facing pages
  invoiceLogoUrl String? // Separate logo for invoices (optional)

  // White-Label Options (paid plans only)
  hidePlatformBranding Boolean @default(false) // Hide "Powered by PhotoProOS"
  customEmailDomain    String? // For white-label email sending

  // Watermark Configuration
  watermarkEnabled  Boolean           @default(true)
  watermarkType     String?           @default("text") // "text" or "image"
  watermarkText     String? // Custom text (e.g., "Â© Studio Name")
  watermarkImageUrl String? // URL to watermark image
  watermarkPosition WatermarkPosition @default(bottom_right)
  watermarkOpacity  Float             @default(0.5) // 0-1
  watermarkScale    Float             @default(0.15) // Size relative to image (0-1)

  // Settings
  timezone String @default("America/New_York")
  currency String @default("USD")

  // Tax settings
  defaultTaxRate Float?  @default(0) // Default tax rate as percentage (e.g., 8.25 for 8.25%)
  taxLabel       String? @default("Sales Tax") // Label shown on invoices (e.g., "Sales Tax", "VAT", "GST")

  // Travel fee settings
  homeBaseLocationId String?
  travelFeePerMile   Int?    @default(0) // in cents (e.g., 65 = $0.65/mile)
  travelFeeThreshold Float?  @default(0) // free miles before charging

  // ============================================================================
  // ONBOARDING & INDUSTRY SETTINGS
  // ============================================================================

  // Onboarding State
  onboardingCompleted   Boolean   @default(false)
  onboardingStep        Int       @default(0)
  onboardingCompletedAt DateTime?

  // Industry Selection (array of industry IDs)
  industries      Industry[] @default([real_estate])
  primaryIndustry Industry   @default(real_estate)

  // Enabled Modules/Features (array of module IDs like "galleries", "scheduling", etc.)
  enabledModules String[] @default([])

  // Business Profile (collected during onboarding)
  businessType    BusinessType?
  teamSize        String? // "1", "2-5", "6-10", "11-25", "25+"
  yearsInBusiness String? // "<1", "1-3", "3-5", "5-10", "10+"
  annualRevenue   String? // "<50k", "50-100k", "100-250k", "250k+"

  // Display Preferences (personal vs company branding)
  displayMode DisplayMode @default(company)
  publicName  String? // What clients see (company or personal name)
  publicEmail String? // Public-facing email
  publicPhone String? // Public-facing phone
  website     String? // Company website

  // Stripe Trial/Payment
  trialStartedAt     DateTime?
  trialEndsAt        DateTime?
  paymentMethodAdded Boolean   @default(false)

  // Guided Tour Progress (JSON: { "dashboard": true, "galleries": false, ... })
  tourProgress Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members            OrganizationMember[]
  projects           Project[]
  clients            Client[]
  payments           Payment[]
  bookings           Booking[]
  bookingTypes       BookingType[]
  invoices           Invoice[]
  contracts          Contract[]
  contractTemplates  ContractTemplate[]
  activityLogs       ActivityLog[]
  notifications      Notification[]
  usageMeters        UsageMeter[]
  onboardingProgress OnboardingProgress?
  services           Service[]
  locations          Location[]
  equipment          Equipment[]
  homeBaseLocation   Location?            @relation("OrgHomeBase", fields: [homeBaseLocationId], references: [id])
  taskBoards         TaskBoard[]
  tasks              Task[]
  discountCodes      DiscountCode[]
  paymentPlans       PaymentPlan[]
  invoiceTemplates   InvoiceTemplate[]

  // Phase 1: Ordering System relations
  serviceBundles ServiceBundle[]
  serviceAddons  ServiceAddon[]
  orderPages     OrderPage[]
  orders         Order[]

  // Phase 2: Brokerage & Enterprise relations
  brokerages    Brokerage[]
  payoutBatches PayoutBatch[]

  @@index([slug])
  @@index([plan])
}

model User {
  id          String  @id @default(cuid())
  clerkUserId String  @unique
  email       String  @unique
  fullName    String?
  avatarUrl   String?
  phone       String?

  // Personal info (collected during onboarding)
  firstName String?
  lastName  String?

  // Onboarding preferences
  hasSeenWelcome       Boolean  @default(false)
  tourCompletedModules String[] @default([])

  // Home base location (overrides org default for travel calculations)
  homeBaseLocationId String?

  // Phase 2: Stripe Connect for photographer payouts
  stripeConnectAccountId String? @unique
  stripeConnectOnboarded Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships         OrganizationMember[]
  activityLogs        ActivityLog[]
  serviceCapabilities UserServiceCapability[]
  equipment           UserEquipment[]
  assignedBookings    Booking[]               @relation("AssignedBookings")
  homeBaseLocation    Location?               @relation("UserHomeBase", fields: [homeBaseLocationId], references: [id])
  assignedTasks       Task[]
  taskComments        TaskComment[]

  @@index([email])
  @@index([clerkUserId])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(member)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

// ============================================================================
// CLIENTS
// ============================================================================

model Client {
  id             String         @id @default(cuid())
  organizationId String
  email          String
  fullName       String?
  company        String?
  phone          String?
  address        String?
  industry       ClientIndustry @default(other)
  notes          String?

  // Metrics
  lifetimeRevenueCents Int @default(0)
  totalProjects        Int @default(0)

  // Portal access
  portalAccessToken String?   @unique
  lastPortalAccess  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // CRM Enhancements (Phase 1)
  source         String? // How client found you: REFERRAL, ORGANIC, AD, REPEAT
  preferences    Json? // Client style/delivery preferences
  isVIP          Boolean   @default(false)
  lastActivityAt DateTime?

  // Phase 2: Brokerage relationship (client is an agent under a brokerage)
  brokerageId String?

  // Relations
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brokerage      Brokerage?            @relation("BrokerageAgents", fields: [brokerageId], references: [id], onDelete: SetNull)
  projects       Project[]
  bookings       Booking[]
  invoices       Invoice[]
  contracts      Contract[]
  payments       Payment[]
  clientSessions ClientSession[]
  tasks          Task[]
  communications ClientCommunication[]
  tags           ClientTagAssignment[]

  // Phase 1: Ordering System relations
  orderPages OrderPage[] // Dedicated order pages for this client
  orders     Order[] // Orders placed by this client

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([industry])
  @@index([brokerageId])
}

model ClientSession {
  id        String   @id @default(cuid())
  clientId  String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([token])
}

// ============================================================================
// SERVICES
// ============================================================================

model Service {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  category       ServiceCategory @default(other)
  description    String?
  priceCents     Int             @default(0)
  duration       String? // e.g., "2-3 hours"
  deliverables   String[] // Array of included items
  isActive       Boolean         @default(true)
  isDefault      Boolean         @default(false) // System-provided template
  sortOrder      Int             @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization          Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects              Project[] // Galleries using this service (deprecated - use projectServices)
  projectServices       ProjectService[] // Many-to-many: galleries using this service
  bookings              Booking[] // Bookings using this service
  userCapabilities      UserServiceCapability[] // Team members who can perform this service
  equipmentRequirements ServiceEquipmentRequirement[] // Equipment required for this service

  // Phase 1: Ordering System relations
  bundleItems        ServiceBundleItem[] // Bundles this service is part of
  addonCompatibility ServiceAddonCompat[] // Addons compatible with this service
  orderPageServices  OrderPageService[] // Order pages featuring this service
  orderItems         OrderItem[] // Order items referencing this service

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([isDefault])
}

// ============================================================================
// GALLERIES / PROJECTS
// ============================================================================

model Project {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String?
  serviceId      String?
  locationId     String?
  name           String
  description    String?
  status         ProjectStatus @default(draft)

  // Pricing
  priceCents Int    @default(0)
  currency   String @default("USD")

  // Gallery Settings
  coverImageUrl  String?
  password       String?
  expiresAt      DateTime?
  allowDownloads Boolean   @default(true)
  showWatermark  Boolean   @default(false)

  // Delivery
  deliveredAt   DateTime?
  viewCount     Int       @default(0)
  downloadCount Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client          Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  service         Service?          @relation(fields: [serviceId], references: [id], onDelete: SetNull) // Deprecated - use services
  location        Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  services        ProjectService[] // Many-to-many: services for this gallery
  assets          Asset[]
  deliveryLinks   DeliveryLink[]
  payments        Payment[]
  favorites       GalleryFavorite[]
  comments        GalleryComment[]
  propertyWebsite PropertyWebsite?
  tasks           Task[]

  @@index([organizationId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([status])
  @@index([createdAt])
}

// Junction table for many-to-many Project-Service relationship
model ProjectService {
  id                 String   @id @default(cuid())
  projectId          String
  serviceId          String
  isPrimary          Boolean  @default(false) // Mark the primary service if needed
  priceCentsOverride Int? // Override the service price for this specific project
  createdAt          DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([projectId, serviceId])
  @@index([projectId])
  @@index([serviceId])
}

model Asset {
  id        String @id @default(cuid())
  projectId String

  // File info
  filename       String
  originalUrl    String
  thumbnailUrl   String?
  mediumUrl      String?
  watermarkedUrl String?

  // Metadata
  mimeType  String
  sizeBytes Int
  width     Int?
  height    Int?

  // EXIF data
  exifData Json?

  // Ordering
  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project   Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  favorites GalleryFavorite[]
  comments  GalleryComment[]

  @@index([projectId])
  @@index([sortOrder])
}

model DeliveryLink {
  id        String @id @default(cuid())
  projectId String
  slug      String @unique

  // Settings
  password  String?
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  // Analytics
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([slug])
}

model GalleryFavorite {
  id          String  @id @default(cuid())
  projectId   String
  assetId     String
  clientEmail String?
  sessionId   String?

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([projectId, assetId, clientEmail])
  @@index([projectId])
  @@index([assetId])
}

model GalleryComment {
  id          String  @id @default(cuid())
  projectId   String
  assetId     String? // Optional - if set, this is a per-photo comment; if null, it's a gallery-level comment
  clientEmail String?
  clientName  String?
  content     String
  sessionId   String? // Session ID for secure comment ownership verification

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset?  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([assetId])
  @@index([sessionId])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String?
  invoiceId      String?
  clientId       String?

  // Amount
  amountCents Int
  currency    String        @default("USD")
  status      PaymentStatus @default(pending)

  // Stripe
  stripePaymentIntentId   String? @unique
  stripeCheckoutSessionId String? @unique
  stripeChargeId          String?

  // Client info
  clientEmail String?
  clientName  String?

  // Metadata
  description String?
  receiptUrl  String?

  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  invoice      Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// BOOKINGS
// ============================================================================

model BookingType {
  id              String  @id @default(cuid())
  organizationId  String
  name            String
  description     String?
  durationMinutes Int     @default(60)
  priceCents      Int     @default(0)
  color           String  @default("#3b82f6")
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings     Booking[]

  @@index([organizationId])
}

model Booking {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  bookingTypeId  String?
  serviceId      String?
  locationId     String?
  assignedUserId String?

  // Details
  title       String
  description String?
  status      BookingStatus @default(pending)

  // Time
  startTime DateTime
  endTime   DateTime
  timezone  String   @default("America/New_York")

  // Client info (for non-registered clients)
  clientName  String?
  clientEmail String?
  clientPhone String?

  // Location (legacy field kept for backwards compatibility)
  location      String?
  locationNotes String?
  isVirtual     Boolean @default(false)
  meetingUrl    String?

  // Travel calculations (cached from Distance Matrix API)
  distanceMiles     Float?
  travelTimeMinutes Int?
  travelFeeCents    Int?   @default(0)

  // Weather data (cached for performance)
  weatherCache    Json?
  weatherCachedAt DateTime?

  // Notes
  notes         String?
  internalNotes String?

  // Recurring booking fields
  isRecurring         Boolean            @default(false)
  recurrencePattern   RecurrencePattern?
  recurrenceInterval  Int?               @default(1) // e.g., every 2 weeks
  recurrenceEndDate   DateTime?          // Optional end date for the series
  recurrenceCount     Int?               // Optional max occurrences
  recurrenceDaysOfWeek Int[]             @default([]) // For weekly: 0=Sun, 1=Mon, etc.
  seriesId            String?            // Groups all bookings in a series
  parentBookingId     String?            // Reference to the original booking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client           Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  bookingType      BookingType?      @relation(fields: [bookingTypeId], references: [id], onDelete: SetNull)
  service          Service?          @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  locationRef      Location?         @relation(fields: [locationId], references: [id], onDelete: SetNull)
  assignedUser     User?             @relation("AssignedBookings", fields: [assignedUserId], references: [id], onDelete: SetNull)
  reminders        BookingReminder[]
  invoiceLineItems InvoiceLineItem[]
  tasks            Task[]

  // Phase 1: Ordering System relations
  orderId String? @unique
  order   Order?  @relation("OrderBooking", fields: [orderId], references: [id], onDelete: SetNull)

  // Recurring booking self-reference
  parentBooking  Booking?  @relation("RecurringBookings", fields: [parentBookingId], references: [id], onDelete: SetNull)
  childBookings  Booking[] @relation("RecurringBookings")

  @@index([organizationId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([assignedUserId])
  @@index([startTime])
  @@index([status])
  @@index([seriesId])
  @@index([parentBookingId])
}

model BookingReminder {
  id        String    @id @default(cuid())
  bookingId String
  sendAt    DateTime
  sent      Boolean   @default(false)
  sentAt    DateTime?

  createdAt DateTime @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([sendAt])
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  invoiceNumber  String

  // Status
  status InvoiceStatus @default(draft)

  // Amounts
  subtotalCents Int    @default(0)
  taxCents      Int    @default(0)
  discountCents Int    @default(0)
  totalCents    Int    @default(0)
  currency      String @default("USD")

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidAt    DateTime?

  // Client info
  clientName    String?
  clientEmail   String?
  clientAddress String?

  // Notes
  notes String?
  terms String?

  // Payment link
  stripePaymentLinkId String?
  paymentLinkUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  lineItems    InvoiceLineItem[]
  payments     Payment[]
  tasks        Task[]

  // Phase 1: Ordering System relations
  orderId String? @unique
  order   Order?  @relation("OrderInvoice", fields: [orderId], references: [id], onDelete: SetNull)

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceLineItem {
  id          String       @id @default(cuid())
  invoiceId   String
  bookingId   String? // Link to booking for travel fees
  itemType    LineItemType @default(service)
  description String
  quantity    Int          @default(1)
  unitCents   Int
  totalCents  Int
  sortOrder   Int          @default(0)

  createdAt DateTime @default(now())

  // Relations
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([bookingId])
  @@index([itemType])
}

// ============================================================================
// CONTRACTS
// ============================================================================

model ContractTemplate {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  description    String?
  content        String  @db.Text
  isDefault      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contracts    Contract[]

  @@index([organizationId])
}

model Contract {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  templateId     String?

  // Details
  name    String
  content String         @db.Text
  status  ContractStatus @default(draft)

  // Metadata
  pdfUrl String?

  // Dates
  sentAt    DateTime?
  signedAt  DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?             @relation(fields: [clientId], references: [id], onDelete: SetNull)
  template     ContractTemplate?   @relation(fields: [templateId], references: [id], onDelete: SetNull)
  signers      ContractSigner[]
  auditLogs    ContractAuditLog[]
  signatures   ContractSignature[]

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
}

model ContractSigner {
  id         String  @id @default(cuid())
  contractId String
  email      String
  name       String?

  // Signing
  signatureUrl    String?
  signedAt        DateTime?
  signedIp        String?
  signedUserAgent String?

  // Token for signing
  signingToken   String    @unique
  tokenExpiresAt DateTime?

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([signingToken])
}

model ContractAuditLog {
  id         String  @id @default(cuid())
  contractId String
  action     String
  actorEmail String?
  actorIp    String?
  metadata   Json?

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([createdAt])
}

// ============================================================================
// ACTIVITY & NOTIFICATIONS
// ============================================================================

model ActivityLog {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?
  type           ActivityType
  description    String
  metadata       Json?

  // Related entities
  projectId  String?
  clientId   String?
  paymentId  String?
  bookingId  String?
  invoiceId  String?
  contractId String?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Notification {
  id             String           @id @default(cuid())
  organizationId String
  type           NotificationType
  title          String
  message        String
  linkUrl        String?
  read           Boolean          @default(false)
  readAt         DateTime?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([read])
  @@index([createdAt])
}

// ============================================================================
// USAGE & METERING
// ============================================================================

model UsageMeter {
  id             String @id @default(cuid())
  organizationId String
  month          String // "2025-01" format

  // Usage counts
  storageBytes     BigInt @default(0)
  galleriesCreated Int    @default(0)
  emailsSent       Int    @default(0)
  apiCalls         Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, month])
  @@index([organizationId])
  @@index([month])
}

model OnboardingProgress {
  id             String @id @default(cuid())
  organizationId String @unique

  // Legacy steps (kept for backwards compatibility)
  profileComplete     Boolean @default(false)
  brandingComplete    Boolean @default(false)
  firstGalleryCreated Boolean @default(false)
  stripeConnected     Boolean @default(false)

  // New Onboarding Wizard Steps
  welcomeViewed    Boolean @default(false) // Step 0
  personalComplete Boolean @default(false) // Step 1: First/last name
  businessComplete Boolean @default(false) // Step 2: Company, type, size
  brandingStepDone Boolean @default(false) // Step 3: Display mode, public info
  industriesSet    Boolean @default(false) // Step 4: Industry selection
  featuresSelected Boolean @default(false) // Step 5: Module selection
  goalsSet         Boolean @default(false) // Step 6: Business goals
  paymentStepDone  Boolean @default(false) // Step 7: Payment/trial setup
  tourStarted      Boolean @default(false) // Step 8: Guided tour

  // Wizard state
  currentStep  Int      @default(0)
  skippedSteps String[] @default([]) // Steps user skipped

  // Goals selected during onboarding
  selectedGoals String[] @default([])

  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ============================================================================
// LOCATIONS & PROPERTY DETAILS
// ============================================================================

model Location {
  id             String @id @default(cuid())
  organizationId String

  // Google Places data
  placeId          String? // Google Place ID for caching
  formattedAddress String
  streetAddress    String?
  city             String?
  state            String?
  postalCode       String?
  country          String  @default("US")

  // Coordinates
  latitude  Float
  longitude Float

  // Metadata
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orgHomeBase     Organization[]   @relation("OrgHomeBase")
  userHomeBase    User[]           @relation("UserHomeBase")
  bookings        Booking[]
  projects        Project[]
  propertyDetails PropertyDetails?

  // Phase 1: Ordering System relations
  orders Order[]

  @@index([organizationId])
  @@index([placeId])
}

model PropertyDetails {
  id         String @id @default(cuid())
  locationId String @unique

  // Property data
  propertyType PropertyType?
  bedrooms     Int?
  bathrooms    Float? // 2.5 baths, etc.
  squareFeet   Int?
  lotSize      Int? // in sqft
  yearBuilt    Int?
  listingPrice Int? // in cents

  // MLS data
  mlsNumber         String?
  listingAgent      String?
  listingAgentPhone String?

  // Metadata
  dataSource String? // "attom", "zillow", "manual"
  fetchedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([mlsNumber])
}

// ============================================================================
// EQUIPMENT & TEAM CAPABILITIES
// ============================================================================

model Equipment {
  id             String            @id @default(cuid())
  organizationId String
  name           String
  category       EquipmentCategory
  description    String?
  serialNumber   String?
  purchaseDate   DateTime?
  valueCents     Int? // Equipment value in cents

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization        Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAssignments     UserEquipment[]
  serviceRequirements ServiceEquipmentRequirement[]

  @@index([organizationId])
  @@index([category])
}

model UserEquipment {
  id          String   @id @default(cuid())
  userId      String
  equipmentId String
  assignedAt  DateTime @default(now())
  notes       String?

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([userId, equipmentId])
  @@index([userId])
  @@index([equipmentId])
}

model UserServiceCapability {
  id        String          @id @default(cuid())
  userId    String
  serviceId String
  level     CapabilityLevel @default(capable)
  notes     String?

  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceId])
  @@index([userId])
  @@index([serviceId])
  @@index([level])
}

model ServiceEquipmentRequirement {
  id          String  @id @default(cuid())
  serviceId   String
  equipmentId String
  isRequired  Boolean @default(true) // vs. recommended

  // Relations
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([serviceId, equipmentId])
  @@index([serviceId])
  @@index([equipmentId])
}

// ============================================================================
// PROPERTY WEBSITES (Phase 2)
// ============================================================================

model PropertyWebsite {
  id        String @id @default(cuid())
  projectId String @unique

  // Property Info
  address      String
  city         String
  state        String
  zipCode      String
  price        Int? // in cents
  beds         Int?
  baths        Float?
  sqft         Int?
  lotSize      String?
  yearBuilt    Int?
  propertyType PropertyType?

  // Content
  headline       String?
  description    String?  @db.Text
  features       String[] // Array of feature highlights
  virtualTourUrl String? // Matterport, iGuide, etc.
  videoUrl       String?

  // Settings
  template     PropertyWebsiteTemplate @default(modern)
  isPublished  Boolean                 @default(false)
  isBranded    Boolean                 @default(true) // Show photographer branding
  showPrice    Boolean                 @default(true)
  showAgent    Boolean                 @default(true)
  customDomain String?                 @unique

  // SEO
  slug            String  @unique
  metaTitle       String?
  metaDescription String?

  // Analytics (denormalized for quick access)
  viewCount Int @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  project         Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics       PropertyAnalytics[]
  marketingAssets MarketingAsset[]
  leads           PropertyLead[]
  tasks           Task[]

  @@index([slug])
  @@index([isPublished])
}

model PropertyAnalytics {
  id                String   @id @default(cuid())
  propertyWebsiteId String
  date              DateTime @default(now()) @db.Date

  // Traffic
  pageViews      Int  @default(0)
  uniqueVisitors Int  @default(0)
  avgTimeOnPage  Int? // seconds

  // Engagement
  tourClicks   Int @default(0)
  photoViews   Int @default(0)
  socialShares Int @default(0)

  // Traffic sources
  directTraffic Int @default(0)
  socialTraffic Int @default(0)
  emailTraffic  Int @default(0)
  searchTraffic Int @default(0)

  // Device breakdown
  mobileViews  Int @default(0)
  desktopViews Int @default(0)
  tabletViews  Int @default(0)

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@unique([propertyWebsiteId, date])
  @@index([propertyWebsiteId])
  @@index([date])
}

model PropertyLead {
  id                String @id @default(cuid())
  propertyWebsiteId String

  // Lead info
  name    String
  email   String
  phone   String?
  message String? @db.Text
  source  String? // website, social, email, etc.

  // Status
  status LeadStatus @default(new)

  // Lead Scoring
  score          Int    @default(0) // 0-100 score
  scoreBreakdown Json? // { "pageViews": 10, "timeOnSite": 15, "photoViews": 20, ... }
  temperature    String @default("cold") // "hot", "warm", "cold"

  // Engagement tracking
  pageViews        Int       @default(0)
  photoViews       Int       @default(0)
  tourClicks       Int       @default(0)
  totalTimeSeconds Int       @default(0)
  lastActivityAt   DateTime?

  // Contact history
  contactedAt  DateTime?
  followUpDate DateTime?
  notes        String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([status])
  @@index([score])
  @@index([temperature])
  @@index([createdAt])
}

model MarketingAsset {
  id                String @id @default(cuid())
  propertyWebsiteId String

  // Asset info
  type         MarketingAssetType
  name         String
  fileUrl      String
  thumbnailUrl String?

  // Generation metadata
  templateUsed String?
  settings     Json? // Custom settings used to generate

  createdAt DateTime @default(now())

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([type])
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

model TaskBoard {
  id             String @id @default(cuid())
  organizationId String

  name        String
  description String?
  color       String? // Board color for visual distinction
  icon        String? // Icon name (emoji or icon key)
  isDefault   Boolean @default(false) // Default board for org
  isArchived  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  columns      TaskColumn[]
  tasks        Task[]

  @@index([organizationId])
  @@index([isArchived])
}

model TaskColumn {
  id      String @id @default(cuid())
  boardId String

  name     String
  color    String? // Column header color
  position Int     @default(0) // Sort order
  limit    Int? // WIP limit (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  board TaskBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@index([boardId])
  @@index([position])
}

model Task {
  id             String  @id @default(cuid())
  organizationId String
  boardId        String
  columnId       String
  assigneeId     String? // Assigned team member (User id)

  // Core task fields
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  position    Int          @default(0) // Sort order within column

  // Dates
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  // Time tracking (in minutes)
  estimatedMinutes Int?
  actualMinutes    Int?

  // Tags/labels
  tags String[] @default([])

  // Linked entities (optional - task can link to any of these)
  clientId          String?
  projectId         String? // Gallery/Project
  bookingId         String?
  invoiceId         String?
  propertyWebsiteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  board           TaskBoard        @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column          TaskColumn       @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignee        User?            @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  client          Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project         Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  booking         Booking?         @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  invoice         Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  propertyWebsite PropertyWebsite? @relation(fields: [propertyWebsiteId], references: [id], onDelete: SetNull)
  subtasks        TaskSubtask[]
  comments        TaskComment[]

  @@index([organizationId])
  @@index([boardId])
  @@index([columnId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([clientId])
  @@index([projectId])
  @@index([bookingId])
}

model TaskSubtask {
  id     String @id @default(cuid())
  taskId String

  title       String
  isCompleted Boolean @default(false)
  position    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskComment {
  id       String @id @default(cuid())
  taskId   String
  authorId String

  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}

// ============================================================================
// DISCOUNT CODES
// ============================================================================

model DiscountCode {
  id             String       @id @default(cuid())
  organizationId String
  code           String // The actual code (e.g., "SUMMER20")
  description    String? // Internal description
  discountType   DiscountType @default(percentage)
  discountValue  Int // Percentage (0-100) or cents for fixed_amount

  // Limits
  maxUses     Int? @default(0) // 0 = unlimited
  usedCount   Int  @default(0)
  minPurchase Int? @default(0) // Minimum purchase in cents
  maxDiscount Int? // Maximum discount in cents (for percentage discounts)

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  isActive   Boolean   @default(true)

  // Scope - which things this code applies to
  applicableServices String[] @default([]) // Empty = all services
  applicableClients  String[] @default([]) // Empty = all clients

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usages       DiscountCodeUsage[]

  // Phase 1: Ordering System relations
  orders Order[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([code])
  @@index([isActive])
}

model DiscountCodeUsage {
  id             String  @id @default(cuid())
  discountCodeId String
  invoiceId      String?
  paymentId      String?
  clientEmail    String?

  discountAmount Int // Amount discounted in cents

  createdAt DateTime @default(now())

  // Relations
  discountCode DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)

  @@index([discountCodeId])
  @@index([invoiceId])
}

// ============================================================================
// PAYMENT PLANS
// ============================================================================

model PaymentPlan {
  id             String  @id @default(cuid())
  organizationId String
  invoiceId      String?
  projectId      String?
  clientId       String?

  // Plan details
  totalAmount  Int // Total amount in cents
  installments Int // Number of installments (e.g., 3, 6, 12)
  paidAmount   Int @default(0) // Amount paid so far

  status PaymentPlanStatus @default(active)

  // Schedule
  startDate   DateTime
  frequency   String    @default("monthly") // "weekly", "biweekly", "monthly"
  nextDueDate DateTime?

  // Stripe
  stripeSubscriptionId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scheduledPayments PaymentPlanInstallment[]

  @@index([organizationId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
}

model PaymentPlanInstallment {
  id            String @id @default(cuid())
  paymentPlanId String

  amount  Int // Amount in cents
  dueDate DateTime
  paidAt  DateTime?
  isPaid  Boolean   @default(false)

  // Stripe
  stripePaymentIntentId String? @unique

  // Reminders
  reminderSentAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  paymentPlan PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([isPaid])
}

// ============================================================================
// DOWNLOAD TRACKING
// ============================================================================

model DownloadLog {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String
  assetId        String? // Null for batch/zip downloads

  // Download details
  format     DownloadFormat @default(original)
  fileCount  Int            @default(1) // For batch downloads
  totalBytes BigInt?

  // Who downloaded
  clientEmail String?
  sessionId   String?
  ipAddress   String?
  userAgent   String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([projectId])
  @@index([assetId])
  @@index([clientEmail])
  @@index([createdAt])
}

// ============================================================================
// GALLERY EXPIRATION NOTIFICATIONS
// ============================================================================

model ExpirationNotification {
  id        String @id @default(cuid())
  projectId String

  // Notification schedule
  daysBeforeExpiry Int // 7, 3, 1, etc.
  sentAt           DateTime?

  // Email details
  recipientEmail String
  emailType      String @default("expiry_warning") // "expiry_warning", "expired", "extended"

  createdAt DateTime @default(now())

  @@unique([projectId, daysBeforeExpiry])
  @@index([projectId])
  @@index([sentAt])
}

// ============================================================================
// INVOICE TEMPLATES
// ============================================================================

model InvoiceTemplate {
  id             String @id @default(cuid())
  organizationId String

  name      String
  isDefault Boolean @default(false)

  // Branding
  logoPosition String @default("left") // "left", "center", "right"
  primaryColor String @default("#3b82f6")
  accentColor  String @default("#8b5cf6")

  // Content
  headerText   String?
  footerText   String?
  paymentTerms String? // e.g., "Net 30", "Due on Receipt"
  notes        String?

  // Styling
  fontFamily      String  @default("Inter")
  showLogo        Boolean @default(true)
  showPaymentLink Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// ============================================================================
// CLIENT PORTAL ACTIVITY
// ============================================================================

model PortalActivity {
  id             String @id @default(cuid())
  organizationId String
  clientId       String

  // Activity details
  activityType String // "gallery_delivered", "invoice_sent", "payment_received", "comment_posted", etc.
  title        String
  description  String?

  // Related entities
  projectId String?
  invoiceId String?
  paymentId String?

  // Read status
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([clientId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================================================
// PHASE 1: SCHEDULING & AVAILABILITY
// ============================================================================

model AvailabilityBlock {
  id             String  @id @default(cuid())
  organizationId String
  userId         String? // null = org-wide block

  // Block details
  title       String
  description String?
  blockType   AvailabilityBlockType @default(time_off)

  // Time range
  startDate DateTime
  endDate   DateTime
  allDay    Boolean  @default(true)

  // Recurrence (RRULE format)
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // e.g., "FREQ=WEEKLY;BYDAY=SU"
  recurrenceEnd  DateTime?

  // Time-off request approval workflow
  requestStatus TimeOffRequestStatus @default(approved) // Legacy blocks are auto-approved
  approvedById  String?
  approvedAt    DateTime?
  rejectionNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@index([requestStatus])
}

model BookingBuffer {
  id             String  @id @default(cuid())
  organizationId String
  serviceId      String? // null = org-wide default

  // Buffer times in minutes
  bufferBefore Int @default(0) // Setup time before booking
  bufferAfter  Int @default(0) // Teardown time after booking

  // Minimum booking window
  minAdvanceHours Int? // Minimum hours in advance to book
  maxAdvanceDays  Int? // Maximum days in advance to book

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, serviceId])
  @@index([organizationId])
  @@index([serviceId])
}

// ============================================================================
// PHASE 1: CLIENT CRM ENHANCEMENTS
// ============================================================================

model ClientCommunication {
  id       String @id @default(cuid())
  clientId String

  // Communication details
  type      CommunicationType
  direction CommunicationDirection
  subject   String?
  content   String                 @db.Text

  // Metadata
  sentAt DateTime?
  readAt DateTime?

  // Who logged this
  createdById String?

  // Related entities
  bookingId String?
  projectId String?
  invoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
  @@index([createdAt])
}

model ClientTag {
  id             String @id @default(cuid())
  organizationId String

  name        String
  color       String  @default("#6366f1")
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients ClientTagAssignment[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model ClientTagAssignment {
  id       String @id @default(cuid())
  clientId String
  tagId    String

  createdAt DateTime @default(now())

  // Relations
  client Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tag    ClientTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([clientId, tagId])
  @@index([clientId])
  @@index([tagId])
}

// ============================================================================
// PHASE 1: CONTRACT E-SIGNATURE ENHANCEMENTS
// ============================================================================

model ContractSignature {
  id         String @id @default(cuid())
  contractId String
  signerId   String // ContractSigner id

  // Signature data
  signatureData String        @db.Text // Base64 encoded signature image
  signatureType SignatureType @default(drawn)

  // Verification
  signedAt  DateTime @default(now())
  ipAddress String?
  userAgent String?

  // Legal compliance
  consentGiven Boolean @default(true)
  consentText  String? @db.Text

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([signerId])
}

// ============================================================================
// PHASE 1: CALENDAR INTEGRATIONS
// ============================================================================

model CalendarIntegration {
  id             String  @id @default(cuid())
  organizationId String
  userId         String? // User-specific or org-wide

  // Provider details
  provider   CalendarProvider
  externalId String // Calendar ID from provider
  name       String // Display name

  // OAuth tokens
  accessToken    String    @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?

  // Sync settings
  syncEnabled   Boolean       @default(true)
  syncDirection SyncDirection @default(both)
  lastSyncAt    DateTime?
  lastSyncError String?

  // Color mapping
  color String @default("#3b82f6")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, provider, externalId])
  @@index([organizationId])
  @@index([userId])
  @@index([provider])
}

model CalendarEvent {
  id                    String @id @default(cuid())
  calendarIntegrationId String

  // External reference
  externalEventId String

  // Event details (cached from provider)
  title       String
  description String?  @db.Text
  startTime   DateTime
  endTime     DateTime
  allDay      Boolean  @default(false)
  location    String?

  // Link to internal booking (if synced)
  bookingId String? @unique

  // Sync metadata
  lastSyncedAt DateTime @default(now())
  etag         String? // For change detection

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([calendarIntegrationId, externalEventId])
  @@index([calendarIntegrationId])
  @@index([bookingId])
  @@index([startTime])
}

// ============================================================================
// SPIRO FEATURE PARITY - PHASE 1: ORDERING SYSTEM & PRODUCT BUNDLES
// ============================================================================

enum OrderStatus {
  cart // Items added, not submitted
  pending // Submitted, awaiting payment
  paid // Payment received
  processing // Being worked on
  completed // Delivered
  cancelled // Cancelled by client or admin
}

enum BundleType {
  fixed // Fixed set of services
  tiered // Pick X services from a group
  custom // Build your own
}

enum AddonTrigger {
  always // Always show
  with_service // Show when specific service selected
  cart_threshold // Show when cart > X amount
}

// ============================================================================
// SERVICE BUNDLES (Package services together with bundle pricing)
// ============================================================================

model ServiceBundle {
  id             String @id @default(cuid())
  organizationId String

  // Bundle info
  name        String
  slug        String
  description String?    @db.Text
  priceCents  Int // Bundle price
  bundleType  BundleType @default(fixed)

  // Display
  imageUrl  String?
  badgeText String? // "Most Popular", "Best Value"
  sortOrder Int     @default(0)

  // Savings display
  originalPriceCents Int? // Sum of individual services (for savings display)
  savingsPercent     Float? // Calculated savings percentage

  // Settings
  isActive Boolean @default(true)
  isPublic Boolean @default(true) // Show on public order pages

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  services     ServiceBundleItem[] // Services included in bundle
  orderPages   OrderPageBundle[] // Order pages featuring this bundle
  orderItems   OrderItem[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([isActive, isPublic])
}

model ServiceBundleItem {
  id        String @id @default(cuid())
  bundleId  String
  serviceId String

  // For tiered bundles: is this required or optional?
  isRequired Boolean @default(true)
  quantity   Int     @default(1)
  sortOrder  Int     @default(0)

  // Relations
  bundle  ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  service Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([bundleId, serviceId])
  @@index([bundleId])
  @@index([serviceId])
}

// ============================================================================
// SERVICE ADDONS (Cross-sells/Upsells)
// ============================================================================

model ServiceAddon {
  id             String @id @default(cuid())
  organizationId String

  // Addon info
  name        String
  description String?
  priceCents  Int

  // Display
  imageUrl  String?
  iconName  String? // Icon identifier
  sortOrder Int     @default(0)

  // Trigger conditions
  triggerType  AddonTrigger @default(always)
  triggerValue String? // Service ID or amount threshold

  // Settings
  isActive  Boolean @default(true)
  isOneTime Boolean @default(true) // Can only add once

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  compatibleWith ServiceAddonCompat[] // Services this addon works with
  orderItems     OrderItem[]

  @@index([organizationId])
  @@index([isActive])
}

model ServiceAddonCompat {
  id        String @id @default(cuid())
  addonId   String
  serviceId String

  addon   ServiceAddon @relation(fields: [addonId], references: [id], onDelete: Cascade)
  service Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([addonId, serviceId])
  @@index([addonId])
  @@index([serviceId])
}

// ============================================================================
// ORDER PAGES (Custom branded landing pages)
// ============================================================================

model OrderPage {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String? // Optional: dedicated page for specific client
  brokerageId    String? // Optional: dedicated page for specific brokerage

  // Page info
  name String
  slug String

  // Branding overrides
  headline        String?
  subheadline     String?
  heroImageUrl    String?
  logoOverrideUrl String? // Override org logo for this page
  primaryColor    String? // Override org primary color

  // Contact info display
  showPhone   Boolean @default(true)
  showEmail   Boolean @default(true)
  customPhone String?
  customEmail String?

  // Template/Layout
  template String @default("default") // "default", "minimal", "luxury"

  // SEO
  metaTitle       String?
  metaDescription String?

  // Settings
  isPublished  Boolean @default(false)
  requireLogin Boolean @default(false) // Require client portal login

  // Testimonials/social proof
  testimonials Json? // Array of { name, company, quote, photoUrl }

  // Analytics
  viewCount  Int @default(0)
  orderCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?            @relation(fields: [clientId], references: [id], onDelete: SetNull)
  brokerage    Brokerage?         @relation("BrokerageOrderPages", fields: [brokerageId], references: [id], onDelete: SetNull)
  bundles      OrderPageBundle[]
  services     OrderPageService[]
  orders       Order[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([clientId])
  @@index([brokerageId])
  @@index([isPublished])
}

model OrderPageBundle {
  id          String  @id @default(cuid())
  orderPageId String
  bundleId    String
  sortOrder   Int     @default(0)
  isFeatured  Boolean @default(false) // Highlight as recommended

  orderPage OrderPage     @relation(fields: [orderPageId], references: [id], onDelete: Cascade)
  bundle    ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@unique([orderPageId, bundleId])
  @@index([orderPageId])
}

model OrderPageService {
  id          String @id @default(cuid())
  orderPageId String
  serviceId   String
  sortOrder   Int    @default(0)

  orderPage OrderPage @relation(fields: [orderPageId], references: [id], onDelete: Cascade)
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([orderPageId, serviceId])
  @@index([orderPageId])
}

// ============================================================================
// ORDERS (Shopping Cart / Pre-Invoice)
// ============================================================================

model Order {
  id             String  @id @default(cuid())
  organizationId String
  orderPageId    String? // Which order page it came from
  clientId       String? // Linked client (if known)

  // Order reference
  orderNumber String // e.g., "ORD-2025-0001"
  status      OrderStatus @default(cart)

  // Totals (in cents)
  subtotalCents Int @default(0)
  discountCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  // Discount code applied
  discountCodeId String?

  // Client info (for guest checkout)
  clientName    String?
  clientEmail   String?
  clientPhone   String?
  clientCompany String?

  // Property/Shoot location
  locationId    String?
  locationNotes String?

  // Scheduling preference
  preferredDate DateTime?
  preferredTime String? // "morning", "afternoon", "evening"
  flexibleDates Boolean   @default(true)

  // Notes
  clientNotes   String? @db.Text
  internalNotes String? @db.Text

  // Session token for guest checkout
  sessionToken String? @unique

  // Payment
  paidAt        DateTime?
  paymentMethod String?

  // Stripe
  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String? @unique

  // Conversion tracking
  source   String? // utm_source
  medium   String? // utm_medium
  campaign String? // utm_campaign

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime? // When cart was submitted

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orderPage    OrderPage?    @relation(fields: [orderPageId], references: [id], onDelete: SetNull)
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  discountCode DiscountCode? @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)
  items        OrderItem[]
  invoice      Invoice?      @relation("OrderInvoice")
  booking      Booking?      @relation("OrderBooking")

  @@unique([organizationId, orderNumber])
  @@index([organizationId])
  @@index([orderPageId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String

  // Item type
  itemType  String // "service", "bundle", "addon"
  serviceId String?
  bundleId  String?
  addonId   String?

  // Details
  name        String
  description String?
  quantity    Int     @default(1)
  unitCents   Int
  totalCents  Int

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service Service?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  bundle  ServiceBundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)
  addon   ServiceAddon?  @relation(fields: [addonId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([serviceId])
  @@index([bundleId])
}

// ============================================================================
// SPIRO FEATURE PARITY - PHASE 2: BROKERAGE & ENTERPRISE FEATURES
// ============================================================================

enum PayoutStatus {
  pending // Scheduled but not processed
  processing // Being sent via Stripe
  completed // Successfully paid
  failed // Payment failed
  cancelled // Cancelled before processing
}

enum InvoiceSplitType {
  single // Standard single invoice
  split // One invoice with line items assigned to agent/brokerage
  dual // Two separate invoices generated
}

enum EarningStatus {
  pending // Booking not yet completed
  approved // Ready for payout
  paid // Included in a payout
  disputed // Under review
}

// ============================================================================
// BROKERAGES (Parent company with multiple agents)
// ============================================================================

model Brokerage {
  id             String @id @default(cuid())
  organizationId String

  // Brokerage info
  name    String
  slug    String
  email   String?
  phone   String?
  website String?

  // Address
  address String?
  city    String?
  state   String?
  zipCode String?

  // Branding
  logoUrl      String?
  primaryColor String?

  // Primary contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Settings
  isActive Boolean @default(true)

  // Analytics (denormalized)
  totalRevenueCents Int @default(0)
  activeAgentCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents       Client[]            @relation("BrokerageAgents")
  contracts    BrokerageContract[]
  orderPages   OrderPage[]         @relation("BrokerageOrderPages")

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([isActive])
}

// ============================================================================
// BROKERAGE CONTRACTS (Pricing terms and discounts per brokerage)
// ============================================================================

model BrokerageContract {
  id          String @id @default(cuid())
  brokerageId String

  // Contract details
  name        String
  description String?

  // Pricing terms
  discountPercent    Float? @default(0) // Global discount percentage
  discountFixedCents Int?   @default(0) // Fixed discount amount

  // Per-service pricing overrides (JSON: { serviceId: priceCents })
  servicePricing Json?

  // Payment terms
  paymentTermsDays Int     @default(30) // Net 30, etc.
  autoInvoice      Boolean @default(false) // Auto-create invoices

  // Invoice handling
  invoiceSplitType    InvoiceSplitType @default(single)
  brokeragePayPercent Float? // % brokerage pays (for split invoices)

  // Validity
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brokerage Brokerage @relation(fields: [brokerageId], references: [id], onDelete: Cascade)

  @@index([brokerageId])
  @@index([isActive])
}

// ============================================================================
// INVOICE SPLITS (Track split/dual invoice configuration)
// ============================================================================

model InvoiceSplit {
  id             String @id @default(cuid())
  organizationId String

  // Parent invoice
  primaryInvoiceId   String
  secondaryInvoiceId String? // For dual invoices

  // Split type
  splitType InvoiceSplitType

  // Split details
  agentAmountCents     Int @default(0)
  brokerageAmountCents Int @default(0)

  // Line item assignments (JSON: { lineItemId: "agent" | "brokerage" })
  lineItemAssignments Json?

  createdAt DateTime @default(now())

  @@unique([primaryInvoiceId])
  @@index([organizationId])
  @@index([primaryInvoiceId])
  @@index([secondaryInvoiceId])
}

// ============================================================================
// PHOTOGRAPHER RATES (Pay rates per photographer per service)
// ============================================================================

model PhotographerRate {
  id             String  @id @default(cuid())
  organizationId String
  userId         String // Photographer (team member)
  serviceId      String? // Null = default rate for all services

  // Pay structure
  rateType  String @default("percentage") // "percentage", "fixed", "hourly"
  rateValue Int // Percentage (0-100) or cents

  // Minimum/maximum
  minPayCents Int? // Minimum pay per booking
  maxPayCents Int? // Maximum pay per booking

  // Override for specific booking types
  bookingTypeId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId, serviceId])
  @@index([organizationId])
  @@index([userId])
  @@index([serviceId])
}

// ============================================================================
// PHOTOGRAPHER EARNINGS (Earnings log per booking)
// ============================================================================

model PhotographerEarning {
  id             String  @id @default(cuid())
  organizationId String
  userId         String // Photographer
  bookingId      String?
  invoiceId      String?

  // Earning details
  description String
  amountCents Int
  status      EarningStatus @default(pending)

  // Calculation source
  rateType        String? // How this was calculated
  rateValue       Int?
  baseAmountCents Int? // What the earning was calculated from

  // Payout reference
  payoutItemId String?

  // Dates
  earnedAt   DateTime  @default(now())
  approvedAt DateTime?
  paidAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payoutItem PayoutItem? @relation(fields: [payoutItemId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([payoutItemId])
}

// ============================================================================
// PAYOUT BATCHES (Scheduled payout batches)
// ============================================================================

model PayoutBatch {
  id             String @id @default(cuid())
  organizationId String

  // Batch info
  batchNumber String // e.g., "PAY-2025-0001"
  status      PayoutStatus @default(pending)

  // Period covered
  periodStart DateTime
  periodEnd   DateTime

  // Totals
  totalAmountCents Int @default(0)
  itemCount        Int @default(0)

  // Processing
  processedAt  DateTime?
  failedReason String?

  // Stripe
  stripeTransferId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        PayoutItem[]

  @@unique([organizationId, batchNumber])
  @@index([organizationId])
  @@index([status])
  @@index([periodStart])
}

model PayoutItem {
  id      String @id @default(cuid())
  batchId String
  userId  String // Recipient photographer

  // Amount
  amountCents Int
  description String?

  // Status
  status       PayoutStatus @default(pending)
  failedReason String?

  // Stripe Connect
  stripeTransferId String?
  stripePayoutId   String?

  // Dates
  processedAt DateTime?
  paidAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  batch    PayoutBatch           @relation(fields: [batchId], references: [id], onDelete: Cascade)
  earnings PhotographerEarning[]

  @@index([batchId])
  @@index([userId])
  @@index([status])
}
