// PhotoProOS - The Business OS for Professional Photographers
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// ENUMS
// ============================================================================

enum PlanName {
  free
  pro
  studio
  enterprise
}

enum ProjectStatus {
  draft
  pending
  delivered
  archived
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
  overdue
}

enum ExpenseCategory {
  labor // Contractor/photographer pay
  travel // Mileage, gas, parking
  equipment // Equipment rental, purchases
  software // Software subscriptions, editing tools
  materials // Props, staging materials
  marketing // Advertising, marketing costs
  fees // Platform fees, transaction fees
  insurance // Insurance costs
  other // Miscellaneous expenses
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
}

enum InvoiceStatus {
  draft
  sent
  partial
  paid
  overdue
  cancelled
  void
}

enum ContractStatus {
  draft
  sent
  signed
  expired
  cancelled
}

enum ClientIndustry {
  real_estate
  wedding
  portrait
  commercial
  architecture
  food_hospitality
  events
  headshots
  product
  other
}

enum ActivityType {
  gallery_created
  gallery_delivered
  gallery_viewed
  gallery_paid
  photo_viewed
  payment_received
  payment_failed
  client_added
  client_created
  client_updated
  client_merged
  booking_created
  booking_confirmed
  booking_cancelled
  invoice_created
  invoice_sent
  invoice_paid
  invoice_voided
  invoice_split
  invoice_updated
  invoice_reminder_sent
  contract_sent
  contract_signed
  email_sent
  file_uploaded
  file_downloaded
  settings_updated
  order_created
  order_paid
  selections_submitted
  message_sent
  // Estimates
  estimate_created
  estimate_updated
  estimate_sent
  estimate_approved
  estimate_rejected
  estimate_converted
  // Retainers
  retainer_created
  retainer_deposit
  retainer_usage
  retainer_refund
  retainer_updated
}

enum NotificationType {
  // Payments
  payment_received
  payment_failed
  // Galleries
  gallery_viewed
  gallery_delivered
  // Bookings
  booking_created
  booking_confirmed
  booking_cancelled
  booking_reminder
  // Contracts
  contract_sent
  contract_signed
  // Invoices
  invoice_sent
  invoice_paid
  invoice_overdue
  // Questionnaires
  questionnaire_assigned
  questionnaire_completed
  questionnaire_reminder
  // Leads & Clients
  lead_received
  client_added
  // Referrals
  referral_signup
  referral_conversion
  // Messages
  message_received
  // Automations
  task_automation
  // System
  system
}

enum TaskStatus {
  todo
  in_progress
  in_review
  blocked
  completed
  archived
}

enum TaskPriority {
  urgent
  high
  medium
  low
}

enum MemberRole {
  owner
  admin
  member
}

enum InvitationStatus {
  pending
  accepted
  expired
  revoked
}

enum PortalMode {
  light
  dark
  auto // Follow system preference
}

enum ServiceCategory {
  real_estate
  portrait
  event
  commercial
  wedding
  product
  other
}

enum PropertyType {
  single_family
  condo
  townhouse
  multi_family
  land
  commercial
  other
}

enum EquipmentCategory {
  camera
  lens
  lighting
  drone
  tripod
  audio
  stabilizer
  backdrop
  other
}

enum CapabilityLevel {
  learning
  capable
  expert
}

enum LeadStatus {
  new
  contacted
  qualified
  closed
}

enum MarketingAssetType {
  // Print Materials
  flyer_portrait
  flyer_landscape
  postcard_4x6
  postcard_5x7
  feature_sheet
  brochure
  window_sign
  yard_sign_rider
  door_hanger

  // Social Media - Static
  social_square // Instagram/Facebook (1080x1080)
  social_landscape // Facebook/LinkedIn (1200x630)
  social_pinterest // Pinterest (1000x1500)
  social_linkedin // LinkedIn (1200x627)
  social_twitter // Twitter/X (1600x900)
  social_story // Instagram/FB Story (1080x1920)

  // Social Media - Variants
  tile_just_listed
  tile_just_sold
  tile_open_house
  tile_price_reduced
  tile_coming_soon
  tile_under_contract
  tile_back_on_market
  tile_new_price
  tile_virtual_tour
  tile_featured

  // Video
  video_slideshow // Photo slideshow with music
  video_reel // Instagram Reel format
  video_tour_teaser // Virtual tour highlights
  video_neighborhood // Neighborhood flyover
  video_stats_animation // Animated property stats

  // Email
  email_banner
  email_template

  // Other
  qr_code
  virtual_tour_poster
}

enum MarketingAssetVariant {
  branded // With agent/brokerage branding
  unbranded // MLS-compliant, no branding
  co_branded // Photographer + agent branding
  photographer_only // Just photographer branding
}

enum SocialTileStyle {
  modern
  classic
  luxury
  minimal
  bold
  elegant
}

enum AudioSource {
  library // Royalty-free library
  uploaded // Client uploaded
  ai_generated // AI generated music
}

enum POICategory {
  school_elementary
  school_middle
  school_high
  school_private
  university
  shopping_mall
  shopping_grocery
  shopping_retail
  restaurant
  cafe
  bar
  park
  playground
  gym_fitness
  hospital
  pharmacy
  police
  fire_station
  transit_bus
  transit_train
  transit_subway
  airport
  beach
  golf_course
  church
  mosque
  synagogue
  temple
  library
  museum
  theater
  cinema
  entertainment
  bank
  post_office
  gas_station
  ev_charging
  other
}

enum WatermarkPosition {
  top_left
  top_center
  top_right
  center
  bottom_left
  bottom_center
  bottom_right
  tiled
  diagonal
}

enum DiscountType {
  percentage
  fixed_amount
}

enum PaymentPlanStatus {
  active
  completed
  cancelled
  overdue
}

enum DownloadFormat {
  original
  web_size
  high_res
  zip_all
}

enum SelectionType {
  favorite
  selection
}

enum SelectionStatus {
  in_progress
  submitted
  approved
  rejected
}

enum GalleryDownloadOption {
  full // Only original resolution
  web // Only web-optimized resolution
  both // Allow both options
}

enum PropertyWebsiteTemplate {
  modern
  classic
  luxury
  minimal
  commercial
}

enum PortfolioType {
  photographer
  client
}

enum PortfolioTemplate {
  modern
  bold
  elegant
  minimal
  creative
}

enum PortfolioSectionType {
  // Preset sections
  hero
  about
  gallery
  services
  testimonials
  awards
  contact
  faq
  // Freeform blocks
  text
  image
  video
  spacer
  custom_html
}

enum PropertySectionType {
  // Core property sections (auto-fill from property data)
  property_hero // Hero with featured images, address, price badge
  property_details // Beds, baths, sqft, lot size, year built grid
  property_features // Features list with icons
  property_description // Property description with rich text
  property_gallery // Full photo gallery grid with lightbox
  floor_plans // Floor plan images/PDFs
  virtual_tour // Matterport/iGuide embed
  video_tour // Video player section

  // Location & neighborhood
  location_map // Interactive map with property marker
  neighborhood // Nearby amenities, schools, transit
  walk_score // Walk/bike/transit scores

  // Agent & contact
  agent_info // Agent/photographer info card
  inquiry_form // Contact/inquiry form
  open_house // Open house schedule with calendar

  // Marketing & social proof
  testimonials // Client testimonials
  similar_properties // Related listings
  price_history // Price change timeline

  // Financial tools
  mortgage_calculator // Interactive mortgage calc

  // Freeform blocks
  text_block // Rich text content
  image_block // Single image with caption
  video_block // Embedded video
  spacer // Vertical spacing
  divider // Horizontal divider
  call_to_action // CTA button/banner
  custom_html // Custom HTML/embed code
}

enum LineItemType {
  service
  travel
  custom
  discount
  tax
}

enum BusinessType {
  solo
  team
  agency
}

enum DisplayMode {
  personal
  company
}

enum Industry {
  real_estate
  commercial
  events
  portraits
  food
  product
}

// Phase 1: New Enums
enum AvailabilityBlockType {
  time_off
  holiday
  personal
  maintenance
  other
}

enum TimeOffRequestStatus {
  pending
  approved
  rejected
}

enum CommunicationType {
  email
  call
  meeting
  note
  sms
}

enum CommunicationDirection {
  inbound
  outbound
  internal
}

enum SignatureType {
  drawn
  typed
  uploaded
}

enum RecurrencePattern {
  daily
  weekly
  biweekly
  monthly
  custom
}

enum CalendarProvider {
  google
  outlook
  apple
}

enum SyncDirection {
  import_only
  export_only
  both
}

// Phase 2: Client Questionnaire System
enum ClientQuestionnaireStatus {
  pending // Assigned but not started
  in_progress // Client started but not completed
  completed // Client submitted
  approved // Photographer reviewed
  expired // Past deadline
}

enum EmailType {
  gallery_delivered
  gallery_reminder
  payment_receipt
  booking_confirmation
  welcome
  property_lead
  gallery_expiration
  order_confirmation
  contract_signing
  contract_signed
  team_invitation
  questionnaire_assigned
  questionnaire_reminder
  questionnaire_completed
  photographer_digest
  custom
}

enum EmailStatus {
  pending
  sent
  delivered
  failed
  bounced
}

// Email provider for connected accounts (unified inbox)
enum EmailProvider {
  GMAIL
  OUTLOOK
}

// Direction of email message in unified inbox
enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum LegalAgreementType {
  terms_of_service
  licensing_agreement
  model_release
  property_release
  liability_waiver
  shoot_checklist
  custom
}

enum GalleryAddonCategory {
  enhancement // Photo editing, retouching
  virtual_staging // Virtual staging, furniture
  marketing // Flyers, social media, marketing materials
  video // Video tours, slideshows
  print // Prints, albums
  editing // Color correction, HDR
  removal // Object removal, decluttering
  other
}

enum GalleryAddonRequestStatus {
  pending // Client requested
  quoted // Photographer sent quote
  approved // Client approved quote
  in_progress // Work in progress
  completed // Delivered
  declined // Client declined
  cancelled // Cancelled
}

enum MessageVisibility {
  internal // Only visible to team members
  client // Visible to client and team
}

// Messaging system enums
enum ConversationType {
  direct // 1:1 between team members
  group // Multiple team members
  channel // Organization-wide topic channel
  client_support // Client-to-team conversation
}

enum ConversationParticipantRole {
  owner // Can delete conversation, manage all settings
  admin // Can add/remove members, change settings
  member // Can send/receive messages
  observer // Read-only access
}

enum ChatRequestStatus {
  pending // Client requested, awaiting approval
  approved // Team approved, conversation active
  rejected // Team rejected the request
  expired // Request timed out
}

enum MessageReactionType {
  thumbs_up
  thumbs_down
  heart
  check
  eyes
  celebration
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Organization {
  id                  String   @id @default(cuid())
  clerkOrganizationId String?  @unique
  name                String
  slug                String   @unique
  plan                PlanName @default(free)

  // Stripe
  stripeCustomerId       String? @unique
  stripeSubscriptionId   String?
  stripeConnectAccountId String?
  stripeConnectOnboarded Boolean @default(false)

  // Branding
  logoUrl        String?
  logoLightUrl   String? // Logo variant for light backgrounds
  faviconUrl     String?
  primaryColor   String? @default("#3b82f6")
  secondaryColor String? @default("#8b5cf6")
  accentColor    String? @default("#22c55e")
  customDomain   String? @unique

  // Portal Appearance (free features)
  portalMode     PortalMode @default(dark) // light or dark mode for client-facing pages
  invoiceLogoUrl String? // Separate logo for invoices (optional)

  // White-Label Options (paid plans only)
  hidePlatformBranding Boolean @default(false) // Hide "Powered by PhotoProOS"
  customEmailDomain    String? // For white-label email sending

  // Watermark Configuration
  watermarkEnabled  Boolean           @default(true)
  watermarkType     String?           @default("text") // "text" or "image"
  watermarkText     String? // Custom text (e.g., "Â© Studio Name")
  watermarkImageUrl String? // URL to watermark image
  watermarkPosition WatermarkPosition @default(bottom_right)
  watermarkOpacity  Float             @default(0.5) // 0-1
  watermarkScale    Float             @default(0.15) // Size relative to image (0-1)

  // Settings
  timezone String @default("America/New_York")
  currency String @default("USD")

  // Tax settings
  defaultTaxRate Float?  @default(0) // Default tax rate as percentage (e.g., 8.25 for 8.25%)
  taxLabel       String? @default("Sales Tax") // Label shown on invoices (e.g., "Sales Tax", "VAT", "GST")

  // Travel fee settings
  homeBaseLocationId String?
  travelFeePerMile   Int?    @default(0) // in cents (e.g., 65 = $0.65/mile)
  travelFeeThreshold Float?  @default(0) // free miles before charging

  // ============================================================================
  // ONBOARDING & INDUSTRY SETTINGS
  // ============================================================================

  // Onboarding State
  onboardingCompleted   Boolean   @default(false)
  onboardingStep        Int       @default(0)
  onboardingCompletedAt DateTime?

  // Industry Selection (array of industry IDs)
  industries      Industry[] @default([real_estate])
  primaryIndustry Industry   @default(real_estate)

  // Enabled Modules/Features (array of module IDs like "galleries", "scheduling", etc.)
  enabledModules String[] @default([])

  // Business Profile (collected during onboarding)
  businessType    BusinessType?
  teamSize        String? // "1", "2-5", "6-10", "11-25", "25+"
  yearsInBusiness String? // "<1", "1-3", "3-5", "5-10", "10+"
  annualRevenue   String? // "<50k", "50-100k", "100-250k", "250k+"

  // Display Preferences (personal vs company branding)
  displayMode DisplayMode @default(company)
  publicName  String? // What clients see (company or personal name)
  publicEmail String? // Public-facing email
  publicPhone String? // Public-facing phone
  website     String? // Company website

  // Stripe Trial/Payment
  trialStartedAt     DateTime?
  trialEndsAt        DateTime?
  paymentMethodAdded Boolean   @default(false)

  // ============================================================================
  // PHASE 3: SMS & FIELD OPERATIONS SETTINGS
  // ============================================================================

  // Gallery Settings
  autoArchiveExpiredGalleries Boolean @default(true) // Auto-archive galleries when they expire

  // Email Settings
  emailSenderName           String? // Custom "from" name for emails
  emailReplyTo              String? // Custom reply-to email address
  emailSignature            String? @db.Text // Optional email signature
  enableQuestionnaireEmails Boolean @default(true)
  enableDigestEmails        Boolean @default(true)
  digestEmailFrequency      String? @default("daily") // "daily", "weekly", "none"
  digestEmailTime           String? @default("08:00") // Time in HH:MM format
  digestEmailDayOfWeek      Int?    @default(0) // 0=Sunday, 1=Monday, etc. (for weekly digest)

  // Notification Preferences (JSON: per-category email/push toggles)
  notificationPreferences Json? // { email: {...}, push: {...}, quietHours: {...} }
  quietHoursEnabled       Boolean @default(false)
  quietHoursFrom          String? @default("22:00") // HH:MM format
  quietHoursTo            String? @default("07:00") // HH:MM format

  // Twilio SMS Settings
  twilioAccountSid  String?
  twilioAuthToken   String?
  twilioPhoneNumber String?
  smsEnabled        Boolean @default(false)

  // Self-Booking Portal Settings
  selfBookingEnabled  Boolean @default(false)
  selfBookingPageSlug String?

  // Slack Integration Settings
  slackTeamId      String?
  slackAccessToken String? @db.Text

  // Guided Tour Progress (JSON: { "dashboard": true, "galleries": false, ... })
  tourProgress Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members                  OrganizationMember[]
  invitations              Invitation[]
  projects                 Project[]
  portfolioWebsites        PortfolioWebsite[]
  portfolioInquiries       PortfolioInquiry[]
  portfolioLeads           PortfolioLead[]
  portfolioComments        PortfolioComment[]
  portfolioABTests         PortfolioABTest[]
  customForms              CustomForm[]
  clients                  Client[]
  payments                 Payment[]
  galleryFeedback          GalleryFeedback[]
  bookings                 Booking[]
  bookingTypes             BookingType[]
  invoices                 Invoice[]
  creditNotes              CreditNote[]
  estimates                Estimate[]
  clientRetainers          ClientRetainer[]
  contracts                Contract[]
  contractTemplates        ContractTemplate[]
  activityLogs             ActivityLog[]
  notifications            Notification[]
  usageMeters              UsageMeter[]
  onboardingProgress       OnboardingProgress?
  services                 Service[]
  locations                Location[]
  equipment                Equipment[]
  watermarkTemplates       WatermarkTemplate[]
  homeBaseLocation         Location?                 @relation("OrgHomeBase", fields: [homeBaseLocationId], references: [id])
  taskBoards               TaskBoard[]
  tasks                    Task[]
  taskTemplates            TaskTemplate[]
  taskAutomations          TaskAutomation[]
  recurringTasks           RecurringTask[]
  discountCodes            DiscountCode[]
  paymentPlans             PaymentPlan[]
  invoiceTemplates         InvoiceTemplate[]
  invoiceBrandingTemplates InvoiceBrandingTemplate[]
  invoiceEmailTemplates    InvoiceEmailTemplate[]
  galleryTemplates         GalleryTemplate[]

  // Phase 1: Ordering System relations
  serviceBundles ServiceBundle[]
  serviceAddons  ServiceAddon[]
  orderPages     OrderPage[]
  orders         Order[]

  // Phase 2: Brokerage & Enterprise relations
  brokerages    Brokerage[]
  payoutBatches PayoutBatch[]

  // Phase 3: SMS & Field Operations relations
  smsTemplates          SMSTemplate[]
  smsLogs               SMSLog[]
  slackIntegrations     SlackIntegration[]
  dropboxIntegration    DropboxIntegration?
  quickbooksIntegration QuickBooksIntegration?
  mailchimpIntegration  MailchimpIntegration?
  calendlyIntegration   CalendlyIntegration?
  bookingSlots          BookingSlot[]

  // Public booking forms
  bookingForms    BookingForm[]
  productCatalogs ProductCatalog[]

  // Phase 4: Service Territories & Referral Program
  territories     ServiceTerritory[]
  referralProgram ReferralProgram?

  // Phase 2: Client Questionnaire System
  questionnaireTemplates QuestionnaireTemplate[]
  clientQuestionnaires   ClientQuestionnaire[]

  // Email Logging System
  emailLogs EmailLog[]

  // Platform Referral System
  referredByPlatform PlatformReferral[] @relation("ReferredOrgByPlatform")

  // Recurring Invoices
  recurringInvoices RecurringInvoice[]

  // API Keys & Webhooks for Integrations
  apiKeys          ApiKey[]
  webhookEndpoints WebhookEndpoint[]
  integrationLogs  IntegrationLog[]

  // iCal Feed Exports
  calendarFeeds CalendarFeed[]

  // Booking Waitlist
  waitlistEntries BookingWaitlist[]

  // Unified Email Inbox
  emailAccounts        EmailAccount[]
  emailThreads         EmailThread[]
  galleryAddons        GalleryAddon[]
  galleryAddonRequests GalleryAddonRequest[]
  mlsPresets           MlsPreset[]
  projectMessages      ProjectMessage[]
  projectExpenses      ProjectExpense[]

  // Marketing Kit & Assets
  marketingKits      MarketingKit[]
  marketingTemplates MarketingTemplate[]
  audioTracks        AudioTrack[]

  // Messaging System
  conversations Conversation[]
  chatRequests  ChatRequest[]

  @@index([slug])
  @@index([plan])
}

model User {
  id          String  @id @default(cuid())
  clerkUserId String  @unique
  email       String  @unique
  fullName    String?
  avatarUrl   String?
  phone       String?

  // Personal info (collected during onboarding)
  firstName String?
  lastName  String?

  // Onboarding preferences
  hasSeenWelcome       Boolean  @default(false)
  tourCompletedModules String[] @default([])

  // Dashboard appearance preferences
  dashboardTheme     String  @default("default") // Theme preset: default, midnight, forest, sunset, ocean, lavender
  dashboardAccent    String  @default("#3b82f6") // Custom accent color
  sidebarCompact     Boolean @default(false) // Compact sidebar mode
  sidebarPosition    String  @default("left") // Sidebar position: left, right
  fontFamily         String  @default("system") // Font: system, inter, jakarta, dm-sans, space-grotesk, jetbrains
  density            String  @default("comfortable") // Spacing: compact, comfortable, spacious
  fontSize           String  @default("medium") // Font size: small, medium, large, x-large
  highContrast       Boolean @default(false) // High contrast mode for accessibility
  reduceMotion       Boolean @default(false) // Reduce animations for accessibility
  autoThemeEnabled   Boolean @default(false) // Auto switch theme based on time
  autoThemeDarkStart String  @default("18:00") // When to switch to dark mode (HH:MM)
  autoThemeDarkEnd   String  @default("06:00") // When to switch to light mode (HH:MM)

  // Dashboard customization
  dashboardConfig Json? // JSON config for widget visibility, collapsed sections, order

  // Home base location (overrides org default for travel calculations)
  homeBaseLocationId String?

  // Phase 2: Stripe Connect for photographer payouts
  stripeConnectAccountId String? @unique
  stripeConnectOnboarded Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships         OrganizationMember[]
  activityLogs        ActivityLog[]
  serviceCapabilities UserServiceCapability[]
  equipment           UserEquipment[]
  assignedBookings    Booking[]               @relation("AssignedBookings")
  homeBaseLocation    Location?               @relation("UserHomeBase", fields: [homeBaseLocationId], references: [id])
  assignedTasks       Task[]
  taskComments        TaskComment[]
  equipmentChecks     BookingEquipmentCheck[] @relation("EquipmentChecker")
  crewAssignments     BookingCrew[]           @relation("BookingCrewAssignments")

  // Platform Referral System
  platformReferrer   PlatformReferrer?
  referredByPlatform PlatformReferral[] @relation("ReferredByPlatform")

  // iCal Feed Exports
  calendarFeeds   CalendarFeed[]  @relation("UserCalendarFeeds")
  recurringTasks  RecurringTask[]
  taskTimeEntries TaskTimeEntry[]

  // Messaging System
  conversationParticipants ConversationParticipant[]
  messagesSent             Message[]                 @relation("MessageSender")
  messageReactions         MessageReaction[]
  messageReadReceipts      MessageReadReceipt[]
  chatRequestResponses     ChatRequest[]             @relation("ChatRequestResponder")

  @@index([email])
  @@index([clerkUserId])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(member)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

model Invitation {
  id             String           @id @default(cuid())
  organizationId String
  email          String
  role           MemberRole       @default(member)
  status         InvitationStatus @default(pending)

  // Invitation token for secure acceptance
  token     String   @unique
  expiresAt DateTime

  // Who sent the invitation
  invitedById String

  // Tracking
  acceptedAt DateTime?
  revokedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email, status]) // Only one pending invitation per email per org
  @@index([organizationId])
  @@index([email])
  @@index([token])
  @@index([status])
}

// ============================================================================
// CLIENTS
// ============================================================================

model Client {
  id             String         @id @default(cuid())
  organizationId String
  email          String
  fullName       String?
  company        String?
  phone          String?
  address        String?
  industry       ClientIndustry @default(other)
  notes          String?

  // Metrics
  lifetimeRevenueCents Int @default(0)
  totalProjects        Int @default(0)

  // Portal access
  portalAccessToken String?   @unique
  lastPortalAccess  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // CRM Enhancements (Phase 1)
  source         String? // How client found you: REFERRAL, ORGANIC, AD, REPEAT
  preferences    Json? // Client style/delivery preferences
  isVIP          Boolean   @default(false)
  lastActivityAt DateTime?

  // Communication preferences
  smsOptIn                 Boolean @default(true) // Client consent for SMS notifications
  emailOptIn               Boolean @default(true) // Client consent for email communications
  questionnaireEmailsOptIn Boolean @default(true) // Receive questionnaire-related emails
  marketingEmailsOptIn     Boolean @default(false) // Receive marketing emails (opt-in required)

  // Phase 2: Brokerage relationship (client is an agent under a brokerage)
  brokerageId String?

  // QuickBooks integration
  qbCustomerId String? // QuickBooks customer ID

  // Relations
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  brokerage      Brokerage?            @relation("BrokerageAgents", fields: [brokerageId], references: [id], onDelete: SetNull)
  projects       Project[]
  bookings       Booking[]
  invoices       Invoice[]
  creditNotes    CreditNote[]
  contracts      Contract[]
  payments       Payment[]
  clientSessions ClientSession[]
  tasks          Task[]
  communications ClientCommunication[]
  tags           ClientTagAssignment[]

  // Phase 1: Ordering System relations
  orderPages OrderPage[] // Dedicated order pages for this client
  orders     Order[] // Orders placed by this client

  // Phase 4: Referral Program relations
  referrer  Referrer?  @relation("ClientReferrer")
  referrals Referral[] @relation("ReferralClient")

  // Phase 2: Client Questionnaire System
  questionnaires ClientQuestionnaire[]

  // Recurring Invoices
  recurringInvoices RecurringInvoice[]

  // Phase 3: SMS Integration
  smsLogs SMSLog[]

  // Email Logging System
  emailLogs EmailLog[]

  // Client Portal Notifications
  notifications ClientNotification[]

  // Booking Waitlist
  waitlistEntries BookingWaitlist[]

  // Unified Email Inbox (threads linked to this client)
  emailThreads EmailThread[] @relation("ClientEmailThreads")

  // Estimates/Quotes
  estimates Estimate[]

  // Retainer Balance
  retainer             ClientRetainer?
  galleryAddonRequests GalleryAddonRequest[]
  mlsPresetOverrides   MlsPresetOverride[]

  // Messaging System
  conversations            Conversation[]            @relation("ConversationClient")
  conversationParticipants ConversationParticipant[] @relation("ParticipantClient")
  messagesSent             Message[]                 @relation("MessageSenderClient")
  messageReactions         MessageReaction[]         @relation("ReactionClient")
  messageReadReceipts      MessageReadReceipt[]      @relation("ReadReceiptClient")
  chatRequests             ChatRequest[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
  @@index([industry])
  @@index([brokerageId])
}

model ClientSession {
  id        String   @id @default(cuid())
  clientId  String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([token])
}

// ============================================================================
// SERVICES
// ============================================================================

// Service pricing method (flat rate vs square footage based)
enum ServicePricingMethod {
  fixed // Single fixed price (default)
  per_sqft // Price calculated per square foot
  tiered // Price based on sqft tiers (like BICEP pricing)
}

model Service {
  id             String          @id @default(cuid())
  organizationId String
  name           String
  category       ServiceCategory @default(other)
  description    String?
  priceCents     Int             @default(0) // Base price or fixed price
  duration       String? // e.g., "2-3 hours"
  deliverables   String[] // Array of included items
  isActive       Boolean         @default(true)
  isDefault      Boolean         @default(false) // System-provided template
  sortOrder      Int             @default(0)

  // Square footage pricing (for real estate and property-based services)
  pricingMethod     ServicePricingMethod @default(fixed)
  pricePerSqftCents Int?                 @default(0) // Price per sqft for per_sqft pricing
  minSqft           Int?                 @default(0) // Minimum sqft (floor for pricing)
  maxSqft           Int? // Maximum sqft (optional ceiling)
  sqftIncrements    Int?                 @default(500) // Round to nearest X sqft (e.g., 500)

  // Stripe Product Catalog sync
  stripeProductId String? // Stripe Product ID (prod_xxx)
  stripePriceId   String? // Stripe Price ID (price_xxx)
  stripeSyncedAt  DateTime? // Last successful sync timestamp

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization          Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects              Project[] // Galleries using this service (deprecated - use projectServices)
  projectServices       ProjectService[] // Many-to-many: galleries using this service
  bookings              Booking[] // Bookings using this service
  userCapabilities      UserServiceCapability[] // Team members who can perform this service
  equipmentRequirements ServiceEquipmentRequirement[] // Equipment required for this service

  // Square footage pricing tiers (for tiered pricing method)
  pricingTiers ServicePricingTier[]

  // Phase 1: Ordering System relations
  bundleItems        ServiceBundleItem[] // Bundles this service is part of
  addonCompatibility ServiceAddonCompat[] // Addons compatible with this service
  orderPageServices  OrderPageService[] // Order pages featuring this service
  orderItems         OrderItem[] // Order items referencing this service

  // Public booking forms
  bookingFormServices BookingFormService[]

  // Phase 4: Territory pricing overrides
  territoryOverrides TerritoryServiceOverride[] @relation("ServiceTerritoryOverrides")

  // Gallery templates using this service as default
  galleryTemplates GalleryTemplate[]

  // Booking Waitlist
  waitlistEntries BookingWaitlist[]

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
  @@index([isDefault])
  @@index([pricingMethod])
}

// Pricing tiers for tiered sqft services (BICEP-style pricing)
model ServicePricingTier {
  id        String @id @default(cuid())
  serviceId String

  // Tier range (e.g., 0-2000 sqft, 2001-3500 sqft, etc.)
  minSqft Int // Minimum sqft for this tier (inclusive)
  maxSqft Int? // Maximum sqft for this tier (null = unlimited)

  // Tier pricing
  priceCents Int // Fixed price for this tier
  tierName   String? // Optional display name (e.g., "Small Home", "Medium Home")

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([serviceId, minSqft])
  @@index([serviceId])
}

// ============================================================================
// GALLERIES / PROJECTS
// ============================================================================

model Project {
  id             String        @id @default(cuid())
  organizationId String
  clientId       String?
  serviceId      String?
  locationId     String?
  name           String
  description    String?
  status         ProjectStatus @default(draft)

  // Pricing
  priceCents Int    @default(0)
  currency   String @default("USD")

  // Gallery Settings
  coverImageUrl           String?
  password                String?
  expiresAt               DateTime?
  allowDownloads          Boolean               @default(true)
  allowFavorites          Boolean               @default(true)
  allowComments           Boolean               @default(false)
  showWatermark           Boolean               @default(false)
  downloadResolution      GalleryDownloadOption @default(both)
  downloadRequiresPayment Boolean               @default(true) // If true, downloads require payment. If false, allow free downloads even when gallery has a price.

  // Selection Settings
  allowSelections     Boolean @default(true) // Allow clients to make selections
  selectionLimit      Int? // Maximum photos client can select (null = unlimited)
  selectionRequired   Boolean @default(false) // Require selection before download
  selectionsSubmitted Boolean @default(false) // Whether client has submitted selections

  // Delivery
  deliveredAt   DateTime?
  archivedAt    DateTime? // When gallery was archived (auto or manual)
  viewCount     Int       @default(0)
  downloadCount Int       @default(0)

  // Reminder tracking
  lastReminderSentAt     DateTime? // When last reminder was sent
  reminderCount          Int       @default(0) // Number of reminders sent
  reminderEnabled        Boolean   @default(true) // Allow reminders for this gallery
  expirationWarningsSent Int[]     @default([]) // Days before expiration when warnings were sent (e.g., [7, 3, 1])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client            Client?                   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  service           Service?                  @relation(fields: [serviceId], references: [id], onDelete: SetNull) // Deprecated - use services
  location          Location?                 @relation(fields: [locationId], references: [id], onDelete: SetNull)
  services          ProjectService[] // Many-to-many: services for this gallery
  assets            Asset[]
  collections       GalleryCollection[] // Sub-albums within the gallery
  deliveryLinks     DeliveryLink[]
  payments          Payment[]
  favorites         GalleryFavorite[]
  comments          GalleryComment[]
  ratings           PhotoRating[]
  feedback          GalleryFeedback[]
  propertyWebsite   PropertyWebsite?
  portfolioWebsites PortfolioWebsiteProject[]
  tasks             Task[]

  // Phase 2: Client Questionnaire System
  questionnaires       ClientQuestionnaire[]
  galleryAddonRequests GalleryAddonRequest[]

  // Project Chat
  messages ProjectMessage[]

  // Project P&L
  expenses ProjectExpense[]

  // Messaging System
  conversations Conversation[] @relation("ConversationProject")

  @@index([organizationId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([status])
  @@index([createdAt])
}

// Junction table for many-to-many Project-Service relationship
model ProjectService {
  id                 String   @id @default(cuid())
  projectId          String
  serviceId          String
  isPrimary          Boolean  @default(false) // Mark the primary service if needed
  priceCentsOverride Int? // Override the service price for this specific project
  createdAt          DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([projectId, serviceId])
  @@index([projectId])
  @@index([serviceId])
}

// Gallery Templates - Reusable gallery settings presets
model GalleryTemplate {
  id             String  @id @default(cuid())
  organizationId String
  name           String // Template name
  description    String? // Optional description

  // Default service to apply
  serviceId String?

  // Pricing defaults
  defaultPriceCents Int    @default(0)
  currency          String @default("USD")

  // Access settings
  isPasswordProtected Boolean @default(false)
  defaultPassword     String? // Optional default password

  // Gallery settings
  allowDownloads    Boolean @default(true)
  allowFavorites    Boolean @default(true)
  showWatermark     Boolean @default(false)
  sendNotifications Boolean @default(true)

  // Expiration defaults
  expirationDays Int? // Number of days until expiration (null = never)

  // Metadata
  isDefault  Boolean  @default(false) // Mark as default template
  usageCount Int      @default(0) // Track how often template is used
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  service      Service?     @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([serviceId])
}

// Watermark Templates - Reusable watermark presets
model WatermarkTemplate {
  id             String @id @default(cuid())
  organizationId String
  name           String // Template name (e.g., "Full Signature", "Corner Logo")

  // Watermark configuration
  watermarkType     String // "text" | "image"
  watermarkText     String? // Text content for text watermarks
  watermarkImageUrl String? // Image URL for image watermarks
  watermarkPosition String // "top-left" | "top-right" | "bottom-left" | "bottom-right" | "center"
  watermarkOpacity  Float   @default(0.5) // 0.0 to 1.0
  watermarkScale    Float   @default(1.0) // Scale multiplier

  // Metadata
  isDefault Boolean  @default(false) // Mark as default template
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// Gallery Collections - Sub-albums within a gallery
model GalleryCollection {
  id           String  @id @default(cuid())
  projectId    String
  name         String
  description  String?
  coverAssetId String? // Cover photo for the collection
  sortOrder    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assets  Asset[]

  @@index([projectId])
  @@index([sortOrder])
}

model Asset {
  id           String  @id @default(cuid())
  projectId    String
  collectionId String? // Optional collection assignment

  // File info
  filename       String
  originalUrl    String
  thumbnailUrl   String?
  mediumUrl      String?
  watermarkedUrl String?

  // Metadata
  mimeType  String
  sizeBytes Int
  width     Int?
  height    Int?

  // EXIF data
  exifData Json?

  // Ordering
  sortOrder Int @default(0)

  // Per-photo watermark control
  excludeFromWatermark Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project       Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  collection    GalleryCollection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  favorites     GalleryFavorite[]
  comments      GalleryComment[]
  ratings       PhotoRating[]
  productPhotos ProductPhoto[]

  @@index([projectId])
  @@index([collectionId])
  @@index([sortOrder])
}

model DeliveryLink {
  id        String @id @default(cuid())
  projectId String
  slug      String @unique

  // Settings
  password  String?
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  // Analytics
  viewCount    Int       @default(0)
  lastViewedAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([slug])
}

model GalleryFavorite {
  id            String          @id @default(cuid())
  projectId     String
  assetId       String
  clientEmail   String?
  sessionId     String?
  selectionType SelectionType   @default(favorite)
  notes         String? // Client notes for this selection
  status        SelectionStatus @default(in_progress)

  createdAt   DateTime  @default(now())
  submittedAt DateTime? // When the client submitted their selections for review

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@unique([projectId, assetId, clientEmail, selectionType])
  @@index([projectId])
  @@index([assetId])
  @@index([selectionType])
  @@index([status])
}

model GalleryComment {
  id          String  @id @default(cuid())
  projectId   String
  assetId     String? // Optional - if set, this is a per-photo comment; if null, it's a gallery-level comment
  clientEmail String?
  clientName  String?
  content     String
  sessionId   String? // Session ID for secure comment ownership verification

  createdAt DateTime @default(now())

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset?  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([assetId])
  @@index([sessionId])
}

model PhotoRating {
  id        String @id @default(cuid())
  projectId String
  assetId   String
  rating    Int // 1-5 stars
  sessionId String // Track who rated for updates

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  asset   Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Unique constraint: one rating per session per photo
  @@unique([assetId, sessionId])
  @@index([projectId])
  @@index([assetId])
}

model GalleryFeedback {
  id             String  @id @default(cuid())
  projectId      String
  organizationId String
  type           String // "feedback", "feature", "issue"
  message        String
  clientName     String?
  clientEmail    String?
  ipAddress      String?
  userAgent      String?
  isRead         Boolean @default(false)
  isResolved     Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([organizationId])
  @@index([type])
  @@index([isRead])
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String?
  invoiceId      String?
  clientId       String?

  // Amount
  amountCents    Int
  tipAmountCents Int           @default(0) // Gratuity amount
  currency       String        @default("USD")
  status         PaymentStatus @default(pending)

  // Stripe
  stripePaymentIntentId   String? @unique
  stripeCheckoutSessionId String? @unique
  stripeChargeId          String?

  // Client info
  clientEmail String?
  clientName  String?

  // Metadata
  description String?
  receiptUrl  String?

  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  invoice      Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// BOOKINGS
// ============================================================================

model BookingType {
  id              String  @id @default(cuid())
  organizationId  String
  name            String
  description     String?
  durationMinutes Int     @default(60)
  priceCents      Int     @default(0)
  color           String  @default("#3b82f6")
  isActive        Boolean @default(true)

  // Buffer time settings (default for bookings of this type)
  bufferBeforeMinutes Int @default(0) // Prep time before booking
  bufferAfterMinutes  Int @default(0) // Travel/wrap-up time after booking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization          Organization                      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  bookings              Booking[]
  equipmentRequirements BookingTypeEquipmentRequirement[]

  @@index([organizationId])
}

model Booking {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  bookingTypeId  String?
  serviceId      String?
  locationId     String?
  assignedUserId String?

  // Details
  title       String
  description String?
  status      BookingStatus @default(pending)

  // Time
  startTime DateTime
  endTime   DateTime
  timezone  String   @default("America/New_York")

  // Client info (for non-registered clients)
  clientName  String?
  clientEmail String?
  clientPhone String?

  // Location (legacy field kept for backwards compatibility)
  location      String?
  locationNotes String?
  isVirtual     Boolean @default(false)
  meetingUrl    String?

  // Travel calculations (cached from Distance Matrix API)
  distanceMiles     Float?
  travelTimeMinutes Int?
  travelFeeCents    Int?   @default(0)

  // Buffer time (per-booking override, null = use type defaults)
  bufferBeforeMinutes Int? // Prep time before booking
  bufferAfterMinutes  Int? // Travel/wrap-up time after booking

  // Weather data (cached for performance)
  weatherCache    Json?
  weatherCachedAt DateTime?

  // Notes
  notes         String?
  internalNotes String?

  // Multi-day event fields (for weddings, conferences, etc.)
  isMultiDay       Boolean @default(false)
  multiDayName     String? // Overall event name like "Smith Wedding Weekend"
  multiDayParentId String? // For sessions within a multi-day event

  // Recurring booking fields
  isRecurring          Boolean            @default(false)
  recurrencePattern    RecurrencePattern?
  recurrenceInterval   Int?               @default(1) // e.g., every 2 weeks
  recurrenceEndDate    DateTime? // Optional end date for the series
  recurrenceCount      Int? // Optional max occurrences
  recurrenceDaysOfWeek Int[]              @default([]) // For weekly: 0=Sun, 1=Mon, etc.
  seriesId             String? // Groups all bookings in a series
  parentBookingId      String? // Reference to the original booking

  // Industry categorization (for multi-industry orgs)
  industry Industry?

  // Completion tracking
  completedAt DateTime? // When booking status changed to "completed"

  // Follow-up tracking
  followupsSent String[] @default([]) // Tracks which follow-up emails were sent (e.g., "thank_you_1", "review_request_3")

  // External integration sync
  externalId     String? // ID from external system (Calendly, Google Calendar, etc.)
  externalSource String? // Source system: "calendly", "google_calendar", etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization       Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client             Client?                 @relation(fields: [clientId], references: [id], onDelete: SetNull)
  bookingType        BookingType?            @relation(fields: [bookingTypeId], references: [id], onDelete: SetNull)
  service            Service?                @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  locationRef        Location?               @relation(fields: [locationId], references: [id], onDelete: SetNull)
  assignedUser       User?                   @relation("AssignedBookings", fields: [assignedUserId], references: [id], onDelete: SetNull)
  reminders          BookingReminder[]
  invoiceLineItems   InvoiceLineItem[]
  tasks              Task[]
  equipmentChecklist BookingEquipmentCheck[]

  // Phase 1: Ordering System relations
  orderId String? @unique
  order   Order?  @relation("OrderBooking", fields: [orderId], references: [id], onDelete: SetNull)

  // Public booking form submission (source of this booking)
  formSubmission BookingFormSubmission?

  // Recurring booking self-reference
  parentBooking Booking?  @relation("RecurringBookings", fields: [parentBookingId], references: [id], onDelete: SetNull)
  childBookings Booking[] @relation("RecurringBookings")

  // Multi-day event self-reference (parent event and sessions)
  multiDayParent   Booking?  @relation("MultiDaySessions", fields: [multiDayParentId], references: [id], onDelete: SetNull)
  multiDaySessions Booking[] @relation("MultiDaySessions")

  // Second shooter / crew assignments
  crew BookingCrew[]

  // Phase 4: Referral Program back-reference
  referrals Referral[] @relation("ReferralBooking")

  // Phase 2: Client Questionnaire System
  questionnaires ClientQuestionnaire[]

  // Phase 3: SMS Integration
  smsLogs SMSLog[]

  // Waitlist conversion (booking created from waitlist)
  convertedFromWaitlist BookingWaitlist? @relation("WaitlistConversion")

  @@index([organizationId])
  @@index([multiDayParentId])
  @@index([clientId])
  @@index([serviceId])
  @@index([locationId])
  @@index([assignedUserId])
  @@index([startTime])
  @@index([status])
  @@index([seriesId])
  @@index([parentBookingId])
  @@index([industry])
}

// ============================================================================
// BOOKING WAITLIST
// ============================================================================

model BookingWaitlist {
  id             String @id @default(cuid())
  organizationId String

  // Client info (can be existing client or new inquiry)
  clientId    String?
  clientName  String
  clientEmail String
  clientPhone String?

  // Desired booking details
  serviceId     String?
  preferredDate DateTime // Preferred date/time
  alternateDate DateTime? // Alternate date if available
  flexibleDates Boolean   @default(false) // Willing to take any available slot
  notes         String? // Special requests

  // Waitlist status
  status             WaitlistStatus @default(pending)
  priority           Int            @default(0) // Higher = more priority
  position           Int? // Position in queue (calculated)
  notifiedAt         DateTime? // When client was notified of availability
  expiresAt          DateTime? // When the offer expires
  convertedBookingId String?        @unique // If converted to booking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client           Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  service          Service?     @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  convertedBooking Booking?     @relation("WaitlistConversion", fields: [convertedBookingId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([clientId])
  @@index([serviceId])
  @@index([status])
  @@index([preferredDate])
  @@index([priority])
}

enum WaitlistStatus {
  pending // Waiting for availability
  notified // Client notified of availability
  accepted // Client accepted and booking created
  declined // Client declined the offer
  expired // Offer expired without response
  cancelled // Client cancelled from waitlist
}

// ============================================================================
// BOOKING CREW (Second Shooters, Assistants)
// ============================================================================

enum BookingCrewRole {
  lead_photographer
  second_shooter
  assistant
  videographer
  stylist
  makeup_artist
  other
}

model BookingCrew {
  id        String @id @default(cuid())
  bookingId String
  userId    String

  // Role and details
  role       BookingCrewRole @default(second_shooter)
  notes      String? // Special instructions for this team member
  hourlyRate Int? // Rate in cents (override user default)
  confirmed  Boolean         @default(false) // Has the crew member confirmed availability

  // Status tracking
  confirmedAt DateTime?
  declinedAt  DateTime?
  declineNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user    User    @relation("BookingCrewAssignments", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bookingId, userId])
  @@index([bookingId])
  @@index([userId])
  @@index([confirmed])
}

enum ReminderType {
  hours_24
  hours_1
  custom
}

enum ReminderChannel {
  email
  sms
}

enum ReminderRecipient {
  client
  photographer
  both
}

model BookingReminder {
  id        String    @id @default(cuid())
  bookingId String
  sendAt    DateTime
  sent      Boolean   @default(false)
  sentAt    DateTime?

  // Reminder configuration
  type          ReminderType      @default(hours_24)
  channel       ReminderChannel   @default(email)
  recipient     ReminderRecipient @default(client)
  minutesBefore Int               @default(1440) // 24 hours = 1440 minutes

  // Delivery tracking
  errorMessage String?

  createdAt DateTime @default(now())

  // Relations
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([sendAt])
  @@index([sent, sendAt]) // For finding unsent reminders due to be sent
}

// ============================================================================
// INVOICES
// ============================================================================

model Invoice {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  invoiceNumber  String

  // Status
  status InvoiceStatus @default(draft)

  // Amounts
  subtotalCents   Int    @default(0)
  taxCents        Int    @default(0)
  discountCents   Int    @default(0)
  totalCents      Int    @default(0)
  paidAmountCents Int    @default(0) // Tracks partial payments
  currency        String @default("USD")

  // Late Fees
  lateFeeEnabled      Boolean   @default(false)
  lateFeeType         String?   @default("percentage") // "percentage" or "fixed"
  lateFeePercent      Float?    @default(5) // e.g., 5 = 5%
  lateFeeFlatCents    Int? // Flat fee in cents
  lateFeeAppliedCents Int       @default(0) // Total late fees applied
  lastLateFeeAt       DateTime? // When late fee was last applied

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime
  paidAt    DateTime?

  // Client info
  clientName    String?
  clientEmail   String?
  clientAddress String?

  // Notes
  notes String?
  terms String?

  // Payment link
  stripePaymentLinkId String?
  paymentLinkUrl      String?

  // QuickBooks integration
  qbInvoiceId String? // QuickBooks invoice ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?           @relation(fields: [clientId], references: [id], onDelete: SetNull)
  lineItems    InvoiceLineItem[]
  payments     Payment[]
  tasks        Task[]

  // Phase 1: Ordering System relations
  orderId String? @unique
  order   Order?  @relation("OrderInvoice", fields: [orderId], references: [id], onDelete: SetNull)

  // Phase 4: Referral Program back-reference
  referrals Referral[] @relation("ReferralInvoice")

  // Payment Reminders
  remindersSent  Int       @default(0)
  lastReminderAt DateTime?
  nextReminderAt DateTime?
  autoReminders  Boolean   @default(true) // Enable/disable auto reminders

  // Invoice Scheduling
  scheduledSendAt DateTime? // When to automatically send the invoice
  scheduledSentAt DateTime? // When the scheduled send was processed

  // Credit Notes
  creditNotesOriginal CreditNote[] @relation("CreditNoteOriginalInvoice") // Credit notes issued for this invoice
  creditNotesApplied  CreditNote[] @relation("CreditNoteAppliedInvoice") // Credit notes applied to this invoice

  // Deposit/Balance Invoice Split
  isDeposit       Boolean   @default(false) // Is this a deposit invoice?
  isBalance       Boolean   @default(false) // Is this a balance invoice?
  depositPercent  Float? // Deposit percentage (e.g., 50 for 50%)
  parentInvoiceId String? // Link to the original invoice (for deposit/balance invoices)
  parentInvoice   Invoice?  @relation("InvoiceDepositBalance", fields: [parentInvoiceId], references: [id], onDelete: SetNull)
  childInvoices   Invoice[] @relation("InvoiceDepositBalance") // Deposit and balance invoices

  // Attachments
  attachments InvoiceAttachment[]

  // Created from Estimate
  estimateSource       Estimate?             @relation("EstimateToInvoice")
  galleryAddonRequests GalleryAddonRequest[]

  @@unique([organizationId, invoiceNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceLineItem {
  id          String       @id @default(cuid())
  invoiceId   String
  bookingId   String? // Link to booking for travel fees
  itemType    LineItemType @default(service)
  description String
  quantity    Int          @default(1)
  unitCents   Int
  totalCents  Int
  sortOrder   Int          @default(0)

  createdAt DateTime @default(now())

  // Relations
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([invoiceId])
  @@index([bookingId])
  @@index([itemType])
}

// Credit Note - for refunds, credits, and invoice adjustments
model CreditNote {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  invoiceId      String? // Optional link to original invoice

  // Credit note number
  creditNoteNumber String

  // Status
  status CreditNoteStatus @default(draft)

  // Amounts
  amountCents Int    @default(0)
  currency    String @default("USD")

  // Client info (cached from invoice or client)
  clientName  String?
  clientEmail String?

  // Details
  reason      String? // Reason for the credit note
  description String? // Detailed description
  notes       String? // Internal notes

  // Application
  appliedToInvoiceId  String? // If applied to a different invoice
  appliedAmountCents  Int       @default(0) // Amount applied from this credit note
  appliedAt           DateTime?
  refundedAmountCents Int       @default(0) // Amount refunded to client
  refundedAt          DateTime?

  // Dates
  issueDate DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client           Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  invoice          Invoice?     @relation("CreditNoteOriginalInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  appliedToInvoice Invoice?     @relation("CreditNoteAppliedInvoice", fields: [appliedToInvoiceId], references: [id], onDelete: SetNull)

  @@unique([organizationId, creditNoteNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([invoiceId])
  @@index([status])
}

enum CreditNoteStatus {
  draft
  issued // Sent to client
  applied // Applied to an invoice
  refunded // Refunded to client
  voided // Cancelled/voided
}

// Invoice Template - reusable preset line items for quick invoice creation
model InvoiceTemplate {
  id             String @id @default(cuid())
  organizationId String

  name        String // Template name (e.g., "Wedding Package", "Headshot Session")
  description String? // Optional description
  category    String? // Category for organization (e.g., "Weddings", "Portraits")

  // Default values
  defaultDueDays Int     @default(30) // Days until due
  defaultNotes   String? // Default invoice notes
  defaultTerms   String? // Default terms and conditions
  taxRate        Float? // Default tax rate override

  // Line items stored as JSON
  lineItems Json // Array of { itemType, description, quantity, unitCents }

  // Calculated totals (for display purposes)
  subtotalCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  // Settings
  isActive   Boolean @default(true)
  isDefault  Boolean @default(false) // Default template for new invoices
  usageCount Int     @default(0) // Track how often this template is used

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

// Estimate/Quote - proposals that can be converted to invoices
model Estimate {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?

  // Estimate number
  estimateNumber String

  // Status
  status EstimateStatus @default(draft)

  // Amounts
  subtotalCents Int    @default(0)
  taxCents      Int    @default(0)
  discountCents Int    @default(0)
  totalCents    Int    @default(0)
  currency      String @default("USD")

  // Client info (cached)
  clientName    String?
  clientEmail   String?
  clientAddress String?

  // Details
  title       String? // Project/service title
  description String? // Detailed description
  notes       String?
  terms       String?

  // Validity
  issueDate  DateTime @default(now())
  validUntil DateTime // When the estimate expires

  // Conversion tracking
  convertedToInvoiceId String?   @unique
  convertedAt          DateTime?

  // Client actions
  viewedAt        DateTime?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client             Client?            @relation(fields: [clientId], references: [id], onDelete: SetNull)
  convertedToInvoice Invoice?           @relation("EstimateToInvoice", fields: [convertedToInvoiceId], references: [id], onDelete: SetNull)
  lineItems          EstimateLineItem[]

  @@unique([organizationId, estimateNumber])
  @@index([organizationId])
  @@index([clientId])
  @@index([status])
}

model EstimateLineItem {
  id          String       @id @default(cuid())
  estimateId  String
  itemType    LineItemType @default(service)
  description String
  quantity    Int          @default(1)
  unitCents   Int
  totalCents  Int
  sortOrder   Int          @default(0)

  createdAt DateTime @default(now())

  estimate Estimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)

  @@index([estimateId])
}

enum EstimateStatus {
  draft
  sent // Sent to client
  viewed // Client has viewed
  approved // Client approved
  rejected // Client rejected
  expired // Past validUntil date
  converted // Converted to invoice
}

// Invoice Attachment - files attached to invoices
model InvoiceAttachment {
  id        String @id @default(cuid())
  invoiceId String

  fileName    String
  fileUrl     String
  fileType    String // MIME type
  fileSizeMb  Float   @default(0)
  description String?

  createdAt DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// Client Retainer - prepaid balance for services
model ClientRetainer {
  id             String @id @default(cuid())
  organizationId String
  clientId       String @unique // One-to-one with Client

  // Balance
  balanceCents        Int    @default(0) // Current available balance
  totalDepositedCents Int    @default(0) // Lifetime deposits
  totalUsedCents      Int    @default(0) // Lifetime usage
  currency            String @default("USD")

  // Settings
  isActive                 Boolean @default(true)
  lowBalanceThresholdCents Int? // Alert when balance falls below this

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  transactions RetainerTransaction[]

  @@unique([organizationId, clientId]) // One retainer per client
  @@index([organizationId])
  @@index([clientId])
}

model RetainerTransaction {
  id         String @id @default(cuid())
  retainerId String

  type        RetainerTransactionType
  amountCents Int
  description String?

  // References
  invoiceId String? // If applied to an invoice
  paymentId String? // If from a payment

  balanceAfterCents Int // Balance after this transaction

  createdAt DateTime @default(now())

  retainer ClientRetainer @relation(fields: [retainerId], references: [id], onDelete: Cascade)

  @@index([retainerId])
  @@index([invoiceId])
}

enum RetainerTransactionType {
  deposit // Client added funds
  usage // Applied to invoice
  refund // Refunded to client
  adjustment // Manual adjustment
}

// Recurring Invoice Template - for subscription/retainer billing
model RecurringInvoice {
  id             String @id @default(cuid())
  organizationId String
  clientId       String

  // Schedule
  frequency   RecurringFrequency @default(monthly)
  dayOfMonth  Int?               @default(1) // 1-28 for monthly
  dayOfWeek   Int? // 0-6 for weekly (0 = Sunday)
  anchorDate  DateTime // Start date for the recurring schedule
  nextRunDate DateTime // Next scheduled invoice creation

  // Status
  isActive   Boolean   @default(true)
  isPaused   Boolean   @default(false)
  pausedAt   DateTime?
  pauseUntil DateTime? // Resume date if paused temporarily

  // Invoice template
  subtotalCents Int     @default(0)
  taxCents      Int     @default(0)
  totalCents    Int     @default(0)
  currency      String  @default("USD")
  notes         String?
  terms         String?
  dueDays       Int     @default(30) // Days after creation until due

  // Line items stored as JSON (template for each invoice)
  lineItems Json // Array of { itemType, description, quantity, unitCents }

  // Tracking
  invoicesCreated Int       @default(0)
  lastInvoiceAt   DateTime?
  lastInvoiceId   String? // Reference to last created invoice

  // End conditions (optional)
  endDate     DateTime? // Stop after this date
  maxInvoices Int? // Stop after this many invoices

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([clientId])
  @@index([isActive])
  @@index([nextRunDate])
}

enum RecurringFrequency {
  weekly
  biweekly
  monthly
  quarterly
  yearly
}

// ============================================================================
// CONTRACTS
// ============================================================================

model ContractTemplate {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  description    String?
  content        String  @db.Text
  isDefault      Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contracts    Contract[]

  @@index([organizationId])
}

model Contract {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String?
  templateId     String?

  // Details
  name    String
  content String         @db.Text
  status  ContractStatus @default(draft)

  // Metadata
  pdfUrl String?

  // Dates
  sentAt    DateTime?
  signedAt  DateTime?
  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?             @relation(fields: [clientId], references: [id], onDelete: SetNull)
  template     ContractTemplate?   @relation(fields: [templateId], references: [id], onDelete: SetNull)
  signers      ContractSigner[]
  auditLogs    ContractAuditLog[]
  signatures   ContractSignature[]

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
}

model ContractSigner {
  id         String  @id @default(cuid())
  contractId String
  email      String
  name       String?

  // Signing
  signatureUrl    String?
  signedAt        DateTime?
  signedIp        String?
  signedUserAgent String?

  // Token for signing
  signingToken   String    @unique
  tokenExpiresAt DateTime?

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([signingToken])
}

model ContractAuditLog {
  id         String  @id @default(cuid())
  contractId String
  action     String
  actorEmail String?
  actorIp    String?
  metadata   Json?

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([createdAt])
}

// ============================================================================
// ACTIVITY & NOTIFICATIONS
// ============================================================================

model ActivityLog {
  id             String       @id @default(cuid())
  organizationId String
  userId         String?
  type           ActivityType
  description    String
  metadata       Json?

  // Related entities
  projectId  String?
  clientId   String?
  paymentId  String?
  bookingId  String?
  invoiceId  String?
  contractId String?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Notification {
  id             String           @id @default(cuid())
  organizationId String
  type           NotificationType
  title          String
  message        String
  linkUrl        String?
  read           Boolean          @default(false)
  readAt         DateTime?

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([read])
  @@index([createdAt])
}

// Client Portal Notifications (for clients in their portal)
model ClientNotification {
  id       String                 @id @default(cuid())
  clientId String
  type     ClientNotificationType
  title    String
  message  String
  linkUrl  String?
  read     Boolean                @default(false)
  readAt   DateTime?

  createdAt DateTime @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([read])
  @@index([createdAt])
}

enum ClientNotificationType {
  gallery_ready // Gallery is ready for viewing
  gallery_expiring // Gallery is about to expire
  invoice_sent // New invoice received
  invoice_reminder // Payment reminder
  payment_confirmed // Payment was successful
  contract_ready // Contract needs signature
  contract_signed // Contract was signed successfully
  booking_confirmed // Booking was confirmed
  booking_reminder // Upcoming booking reminder
  questionnaire_ready // Questionnaire needs completion
  message_received // New message from photographer
  photos_downloaded // Download receipt
  favorites_saved // Favorites were saved
  system // System notification
}

// ============================================================================
// USAGE & METERING
// ============================================================================

model UsageMeter {
  id             String @id @default(cuid())
  organizationId String
  month          String // "2025-01" format

  // Usage counts
  storageBytes     BigInt @default(0)
  galleriesCreated Int    @default(0)
  emailsSent       Int    @default(0)
  apiCalls         Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, month])
  @@index([organizationId])
  @@index([month])
}

model OnboardingProgress {
  id             String @id @default(cuid())
  organizationId String @unique

  // Legacy steps (kept for backwards compatibility)
  profileComplete     Boolean @default(false)
  brandingComplete    Boolean @default(false)
  firstGalleryCreated Boolean @default(false)
  stripeConnected     Boolean @default(false)

  // New Onboarding Wizard Steps
  welcomeViewed    Boolean @default(false) // Step 0
  personalComplete Boolean @default(false) // Step 1: First/last name
  businessComplete Boolean @default(false) // Step 2: Company, type, size
  brandingStepDone Boolean @default(false) // Step 3: Display mode, public info
  industriesSet    Boolean @default(false) // Step 4: Industry selection
  featuresSelected Boolean @default(false) // Step 5: Module selection
  goalsSet         Boolean @default(false) // Step 6: Business goals
  paymentStepDone  Boolean @default(false) // Step 7: Payment/trial setup
  tourStarted      Boolean @default(false) // Step 8: Guided tour

  // Wizard state
  currentStep  Int      @default(0)
  skippedSteps String[] @default([]) // Steps user skipped

  // Goals selected during onboarding
  selectedGoals String[] @default([])

  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// ============================================================================
// LOCATIONS & PROPERTY DETAILS
// ============================================================================

model Location {
  id             String @id @default(cuid())
  organizationId String

  // Google Places data
  placeId          String? // Google Place ID for caching
  formattedAddress String
  streetAddress    String?
  city             String?
  state            String?
  postalCode       String?
  country          String  @default("US")

  // Coordinates
  latitude  Float
  longitude Float

  // Metadata
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orgHomeBase     Organization[]   @relation("OrgHomeBase")
  userHomeBase    User[]           @relation("UserHomeBase")
  bookings        Booking[]
  projects        Project[]
  propertyDetails PropertyDetails?

  // Phase 1: Ordering System relations
  orders Order[]

  @@index([organizationId])
  @@index([placeId])
}

model PropertyDetails {
  id         String @id @default(cuid())
  locationId String @unique

  // Property data
  propertyType PropertyType?
  bedrooms     Int?
  bathrooms    Float? // 2.5 baths, etc.
  squareFeet   Int?
  lotSize      Int? // in sqft
  yearBuilt    Int?
  listingPrice Int? // in cents

  // MLS data
  mlsNumber         String?
  listingAgent      String?
  listingAgentPhone String?

  // Metadata
  dataSource String? // "attom", "zillow", "manual"
  fetchedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([mlsNumber])
}

// ============================================================================
// EQUIPMENT & TEAM CAPABILITIES
// ============================================================================

model Equipment {
  id             String            @id @default(cuid())
  organizationId String
  name           String
  category       EquipmentCategory
  description    String?
  serialNumber   String?
  purchaseDate   DateTime?
  valueCents     Int? // Equipment value in cents

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization            Organization                      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAssignments         UserEquipment[]
  serviceRequirements     ServiceEquipmentRequirement[]
  bookingTypeRequirements BookingTypeEquipmentRequirement[]
  bookingChecks           BookingEquipmentCheck[]

  @@index([organizationId])
  @@index([category])
}

model UserEquipment {
  id          String   @id @default(cuid())
  userId      String
  equipmentId String
  assignedAt  DateTime @default(now())
  notes       String?

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([userId, equipmentId])
  @@index([userId])
  @@index([equipmentId])
}

model UserServiceCapability {
  id        String          @id @default(cuid())
  userId    String
  serviceId String
  level     CapabilityLevel @default(capable)
  notes     String?

  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceId])
  @@index([userId])
  @@index([serviceId])
  @@index([level])
}

model ServiceEquipmentRequirement {
  id          String  @id @default(cuid())
  serviceId   String
  equipmentId String
  isRequired  Boolean @default(true) // vs. recommended

  // Relations
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([serviceId, equipmentId])
  @@index([serviceId])
  @@index([equipmentId])
}

// Equipment requirements per booking type (checklist defaults)
model BookingTypeEquipmentRequirement {
  id            String  @id @default(cuid())
  bookingTypeId String
  equipmentId   String
  isRequired    Boolean @default(true) // Required vs recommended
  quantity      Int     @default(1) // How many of this item needed
  notes         String? // Special instructions for this equipment

  // Relations
  bookingType BookingType @relation(fields: [bookingTypeId], references: [id], onDelete: Cascade)
  equipment   Equipment   @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([bookingTypeId, equipmentId])
  @@index([bookingTypeId])
  @@index([equipmentId])
}

// Equipment checklist for a specific booking (actual check-offs)
model BookingEquipmentCheck {
  id          String    @id @default(cuid())
  bookingId   String
  equipmentId String
  isChecked   Boolean   @default(false) // Has the item been checked/packed?
  checkedAt   DateTime? // When it was checked
  checkedById String? // Who checked it
  notes       String? // Any notes about this item for this booking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  equipment Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  checkedBy User?     @relation("EquipmentChecker", fields: [checkedById], references: [id], onDelete: SetNull)

  @@unique([bookingId, equipmentId])
  @@index([bookingId])
  @@index([equipmentId])
}

// ============================================================================
// PROPERTY WEBSITES (Phase 2)
// ============================================================================

model PropertyWebsite {
  id        String @id @default(cuid())
  projectId String @unique

  // Property Info
  address      String
  city         String
  state        String
  zipCode      String
  price        Int? // in cents
  beds         Int?
  baths        Float?
  sqft         Int?
  lotSize      String?
  yearBuilt    Int?
  propertyType PropertyType?

  // Content
  headline       String?
  description    String?  @db.Text
  features       String[] // Array of feature highlights
  virtualTourUrl String? // Matterport, iGuide, etc.
  videoUrl       String?

  // Floor Plans
  floorPlanUrls String[] // Array of floor plan image URLs

  // Settings
  template    PropertyWebsiteTemplate @default(modern)
  isPublished Boolean                 @default(false)
  isBranded   Boolean                 @default(true) // Show photographer branding
  showPrice   Boolean                 @default(true)
  showAgent   Boolean                 @default(true)

  // Section-based layout (like portfolio websites)
  useSectionLayout Boolean @default(false) // Toggle between classic template and section-based

  // Custom Domain
  customDomain         String? @unique
  customDomainVerified Boolean @default(false)
  customDomainSsl      Boolean @default(false)

  // Template Customization
  accentColor    String? // Custom accent color override (hex, e.g., "#3b82f6")
  secondaryColor String? // Secondary accent color
  fontHeading    String? // Custom heading font
  fontBody       String? // Custom body font
  logoUrl        String? // Custom logo for the property page
  customCss      String? @db.Text // Custom CSS overrides

  // Access Control
  isPasswordProtected Boolean @default(false)
  password            String? // Hashed password

  // Scheduled Publishing
  scheduledPublishAt DateTime? // When to auto-publish
  expiresAt          DateTime? // When the site expires/unpublishes

  // Open House Scheduling
  openHouseDate    DateTime? // Open house start date/time
  openHouseEndDate DateTime? // Open house end date/time (optional, defaults to +2 hours)

  // Agent/Contact Info Override
  agentName     String?
  agentEmail    String?
  agentPhone    String?
  agentPhotoUrl String?
  brokerageName String?
  brokerageLogo String?

  // Social & Sharing
  socialImage   String? // OG image for social sharing
  enableSharing Boolean @default(true) // Show share buttons

  // Interactive Features
  enableMortgageCalc Boolean @default(true)
  enableScheduleTour Boolean @default(true)
  enableFavorite     Boolean @default(true) // Allow users to "heart" the property

  // Marketing Kit Auto-Generation
  autoGenerateMarketingKit Boolean @default(false) // Auto-create marketing materials on publish

  // SEO
  slug            String  @unique
  metaTitle       String?
  metaDescription String?
  faviconUrl      String?

  // Analytics (denormalized for quick access)
  viewCount Int @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  project          Project                  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sections         PropertyWebsiteSection[]
  analytics        PropertyAnalytics[]
  marketingAssets  MarketingAsset[]
  leads            PropertyLead[]
  tasks            Task[]
  views            PropertyWebsiteView[]
  marketingKit     MarketingKit?
  neighborhoodData NeighborhoodData?

  @@index([slug])
  @@index([isPublished])
  @@index([customDomain])
}

// Property Website Section (like Portfolio sections but for properties)
model PropertyWebsiteSection {
  id                String @id @default(cuid())
  propertyWebsiteId String

  // Section Configuration
  sectionType PropertySectionType
  position    Int                 @default(0)
  isVisible   Boolean             @default(true)

  // Section Content (JSON - varies by sectionType)
  // property_hero: { layout, showPrice, showBadge, badgeText, overlayOpacity, ctaText, ctaLink }
  // property_details: { layout, showIcons, columns, customLabels }
  // property_features: { layout, columns, iconStyle, showCategories }
  // property_description: { showTitle, alignment }
  // property_gallery: { layout, columns, showCaptions, enableLightbox, maxImages }
  // floor_plans: { layout, showLabels }
  // virtual_tour: { provider, embedOptions }
  // video_tour: { autoplay, muted, loop, showControls }
  // location_map: { zoom, style, showMarker, height }
  // neighborhood: { categories[], radius, showDistances }
  // walk_score: { showBikeScore, showTransitScore }
  // agent_info: { layout, showPhone, showEmail, showSocial }
  // inquiry_form: { fields[], submitText, successMessage }
  // open_house: { showCalendarAdd, showReminder }
  // testimonials: { items[], layout }
  // similar_properties: { maxItems, showPrice }
  // price_history: { showChart }
  // mortgage_calculator: { defaultDownPayment, defaultInterestRate, defaultTerm }
  // text_block: { content, alignment, maxWidth }
  // image_block: { url, alt, caption, layout, aspectRatio }
  // video_block: { url, provider, autoplay }
  // spacer: { height, showDivider }
  // divider: { style, color, width }
  // call_to_action: { title, subtitle, buttonText, buttonLink, style }
  // custom_html: { html, containerClass }
  config Json

  // Optional title override for section
  customTitle String?

  // Styling overrides
  backgroundColor String? // Section-specific background color
  paddingTop      String? // Custom top padding
  paddingBottom   String? // Custom bottom padding

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([position])
}

// Property Website View Analytics (like Portfolio views)
model PropertyWebsiteView {
  id                String   @id @default(cuid())
  propertyWebsiteId String
  viewedAt          DateTime @default(now())

  // Visitor identification
  visitorId String? // Anonymous visitor ID (cookie-based)
  sessionId String? // Session identifier
  ipAddress String? // Hashed IP for uniqueness
  userAgent String?

  // Referral tracking
  referrer    String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Geo data
  country String?
  city    String?
  region  String?

  // Engagement
  scrollDepth      Int? // 0-100 percentage
  timeOnPage       Int? // seconds
  sectionsViewed   String[] // Array of section IDs viewed
  actionsPerformed String[] // e.g., ["gallery_open", "tour_click", "inquiry_start"]

  // Device info
  deviceType String? // mobile, tablet, desktop
  browser    String?
  os         String?

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([viewedAt])
  @@index([visitorId])
}

model PropertyAnalytics {
  id                String   @id @default(cuid())
  propertyWebsiteId String
  date              DateTime @default(now()) @db.Date

  // Traffic
  pageViews      Int  @default(0)
  uniqueVisitors Int  @default(0)
  avgTimeOnPage  Int? // seconds

  // Engagement
  tourClicks   Int @default(0)
  photoViews   Int @default(0)
  socialShares Int @default(0)

  // Traffic sources
  directTraffic Int @default(0)
  socialTraffic Int @default(0)
  emailTraffic  Int @default(0)
  searchTraffic Int @default(0)

  // Device breakdown
  mobileViews  Int @default(0)
  desktopViews Int @default(0)
  tabletViews  Int @default(0)

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@unique([propertyWebsiteId, date])
  @@index([propertyWebsiteId])
  @@index([date])
}

model PropertyLead {
  id                String @id @default(cuid())
  propertyWebsiteId String

  // Lead info
  name    String
  email   String
  phone   String?
  message String? @db.Text
  source  String? // website, social, email, etc.

  // Status
  status LeadStatus @default(new)

  // Lead Scoring
  score          Int    @default(0) // 0-100 score
  scoreBreakdown Json? // { "pageViews": 10, "timeOnSite": 15, "photoViews": 20, ... }
  temperature    String @default("cold") // "hot", "warm", "cold"

  // Engagement tracking
  pageViews        Int       @default(0)
  photoViews       Int       @default(0)
  tourClicks       Int       @default(0)
  totalTimeSeconds Int       @default(0)
  lastActivityAt   DateTime?

  // Contact history
  contactedAt  DateTime?
  followUpDate DateTime?
  notes        String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyWebsite PropertyWebsite @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)

  @@index([propertyWebsiteId])
  @@index([status])
  @@index([score])
  @@index([temperature])
  @@index([createdAt])
}

model MarketingAsset {
  id                String  @id @default(cuid())
  propertyWebsiteId String?
  marketingKitId    String?

  // Asset info
  type         MarketingAssetType
  variant      MarketingAssetVariant @default(branded)
  name         String
  description  String?
  fileUrl      String
  thumbnailUrl String?
  fileSize     Int? // in bytes
  mimeType     String?
  dimensions   Json? // { width, height } for images/videos
  duration     Int? // seconds for videos

  // Generation metadata
  templateId      String?
  templateUsed    String?
  settings        Json? // Custom settings used to generate
  isAutoGenerated Boolean @default(false)
  isEdited        Boolean @default(false) // Has been edited in Canva-style editor
  editData        Json? // Saved editor state for re-editing

  // Video-specific
  audioTrackId String?

  // Status
  status String @default("ready") // generating, ready, failed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyWebsite PropertyWebsite?     @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)
  marketingKit    MarketingKit?        @relation(fields: [marketingKitId], references: [id], onDelete: Cascade)
  audioTrack      AudioTrack?          @relation(fields: [audioTrackId], references: [id])
  template        MarketingTemplate?   @relation(fields: [templateId], references: [id])
  variants        MarketingAssetFile[]

  @@index([propertyWebsiteId])
  @@index([marketingKitId])
  @@index([type])
  @@index([variant])
}

// Multiple file variants for an asset (branded, unbranded, etc.)
model MarketingAssetFile {
  id               String @id @default(cuid())
  marketingAssetId String

  variant      MarketingAssetVariant
  fileUrl      String
  thumbnailUrl String?
  fileSize     Int?

  createdAt DateTime @default(now())

  // Relations
  marketingAsset MarketingAsset @relation(fields: [marketingAssetId], references: [id], onDelete: Cascade)

  @@unique([marketingAssetId, variant])
  @@index([marketingAssetId])
}

// ============================================================================
// MARKETING KIT
// ============================================================================

model MarketingKit {
  id                String  @id @default(cuid())
  propertyWebsiteId String? @unique
  organizationId    String

  // Kit info
  name        String
  description String?
  style       SocialTileStyle @default(modern)

  // Pricing & Purchase
  isPurchased    Boolean   @default(false)
  purchasedAt    DateTime?
  pricePaidCents Int?
  purchaseType   String? // "bundled", "separate", "subscription", "credits"

  // Auto-generation settings
  autoGenerateOnCreate Boolean  @default(true)
  autoGenerateTypes    String[] // Which asset types to auto-generate

  // Branding settings
  includeBranded   Boolean @default(true)
  includeUnbranded Boolean @default(true) // MLS-compliant - MANDATORY
  includeCoBranded Boolean @default(false)

  // Agent/Brokerage branding info
  agentName        String?
  agentTitle       String?
  agentPhone       String?
  agentEmail       String?
  agentPhotoUrl    String?
  agentLicenseNo   String?
  brokerageName    String?
  brokerageLogo    String?
  brokeragePhone   String?
  brokerageAddress String?

  // Custom colors (overrides template)
  primaryColor   String?
  secondaryColor String?
  accentColor    String?

  // Custom fonts
  headingFont String?
  bodyFont    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  propertyWebsite PropertyWebsite? @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assets          MarketingAsset[]

  @@index([organizationId])
  @@index([propertyWebsiteId])
}

// Reusable marketing templates
model MarketingTemplate {
  id             String  @id @default(cuid())
  organizationId String? // null = system template

  // Template info
  name         String
  description  String?
  type         MarketingAssetType
  style        SocialTileStyle    @default(modern)
  thumbnailUrl String?

  // Template definition
  canvasWidth  Int
  canvasHeight Int
  templateData Json // Full editor state/layers

  // Categorization
  category String? // "social", "print", "video", "email"
  tags     String[]
  isSystem Boolean  @default(false) // Built-in template
  isPublic Boolean  @default(false) // Available to all orgs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assets       MarketingAsset[]

  @@index([organizationId])
  @@index([type])
  @@index([style])
  @@index([isSystem])
}

// ============================================================================
// AUDIO LIBRARY
// ============================================================================

model AudioTrack {
  id             String  @id @default(cuid())
  organizationId String? // null = system library

  // Track info
  name        String
  description String?
  fileUrl     String
  duration    Int // seconds
  waveformUrl String? // Visual waveform image

  // Metadata
  source     AudioSource @default(library)
  genre      String?
  mood       String? // "upbeat", "calm", "dramatic", etc.
  tempo      Int? // BPM
  isLoopable Boolean     @default(false)

  // Licensing
  licenseType String? // "royalty_free", "creative_commons", "custom"
  licenseUrl  String?
  attribution String?

  // Categorization
  tags     String[]
  isSystem Boolean  @default(false)
  isPublic Boolean  @default(true)

  createdAt DateTime @default(now())

  // Relations
  organization Organization?    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assets       MarketingAsset[]

  @@index([organizationId])
  @@index([source])
  @@index([genre])
  @@index([mood])
}

// ============================================================================
// NEIGHBORHOOD & POINTS OF INTEREST
// ============================================================================

model NeighborhoodData {
  id                String @id @default(cuid())
  propertyWebsiteId String @unique

  // Scores (from Walk Score API or manual)
  walkScore    Int?
  bikeScore    Int?
  transitScore Int?
  soundScore   Int? // Noise level score

  // Crime data
  crimeIndex       Float? // Relative crime index
  crimeDataSource  String?
  crimeLastUpdated DateTime?

  // School ratings
  nearestElementaryRating Float?
  nearestMiddleRating     Float?
  nearestHighRating       Float?

  // Cached at
  lastFetched DateTime @default(now())

  // Relations
  propertyWebsite  PropertyWebsite   @relation(fields: [propertyWebsiteId], references: [id], onDelete: Cascade)
  pointsOfInterest PointOfInterest[]
}

model PointOfInterest {
  id                 String @id @default(cuid())
  neighborhoodDataId String

  // POI info
  name        String
  category    POICategory
  subcategory String?

  // Location
  latitude  Float
  longitude Float
  address   String?

  // Distance from property
  distanceMiles Float
  drivingMins   Int?
  walkingMins   Int?
  transitMins   Int?

  // Additional info
  rating      Float? // Google/Yelp rating
  reviewCount Int?
  priceLevel  Int? // 1-4 for restaurants
  website     String?
  phone       String?
  photoUrl    String?

  // School-specific
  schoolGrades String? // "K-5", "6-8", etc.
  schoolType   String? // "public", "private", "charter"
  schoolRating Float? // GreatSchools rating
  studentCount Int?

  // Business hours
  hoursJson Json? // { monday: "9am-5pm", ... }
  isOpenNow Boolean?

  createdAt DateTime @default(now())

  // Relations
  neighborhoodData NeighborhoodData @relation(fields: [neighborhoodDataId], references: [id], onDelete: Cascade)

  @@index([neighborhoodDataId])
  @@index([category])
  @@index([distanceMiles])
}

// ============================================================================
// PORTFOLIO WEBSITES
// ============================================================================

model PortfolioWebsite {
  id             String @id @default(cuid())
  organizationId String

  name        String
  slug        String  @unique
  description String? @db.Text

  // Hero content (kept for backwards compatibility)
  heroTitle    String?
  heroSubtitle String? @db.Text

  // Portfolio Type & Template
  portfolioType PortfolioType     @default(photographer)
  template      PortfolioTemplate @default(modern)

  // Typography
  fontHeading String?
  fontBody    String?

  // Branding
  logoUrl      String?
  primaryColor String? @default("#3b82f6")
  accentColor  String? @default("#8b5cf6")

  // Social Links (JSON array: [{ platform: string, url: string }])
  socialLinks Json?

  // SEO
  metaTitle       String?
  metaDescription String? @db.Text
  faviconUrl      String?

  // Settings
  isPublished  Boolean @default(false)
  showBranding Boolean @default(true)

  // Custom Domain
  customDomain                  String?   @unique
  customDomainVerified          Boolean   @default(false)
  customDomainVerificationToken String? // DNS TXT record value for verification
  customDomainVerifiedAt        DateTime?
  customDomainSslStatus         String? // pending, active, error

  // Password Protection
  isPasswordProtected Boolean @default(false)
  password            String? // Hashed password

  // Lead Capture Gate
  requireLeadCapture Boolean @default(false)
  leadCaptureMessage String? @db.Text // Custom message shown on gate
  leadCaptureFields  Json? // Array of field configs: [{ name, label, type, required }]

  // Expiration
  expiresAt DateTime?

  // Scheduled Publishing
  scheduledPublishAt DateTime? // Auto-publish at this date/time

  // Download Settings
  allowDownloads    Boolean @default(false)
  downloadWatermark Boolean @default(true) // Apply watermark to downloads

  // Custom CSS
  customCss String? @db.Text

  // Scroll Animations
  enableAnimations Boolean @default(true)

  // Comments
  allowComments       Boolean @default(false)
  requireCommentEmail Boolean @default(true) // Require email to leave comment

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  // Relations
  organization Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  projects     PortfolioWebsiteProject[]
  sections     PortfolioWebsiteSection[]
  views        PortfolioWebsiteView[]
  inquiries    PortfolioInquiry[]
  leads        PortfolioLead[]
  comments     PortfolioComment[]
  abTests      PortfolioABTest[]
  customForms  CustomForm[]

  @@index([organizationId])
  @@index([slug])
  @@index([isPublished])
  @@index([portfolioType])
  @@index([expiresAt])
}

// Portfolio website contact form submissions
model PortfolioInquiry {
  id                 String @id @default(cuid())
  portfolioWebsiteId String
  organizationId     String

  // Inquiry details
  name    String
  email   String
  phone   String?
  message String  @db.Text

  // Status tracking
  status LeadStatus @default(new)
  notes  String?    @db.Text

  // Metadata
  source    String? // where they came from
  userAgent String?
  ipAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  portfolioWebsite PortfolioWebsite @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([portfolioWebsiteId])
  @@index([organizationId])
  @@index([status])
  @@index([createdAt])
}

// Website Chat Inquiries (from marketing site chat widget)
model WebsiteChatInquiry {
  id String @id @default(cuid())

  // Contact info (optional for anonymous)
  name  String?
  email String?
  phone String?

  // Message content
  message  String  @db.Text
  category String? // "pricing", "features", "trial", "other"

  // Status tracking
  status LeadStatus @default(new)
  notes  String?    @db.Text

  // Metadata
  source    String? // "marketing_website", "portfolio", etc.
  pageUrl   String? // URL where chat was initiated
  userAgent String?
  ipAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([email])
}

model PortfolioWebsiteProject {
  id                 String @id @default(cuid())
  portfolioWebsiteId String
  projectId          String
  position           Int    @default(0)

  // Relations
  portfolioWebsite PortfolioWebsite @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)
  project          Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([portfolioWebsiteId, projectId])
  @@index([portfolioWebsiteId])
  @@index([projectId])
}

model PortfolioWebsiteSection {
  id                 String @id @default(cuid())
  portfolioWebsiteId String

  // Section Configuration
  sectionType PortfolioSectionType
  position    Int                  @default(0)
  isVisible   Boolean              @default(true)

  // Section Content (JSON - varies by sectionType)
  // Hero: { title, subtitle, backgroundImageUrl, backgroundVideoUrl, ctaText, ctaLink, overlay, alignment }
  // About: { photoUrl, title, content, highlights[] }
  // Gallery: { projectIds[], layout, columns, showProjectNames }
  // Services: { items[{name, description, price, icon}], showPricing }
  // Testimonials: { items[{quote, clientName, clientTitle, photoUrl}], layout }
  // Awards: { items[{title, issuer, year, logoUrl}] }
  // Contact: { showForm, showMap, showSocial, customFields[] }
  // FAQ: { items[{question, answer}] }
  // Text: { content, alignment }
  // Image: { url, alt, caption, layout }
  // Video: { url, autoplay, loop, muted }
  // Spacer: { height }
  // CustomHTML: { html }
  config Json

  // Optional title override for section
  customTitle String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  portfolioWebsite PortfolioWebsite @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)

  @@index([portfolioWebsiteId])
  @@index([position])
}

model PortfolioWebsiteView {
  id                 String @id @default(cuid())
  portfolioWebsiteId String

  // Visitor Info
  visitorId String? // Anonymous visitor ID (cookie-based)
  ipAddress String?
  userAgent String?
  referrer  String?
  country   String?
  city      String?

  // Page Info
  pagePath  String? // Which section/page was viewed
  sessionId String? // Group views into sessions

  // Engagement
  duration    Int? // Time spent in seconds
  scrollDepth Int? // Max scroll depth percentage

  createdAt DateTime @default(now())

  // Relations
  portfolioWebsite PortfolioWebsite @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)

  @@index([portfolioWebsiteId])
  @@index([createdAt])
  @@index([visitorId])
  @@index([sessionId])
}

model PortfolioLead {
  id                 String @id @default(cuid())
  portfolioWebsiteId String
  organizationId     String

  // Lead Info
  email     String
  name      String?
  phone     String?
  company   String?
  message   String? @db.Text
  extraData Json? // Additional custom field data

  // Source tracking
  visitorId String?
  referrer  String?
  country   String?
  city      String?

  createdAt DateTime @default(now())

  // Relations
  portfolioWebsite PortfolioWebsite @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([portfolioWebsiteId])
  @@index([organizationId])
  @@index([email])
  @@index([createdAt])
}

model PortfolioComment {
  id                 String @id @default(cuid())
  portfolioWebsiteId String
  organizationId     String

  // Comment Content
  content   String  @db.Text
  sectionId String? // Optional: which section the comment is on
  projectId String? // Optional: which project/image the comment is on

  // Commenter Info (anonymous)
  authorName  String?
  authorEmail String?

  // Moderation
  isApproved Boolean @default(false)
  isHidden   Boolean @default(false)

  createdAt DateTime @default(now())

  // Relations
  portfolioWebsite PortfolioWebsite @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([portfolioWebsiteId])
  @@index([organizationId])
  @@index([isApproved])
  @@index([createdAt])
}

// ============================================================================
// PORTFOLIO A/B TESTING
// ============================================================================

model PortfolioABTest {
  id                 String @id @default(cuid())
  portfolioWebsiteId String
  organizationId     String

  // Test Configuration
  name        String
  description String?               @db.Text
  status      PortfolioABTestStatus @default(draft)

  // Traffic Split (percentages, must add up to 100)
  controlTrafficPercent Int @default(50)
  variantTrafficPercent Int @default(50)

  // Variant Settings (what's different in the variant)
  variantHeroTitle    String?            @db.Text
  variantHeroSubtitle String?            @db.Text
  variantPrimaryColor String?
  variantTemplate     PortfolioTemplate?

  // Goals
  goalType        ABTestGoalType @default(views)
  targetMetric    Int? // Target number to reach
  confidenceLevel Float          @default(0.95) // Statistical confidence required

  // Timing
  startDate DateTime?
  endDate   DateTime?

  // Results (cached for performance)
  controlViews       Int     @default(0)
  controlConversions Int     @default(0)
  variantViews       Int     @default(0)
  variantConversions Int     @default(0)
  winningVariant     String? // "control" or "variant" once determined

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  portfolioWebsite PortfolioWebsite   @relation(fields: [portfolioWebsiteId], references: [id], onDelete: Cascade)
  organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignments      ABTestAssignment[]

  @@index([portfolioWebsiteId])
  @@index([organizationId])
  @@index([status])
}

model ABTestAssignment {
  id        String @id @default(cuid())
  testId    String
  visitorId String

  // Assignment
  variant   String // "control" or "variant"
  converted Boolean @default(false)

  createdAt   DateTime  @default(now())
  convertedAt DateTime?

  // Relations
  test PortfolioABTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  @@unique([testId, visitorId])
  @@index([testId])
  @@index([visitorId])
}

enum PortfolioABTestStatus {
  draft
  running
  paused
  completed
}

enum ABTestGoalType {
  views // Total page views
  unique_visitors // Unique visitor count
  time_on_page // Average time spent
  scroll_depth // Average scroll depth
  inquiries // Contact form submissions
  leads // Lead captures
}

// ============================================================================
// CUSTOM FORM BUILDER
// ============================================================================

model CustomForm {
  id                 String  @id @default(cuid())
  portfolioWebsiteId String?
  organizationId     String

  // Form Settings
  name        String
  description String? @db.Text
  slug        String  @unique // URL-friendly identifier

  // Appearance
  submitButtonText String  @default("Submit")
  successMessage   String  @default("Thank you for your submission!")
  redirectUrl      String? // Optional redirect after submission

  // Behavior
  isActive           Boolean @default(true)
  requiresAuth       Boolean @default(false)
  maxSubmissions     Int? // Limit total submissions
  submissionsPerUser Int? // Limit per visitor

  // Notifications
  sendEmailOnSubmission Boolean @default(true)
  notificationEmails    String? @db.Text // Comma-separated emails

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  portfolioWebsite PortfolioWebsite? @relation(fields: [portfolioWebsiteId], references: [id], onDelete: SetNull)
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fields           CustomFormField[]
  submissions      FormSubmission[]

  @@index([portfolioWebsiteId])
  @@index([organizationId])
  @@index([slug])
  @@index([isActive])
}

model CustomFormField {
  id     String @id @default(cuid())
  formId String

  // Field Configuration
  name        String // Internal field name
  label       String // Display label
  type        CustomFormFieldType
  placeholder String?
  helpText    String?

  // Validation
  isRequired   Boolean @default(false)
  minLength    Int?
  maxLength    Int?
  pattern      String? // Regex pattern for validation
  patternError String? // Custom error message for pattern mismatch

  // Options (for select, radio, checkbox)
  options Json? // Array of { label: string, value: string }

  // Layout
  position Int    @default(0)
  width    String @default("full") // "full", "half", "third"

  // Conditional Logic
  conditionalLogic Json? // { showWhen: { field: string, operator: string, value: string } }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  form CustomForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([position])
}

model FormSubmission {
  id     String @id @default(cuid())
  formId String

  // Submission Data
  data      Json // All field values
  ipAddress String?
  userAgent String?
  visitorId String?

  // Geolocation
  country String?
  city    String?

  // Status
  isRead     Boolean   @default(false)
  isArchived Boolean   @default(false)
  readAt     DateTime?

  createdAt DateTime @default(now())

  // Relations
  form CustomForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([isRead])
  @@index([isArchived])
  @@index([createdAt])
}

enum CustomFormFieldType {
  text
  email
  phone
  number
  textarea
  select
  multiselect
  radio
  checkbox
  date
  time
  datetime
  url
  file
  hidden
  heading // Display-only heading
  paragraph // Display-only text
  divider // Visual separator
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

model TaskBoard {
  id             String @id @default(cuid())
  organizationId String

  name        String
  description String?
  color       String? // Board color for visual distinction
  icon        String? // Icon name (emoji or icon key)
  isDefault   Boolean @default(false) // Default board for org
  isArchived  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  columns         TaskColumn[]
  tasks           Task[]
  taskAutomations TaskAutomation[]
  recurringTasks  RecurringTask[]

  @@index([organizationId])
  @@index([isArchived])
}

model TaskColumn {
  id      String @id @default(cuid())
  boardId String

  name     String
  color    String? // Column header color
  position Int     @default(0) // Sort order
  limit    Int? // WIP limit (optional)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  board          TaskBoard       @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks          Task[]
  recurringTasks RecurringTask[]

  @@index([boardId])
  @@index([position])
}

model Task {
  id             String  @id @default(cuid())
  organizationId String
  boardId        String
  columnId       String
  assigneeId     String? // Assigned team member (User id)

  // Core task fields
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  position    Int          @default(0) // Sort order within column

  // Dates
  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  // Time tracking (in minutes)
  estimatedMinutes Int?
  actualMinutes    Int?

  // Tags/labels
  tags String[] @default([])

  // Linked entities (optional - task can link to any of these)
  clientId          String?
  projectId         String? // Gallery/Project
  bookingId         String?
  invoiceId         String?
  propertyWebsiteId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  board           TaskBoard        @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column          TaskColumn       @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignee        User?            @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  client          Client?          @relation(fields: [clientId], references: [id], onDelete: SetNull)
  project         Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  booking         Booking?         @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  invoice         Invoice?         @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  propertyWebsite PropertyWebsite? @relation(fields: [propertyWebsiteId], references: [id], onDelete: SetNull)
  subtasks        TaskSubtask[]
  comments        TaskComment[]
  taskTimeEntries TaskTimeEntry[]

  // Task dependencies (self-referential many-to-many)
  blockedByTasks Task[] @relation("TaskDependencies")
  blocksTasks    Task[] @relation("TaskDependencies")

  @@index([organizationId])
  @@index([boardId])
  @@index([columnId])
  @@index([assigneeId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([clientId])
  @@index([projectId])
  @@index([bookingId])
}

model TaskSubtask {
  id     String @id @default(cuid())
  taskId String

  title       String
  isCompleted Boolean @default(false)
  position    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskComment {
  id       String @id @default(cuid())
  taskId   String
  authorId String

  content String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([authorId])
}

model TaskTemplate {
  id             String @id @default(cuid())
  organizationId String

  // Template metadata
  name        String
  description String? // Description for the template itself
  category    String? // Category for organization (e.g., "Gallery Delivery", "Post-Production")
  icon        String? // Emoji or icon key
  isGlobal    Boolean @default(false) // System templates vs org templates

  // Template content (applied to new tasks)
  taskTitle        String // Template for task title (can include placeholders)
  taskDescription  String? // Template for task description
  priority         TaskPriority @default(medium)
  tags             String[]     @default([])
  estimatedMinutes Int?

  // Default subtasks (stored as JSON array)
  subtasks Json? // [{title: string, position: number}]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([category])
  @@index([isGlobal])
}

// Task Automation Rules
model TaskAutomation {
  id             String @id @default(cuid())
  organizationId String
  boardId        String

  name        String
  description String?
  isActive    Boolean @default(true)

  // Trigger conditions (JSON)
  // e.g., { "type": "subtasks_complete" } or { "type": "status_change", "from": "todo", "to": "in_progress" }
  trigger Json

  // Actions to perform (JSON array)
  // e.g., [{ "type": "move_to_column", "columnId": "xyz" }, { "type": "assign", "assigneeId": "abc" }]
  actions Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  board        TaskBoard    @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([boardId])
  @@index([isActive])
}

// Recurring Task Configuration
model RecurringTask {
  id             String @id @default(cuid())
  organizationId String
  boardId        String
  columnId       String // Column to create task in

  // Template data
  title            String
  description      String?
  priority         TaskPriority @default(medium)
  tags             String[]     @default([])
  estimatedMinutes Int?
  assigneeId       String? // Default assignee

  // Recurrence settings
  frequency  String // "daily", "weekly", "monthly", "custom"
  interval   Int    @default(1) // Every N days/weeks/months
  daysOfWeek Int[]  @default([]) // 0-6 for weekly (0=Sunday)
  dayOfMonth Int? // 1-31 for monthly
  time       String @default("09:00") // HH:MM when to create

  // Next occurrence
  nextRunAt DateTime?
  lastRunAt DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  board        TaskBoard    @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column       TaskColumn   @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignee     User?        @relation(fields: [assigneeId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([boardId])
  @@index([nextRunAt])
  @@index([isActive])
}

// Time Tracking Entries (separate from task's total)
model TaskTimeEntry {
  id     String @id @default(cuid())
  taskId String
  userId String

  startedAt DateTime
  endedAt   DateTime?
  minutes   Int? // Calculated or manual

  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([startedAt])
}

// ============================================================================
// PRODUCT PHOTOGRAPHY MODULE
// ============================================================================

model ProductCatalog {
  id             String @id @default(cuid())
  organizationId String

  name        String
  description String?
  status      ProductCatalogStatus @default(planning)
  tags        String[]             @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  products     ProductItem[]

  @@index([organizationId])
  @@index([status])
}

model ProductItem {
  id        String        @id @default(cuid())
  catalogId String
  sku       String
  name      String
  category  String?
  status    ProductStatus @default(pending)
  angles    String[]      @default([])
  notes     String?
  priority  Int?          @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  catalog  ProductCatalog   @relation(fields: [catalogId], references: [id], onDelete: Cascade)
  variants ProductVariant[]
  photos   ProductPhoto[]

  @@unique([catalogId, sku])
  @@index([catalogId])
  @@index([status])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  skuSuffix String?
  name      String?
  color     String?
  size      String?
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product ProductItem    @relation(fields: [productId], references: [id], onDelete: Cascade)
  photos  ProductPhoto[]

  @@index([productId])
}

model ProductPhoto {
  id           String             @id @default(cuid())
  productId    String
  variantId    String?
  assetId      String
  angle        String
  isPrimary    Boolean            @default(false)
  status       ProductPhotoStatus @default(raw)
  version      Int                @default(1)
  retouchNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product ProductItem     @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  asset   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@index([assetId])
  @@index([status])
}

// ============================================================================
// DISCOUNT CODES
// ============================================================================

model DiscountCode {
  id             String       @id @default(cuid())
  organizationId String
  code           String // The actual code (e.g., "SUMMER20")
  description    String? // Internal description
  discountType   DiscountType @default(percentage)
  discountValue  Int // Percentage (0-100) or cents for fixed_amount

  // Limits
  maxUses     Int? @default(0) // 0 = unlimited
  usedCount   Int  @default(0)
  minPurchase Int? @default(0) // Minimum purchase in cents
  maxDiscount Int? // Maximum discount in cents (for percentage discounts)

  // Validity
  validFrom  DateTime  @default(now())
  validUntil DateTime?
  isActive   Boolean   @default(true)

  // Scope - which things this code applies to
  applicableServices String[] @default([]) // Empty = all services
  applicableClients  String[] @default([]) // Empty = all clients

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usages       DiscountCodeUsage[]

  // Phase 1: Ordering System relations
  orders Order[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([code])
  @@index([isActive])
}

model DiscountCodeUsage {
  id             String  @id @default(cuid())
  discountCodeId String
  invoiceId      String?
  paymentId      String?
  clientEmail    String?

  discountAmount Int // Amount discounted in cents

  createdAt DateTime @default(now())

  // Relations
  discountCode DiscountCode @relation(fields: [discountCodeId], references: [id], onDelete: Cascade)

  @@index([discountCodeId])
  @@index([invoiceId])
}

// ============================================================================
// PAYMENT PLANS
// ============================================================================

model PaymentPlan {
  id             String  @id @default(cuid())
  organizationId String
  invoiceId      String?
  projectId      String?
  clientId       String?

  // Plan details
  totalAmount  Int // Total amount in cents
  installments Int // Number of installments (e.g., 3, 6, 12)
  paidAmount   Int @default(0) // Amount paid so far

  status PaymentPlanStatus @default(active)

  // Schedule
  startDate   DateTime
  frequency   String    @default("monthly") // "weekly", "biweekly", "monthly"
  nextDueDate DateTime?

  // Stripe
  stripeSubscriptionId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization      Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scheduledPayments PaymentPlanInstallment[]

  @@index([organizationId])
  @@index([invoiceId])
  @@index([clientId])
  @@index([status])
}

model PaymentPlanInstallment {
  id            String @id @default(cuid())
  paymentPlanId String

  amount  Int // Amount in cents
  dueDate DateTime
  paidAt  DateTime?
  isPaid  Boolean   @default(false)

  // Stripe
  stripePaymentIntentId String? @unique

  // Reminders
  reminderSentAt DateTime?

  createdAt DateTime @default(now())

  // Relations
  paymentPlan PaymentPlan @relation(fields: [paymentPlanId], references: [id], onDelete: Cascade)

  @@index([paymentPlanId])
  @@index([dueDate])
  @@index([isPaid])
}

// ============================================================================
// DOWNLOAD TRACKING
// ============================================================================

model DownloadLog {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String
  assetId        String? // Null for batch/zip downloads

  // Download details
  format     DownloadFormat @default(original)
  fileCount  Int            @default(1) // For batch downloads
  totalBytes BigInt?

  // Who downloaded
  clientEmail String?
  sessionId   String?
  ipAddress   String?
  userAgent   String?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([projectId])
  @@index([assetId])
  @@index([clientEmail])
  @@index([createdAt])
}

// ============================================================================
// GALLERY EXPIRATION NOTIFICATIONS
// ============================================================================

model ExpirationNotification {
  id        String @id @default(cuid())
  projectId String

  // Notification schedule
  daysBeforeExpiry Int // 7, 3, 1, etc.
  sentAt           DateTime?

  // Email details
  recipientEmail String
  emailType      String @default("expiry_warning") // "expiry_warning", "expired", "extended"

  createdAt DateTime @default(now())

  @@unique([projectId, daysBeforeExpiry])
  @@index([projectId])
  @@index([sentAt])
}

// ============================================================================
// INVOICE BRANDING TEMPLATES (Visual styling for invoices)
// ============================================================================

model InvoiceBrandingTemplate {
  id             String @id @default(cuid())
  organizationId String

  name      String
  isDefault Boolean @default(false)

  // Branding
  logoPosition String @default("left") // "left", "center", "right"
  primaryColor String @default("#3b82f6")
  accentColor  String @default("#8b5cf6")

  // Content
  headerText   String?
  footerText   String?
  paymentTerms String? // e.g., "Net 30", "Due on Receipt"
  notes        String?

  // Styling
  fontFamily      String  @default("Inter")
  showLogo        Boolean @default(true)
  showPaymentLink Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// ============================================================================
// INVOICE EMAIL TEMPLATES (Customizable email content for invoices)
// ============================================================================

enum InvoiceEmailType {
  invoice_created // When invoice is first created
  invoice_sent // When invoice is sent to client
  invoice_reminder // Payment reminder
  invoice_overdue // Overdue notice
  invoice_paid // Payment confirmation
  invoice_partial // Partial payment received
  estimate_sent // Quote/estimate sent
  estimate_approved // Quote approved by client
  estimate_rejected // Quote rejected by client
}

model InvoiceEmailTemplate {
  id             String @id @default(cuid())
  organizationId String

  // Template identification
  name      String
  emailType InvoiceEmailType
  isDefault Boolean          @default(false)
  isActive  Boolean          @default(true)

  // Email content
  subject  String // Supports variables like {{invoiceNumber}}, {{clientName}}
  bodyHtml String  @db.Text // HTML email body
  bodyText String? @db.Text // Plain text fallback

  // Sender customization
  fromName String? // Override sender name
  replyTo  String? // Reply-to email

  // Scheduling options (for reminders)
  sendDelayDays Int? // Days after event to send (e.g., reminder 7 days after due)

  // CC/BCC
  ccEmails  String[] @default([])
  bccEmails String[] @default([])

  // Metadata
  usageCount Int       @default(0)
  lastUsedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, emailType, isDefault])
  @@index([organizationId])
  @@index([emailType])
}

// ============================================================================
// CLIENT PORTAL ACTIVITY
// ============================================================================

model PortalActivity {
  id             String @id @default(cuid())
  organizationId String
  clientId       String

  // Activity details
  activityType String // "gallery_delivered", "invoice_sent", "payment_received", "comment_posted", etc.
  title        String
  description  String?

  // Related entities
  projectId String?
  invoiceId String?
  paymentId String?

  // Read status
  isRead Boolean   @default(false)
  readAt DateTime?

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([clientId])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================================================
// PHASE 1: SCHEDULING & AVAILABILITY
// ============================================================================

model AvailabilityBlock {
  id             String  @id @default(cuid())
  organizationId String
  userId         String? // null = org-wide block

  // Block details
  title       String
  description String?
  blockType   AvailabilityBlockType @default(time_off)

  // Time range
  startDate DateTime
  endDate   DateTime
  allDay    Boolean  @default(true)

  // Recurrence (RRULE format)
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // e.g., "FREQ=WEEKLY;BYDAY=SU"
  recurrenceEnd  DateTime?

  // Time-off request approval workflow
  requestStatus TimeOffRequestStatus @default(approved) // Legacy blocks are auto-approved
  approvedById  String?
  approvedAt    DateTime?
  rejectionNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([startDate])
  @@index([endDate])
  @@index([requestStatus])
}

model BookingBuffer {
  id             String  @id @default(cuid())
  organizationId String
  serviceId      String? // null = org-wide default

  // Buffer times in minutes
  bufferBefore Int @default(0) // Setup time before booking
  bufferAfter  Int @default(0) // Teardown time after booking

  // Minimum booking window
  minAdvanceHours Int? // Minimum hours in advance to book
  maxAdvanceDays  Int? // Maximum days in advance to book

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, serviceId])
  @@index([organizationId])
  @@index([serviceId])
}

// ============================================================================
// PHASE 1: PUBLIC BOOKING FORMS
// ============================================================================

enum FormFieldType {
  text
  textarea
  email
  phone
  number
  date
  time
  datetime
  select
  multiselect
  checkbox
  radio
  file
  address
  url
}

enum BookingFormSubmissionStatus {
  pending
  approved
  rejected
  converted
  expired
}

model BookingForm {
  id             String @id @default(cuid())
  organizationId String

  // Form identity
  name        String
  slug        String
  description String?

  // Industry-specific form (optional)
  industry Industry?

  // Publishing
  isPublished Boolean @default(false)
  isDefault   Boolean @default(false) // Default form for the org

  // Branding overrides (like OrderPage)
  headline        String?
  subheadline     String?
  heroImageUrl    String?
  logoOverrideUrl String?
  primaryColor    String?

  // Booking settings
  requireApproval   Boolean @default(true) // Auto-confirm or require admin approval
  confirmationEmail Boolean @default(true)

  // Analytics
  viewCount    Int @default(0)
  bookingCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fields       BookingFormField[]
  services     BookingFormService[]
  submissions  BookingFormSubmission[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@index([isPublished])
}

model BookingFormField {
  id            String @id @default(cuid())
  bookingFormId String

  // Field configuration
  label       String
  type        FormFieldType
  placeholder String?
  helpText    String?
  isRequired  Boolean       @default(false)
  sortOrder   Int           @default(0)

  // Industry-specific: only show for certain industries
  industries Industry[]

  // Validation rules (JSON: { minLength, maxLength, pattern, min, max, options })
  validation Json?

  // Conditional visibility
  conditionalOn    String? // Field ID this depends on
  conditionalValue String? // Value that triggers display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookingForm BookingForm @relation(fields: [bookingFormId], references: [id], onDelete: Cascade)

  @@index([bookingFormId])
  @@index([sortOrder])
}

model BookingFormService {
  id            String  @id @default(cuid())
  bookingFormId String
  serviceId     String
  sortOrder     Int     @default(0)
  isDefault     Boolean @default(false) // Pre-selected on form

  bookingForm BookingForm @relation(fields: [bookingFormId], references: [id], onDelete: Cascade)
  service     Service     @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([bookingFormId, serviceId])
  @@index([bookingFormId])
  @@index([serviceId])
}

model BookingFormSubmission {
  id            String  @id @default(cuid())
  bookingFormId String
  bookingId     String? @unique // Linked once converted to booking

  // Submitted data
  data Json // All field values as key-value pairs

  // Client info (extracted from data for convenience)
  clientName  String?
  clientEmail String?
  clientPhone String?

  // Scheduling preference
  preferredDate DateTime?
  preferredTime String?

  // Selected service
  serviceId String?

  // Status
  status BookingFormSubmissionStatus @default(pending)

  // Conversion tracking
  convertedAt   DateTime?
  convertedBy   String? // User ID who converted
  rejectedAt    DateTime?
  rejectionNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookingForm BookingForm @relation(fields: [bookingFormId], references: [id], onDelete: Cascade)
  booking     Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([bookingFormId])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// PHASE 1: CLIENT CRM ENHANCEMENTS
// ============================================================================

model ClientCommunication {
  id       String @id @default(cuid())
  clientId String

  // Communication details
  type      CommunicationType
  direction CommunicationDirection
  subject   String?
  content   String                 @db.Text

  // Metadata
  sentAt DateTime?
  readAt DateTime?

  // Who logged this
  createdById String?

  // Related entities
  bookingId String?
  projectId String?
  invoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
  @@index([createdAt])
}

model ClientTag {
  id             String @id @default(cuid())
  organizationId String

  name        String
  color       String  @default("#6366f1")
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clients ClientTagAssignment[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model ClientTagAssignment {
  id       String @id @default(cuid())
  clientId String
  tagId    String

  createdAt DateTime @default(now())

  // Relations
  client Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tag    ClientTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([clientId, tagId])
  @@index([clientId])
  @@index([tagId])
}

// ============================================================================
// PHASE 1: CONTRACT E-SIGNATURE ENHANCEMENTS
// ============================================================================

model ContractSignature {
  id         String @id @default(cuid())
  contractId String
  signerId   String // ContractSigner id

  // Signature data
  signatureData String        @db.Text // Base64 encoded signature image
  signatureType SignatureType @default(drawn)

  // Verification
  signedAt  DateTime @default(now())
  ipAddress String?
  userAgent String?

  // Legal compliance
  consentGiven Boolean @default(true)
  consentText  String? @db.Text

  createdAt DateTime @default(now())

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([signerId])
}

// ============================================================================
// PHASE 1: CALENDAR INTEGRATIONS
// ============================================================================

model CalendarIntegration {
  id             String  @id @default(cuid())
  organizationId String
  userId         String? // User-specific or org-wide

  // Provider details
  provider   CalendarProvider
  externalId String // Calendar ID from provider
  name       String // Display name

  // OAuth tokens
  accessToken    String    @db.Text
  refreshToken   String?   @db.Text
  tokenExpiresAt DateTime?

  // Sync settings
  syncEnabled   Boolean       @default(true)
  syncDirection SyncDirection @default(both)
  lastSyncAt    DateTime?
  lastSyncError String?

  // Color mapping
  color String @default("#3b82f6")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, provider, externalId])
  @@index([organizationId])
  @@index([userId])
  @@index([provider])
}

model CalendarEvent {
  id                    String @id @default(cuid())
  calendarIntegrationId String

  // External reference
  externalEventId String

  // Event details (cached from provider)
  title       String
  description String?  @db.Text
  startTime   DateTime
  endTime     DateTime
  allDay      Boolean  @default(false)
  location    String?

  // Link to internal booking (if synced)
  bookingId String? @unique

  // Sync metadata
  lastSyncedAt DateTime @default(now())
  etag         String? // For change detection

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([calendarIntegrationId, externalEventId])
  @@index([calendarIntegrationId])
  @@index([bookingId])
  @@index([startTime])
}

// iCal feed export for external calendar subscriptions
model CalendarFeed {
  id             String  @id @default(cuid())
  organizationId String
  userId         String? // User-specific feed (null = org-wide)

  // Feed identification
  token    String @unique // Unique token for feed URL
  name     String @default("Bookings") // Display name for the feed
  timezone String @default("America/New_York")

  // Status
  isActive Boolean @default(true)

  // Access tracking
  lastAccessedAt DateTime?
  accessCount    Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation("UserCalendarFeeds", fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([token])
}

// ============================================================================
// SPIRO FEATURE PARITY - PHASE 1: ORDERING SYSTEM & PRODUCT BUNDLES
// ============================================================================

enum OrderStatus {
  cart // Items added, not submitted
  pending // Submitted, awaiting payment
  paid // Payment received
  processing // Being worked on
  completed // Delivered
  cancelled // Cancelled by client or admin
}

enum BundleType {
  fixed // Fixed set of services at fixed price
  tiered // Pick X services from a group
  custom // Build your own
  sqft_based // Price based on square footage (price per sqft)
  tiered_sqft // Tiered pricing by square footage ranges (BICEP pricing)
}

enum BundlePricingMethod {
  fixed // Single fixed price
  per_sqft // Price per square foot
  tiered // Price based on sqft tiers
}

enum AddonTrigger {
  always // Always show
  with_service // Show when specific service selected
  cart_threshold // Show when cart > X amount
}

// ============================================================================
// SERVICE BUNDLES (Package services together with bundle pricing)
// ============================================================================

model ServiceBundle {
  id             String @id @default(cuid())
  organizationId String

  // Bundle info
  name        String
  slug        String
  description String?    @db.Text
  priceCents  Int // Bundle price (for fixed pricing)
  bundleType  BundleType @default(fixed)

  // Pricing method (allows user to choose between pricing strategies)
  pricingMethod BundlePricingMethod @default(fixed)

  // Square footage pricing (for sqft_based and tiered_sqft bundles)
  pricePerSqftCents Int? @default(0) // Price per sqft for sqft_based pricing
  minSqft           Int? @default(0) // Minimum sqft (floor for pricing)
  maxSqft           Int? // Maximum sqft (optional ceiling)
  sqftIncrements    Int? @default(500) // Round to nearest X sqft (e.g., 500)

  // Display
  imageUrl  String?
  badgeText String? // "Most Popular", "Best Value"
  sortOrder Int     @default(0)

  // Savings display
  originalPriceCents Int? // Sum of individual services (for savings display)
  savingsPercent     Float? // Calculated savings percentage

  // Settings
  isActive Boolean @default(true)
  isPublic Boolean @default(true) // Show on public order pages

  // Stripe Product Catalog sync
  stripeProductId String? // Stripe Product ID (prod_xxx)
  stripePriceId   String? // Stripe Price ID (price_xxx)
  stripeSyncedAt  DateTime? // Last successful sync timestamp

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  services     ServiceBundleItem[] // Services included in bundle
  pricingTiers BundlePricingTier[] // Tiered pricing tiers (for tiered_sqft)
  orderPages   OrderPageBundle[] // Order pages featuring this bundle
  orderItems   OrderItem[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([isActive, isPublic])
}

model ServiceBundleItem {
  id        String @id @default(cuid())
  bundleId  String
  serviceId String

  // For tiered bundles: is this required or optional?
  isRequired Boolean @default(true)
  quantity   Int     @default(1)
  sortOrder  Int     @default(0)

  // Relations
  bundle  ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  service Service       @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([bundleId, serviceId])
  @@index([bundleId])
  @@index([serviceId])
}

// Pricing tiers for tiered_sqft bundles (BICEP-style pricing)
model BundlePricingTier {
  id       String @id @default(cuid())
  bundleId String

  // Tier range (e.g., 0-2000 sqft, 2001-3500 sqft, etc.)
  minSqft Int // Minimum sqft for this tier (inclusive)
  maxSqft Int? // Maximum sqft for this tier (null = unlimited)

  // Tier pricing
  priceCents Int // Fixed price for this tier
  tierName   String? // Optional display name (e.g., "Small Home", "Medium Home")

  sortOrder Int @default(0)

  // Relations
  bundle ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@unique([bundleId, minSqft])
  @@index([bundleId])
}

// ============================================================================
// SERVICE ADDONS (Cross-sells/Upsells)
// ============================================================================

model ServiceAddon {
  id             String @id @default(cuid())
  organizationId String

  // Addon info
  name        String
  description String?
  priceCents  Int

  // Display
  imageUrl  String?
  iconName  String? // Icon identifier
  sortOrder Int     @default(0)

  // Trigger conditions
  triggerType  AddonTrigger @default(always)
  triggerValue String? // Service ID or amount threshold

  // Settings
  isActive  Boolean @default(true)
  isOneTime Boolean @default(true) // Can only add once

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  compatibleWith ServiceAddonCompat[] // Services this addon works with
  orderItems     OrderItem[]

  @@index([organizationId])
  @@index([isActive])
}

model ServiceAddonCompat {
  id        String @id @default(cuid())
  addonId   String
  serviceId String

  addon   ServiceAddon @relation(fields: [addonId], references: [id], onDelete: Cascade)
  service Service      @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([addonId, serviceId])
  @@index([addonId])
  @@index([serviceId])
}

// ============================================================================
// ORDER PAGES (Custom branded landing pages)
// ============================================================================

model OrderPage {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String? // Optional: dedicated page for specific client
  brokerageId    String? // Optional: dedicated page for specific brokerage

  // Page info
  name String
  slug String

  // Branding overrides
  headline        String?
  subheadline     String?
  heroImageUrl    String?
  logoOverrideUrl String? // Override org logo for this page
  primaryColor    String? // Override org primary color

  // Contact info display
  showPhone   Boolean @default(true)
  showEmail   Boolean @default(true)
  customPhone String?
  customEmail String?

  // Template/Layout
  template String @default("default") // "default", "minimal", "luxury"

  // SEO
  metaTitle       String?
  metaDescription String?

  // Settings
  isPublished  Boolean @default(false)
  requireLogin Boolean @default(false) // Require client portal login

  // Testimonials/social proof
  testimonials Json? // Array of { name, company, quote, photoUrl }

  // Analytics
  viewCount  Int @default(0)
  orderCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?            @relation(fields: [clientId], references: [id], onDelete: SetNull)
  brokerage    Brokerage?         @relation("BrokerageOrderPages", fields: [brokerageId], references: [id], onDelete: SetNull)
  bundles      OrderPageBundle[]
  services     OrderPageService[]
  orders       Order[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([clientId])
  @@index([brokerageId])
  @@index([isPublished])
}

model OrderPageBundle {
  id          String  @id @default(cuid())
  orderPageId String
  bundleId    String
  sortOrder   Int     @default(0)
  isFeatured  Boolean @default(false) // Highlight as recommended

  orderPage OrderPage     @relation(fields: [orderPageId], references: [id], onDelete: Cascade)
  bundle    ServiceBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@unique([orderPageId, bundleId])
  @@index([orderPageId])
}

model OrderPageService {
  id          String @id @default(cuid())
  orderPageId String
  serviceId   String
  sortOrder   Int    @default(0)

  orderPage OrderPage @relation(fields: [orderPageId], references: [id], onDelete: Cascade)
  service   Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([orderPageId, serviceId])
  @@index([orderPageId])
}

// ============================================================================
// ORDERS (Shopping Cart / Pre-Invoice)
// ============================================================================

model Order {
  id             String  @id @default(cuid())
  organizationId String
  orderPageId    String? // Which order page it came from
  clientId       String? // Linked client (if known)

  // Order reference
  orderNumber String // e.g., "ORD-2025-0001"
  status      OrderStatus @default(cart)

  // Totals (in cents)
  subtotalCents Int @default(0)
  discountCents Int @default(0)
  taxCents      Int @default(0)
  totalCents    Int @default(0)

  // Discount code applied
  discountCodeId String?

  // Client info (for guest checkout)
  clientName    String?
  clientEmail   String?
  clientPhone   String?
  clientCompany String?

  // Property/Shoot location
  locationId    String?
  locationNotes String?

  // Scheduling preference
  preferredDate DateTime?
  preferredTime String? // "morning", "afternoon", "evening"
  flexibleDates Boolean   @default(true)

  // Notes
  clientNotes   String? @db.Text
  internalNotes String? @db.Text

  // Session token for guest checkout
  sessionToken String? @unique

  // Payment
  paidAt        DateTime?
  paymentMethod String?

  // Stripe
  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String? @unique

  // Conversion tracking
  source   String? // utm_source
  medium   String? // utm_medium
  campaign String? // utm_campaign

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime? // When cart was submitted

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orderPage    OrderPage?    @relation(fields: [orderPageId], references: [id], onDelete: SetNull)
  client       Client?       @relation(fields: [clientId], references: [id], onDelete: SetNull)
  location     Location?     @relation(fields: [locationId], references: [id], onDelete: SetNull)
  discountCode DiscountCode? @relation(fields: [discountCodeId], references: [id], onDelete: SetNull)
  items        OrderItem[]
  invoice      Invoice?      @relation("OrderInvoice")
  booking      Booking?      @relation("OrderBooking")

  @@unique([organizationId, orderNumber])
  @@index([organizationId])
  @@index([orderPageId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String

  // Item type
  itemType  String // "service", "bundle", "addon"
  serviceId String?
  bundleId  String?
  addonId   String?

  // Details
  name        String
  description String?
  quantity    Int     @default(1)
  unitCents   Int
  totalCents  Int

  // Square footage (for sqft-based bundle pricing)
  sqft            Int? // Square footage entered by client
  pricingTierId   String? // Which pricing tier was applied (for tiered_sqft)
  pricingTierName String? // Tier name at time of order (snapshot)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  // Relations
  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  service Service?       @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  bundle  ServiceBundle? @relation(fields: [bundleId], references: [id], onDelete: SetNull)
  addon   ServiceAddon?  @relation(fields: [addonId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([serviceId])
  @@index([bundleId])
}

// ============================================================================
// SPIRO FEATURE PARITY - PHASE 2: BROKERAGE & ENTERPRISE FEATURES
// ============================================================================

enum PayoutStatus {
  pending // Scheduled but not processed
  processing // Being sent via Stripe
  completed // Successfully paid
  failed // Payment failed
  cancelled // Cancelled before processing
}

enum InvoiceSplitType {
  single // Standard single invoice
  split // One invoice with line items assigned to agent/brokerage
  dual // Two separate invoices generated
}

enum EarningStatus {
  pending // Booking not yet completed
  approved // Ready for payout
  paid // Included in a payout
  disputed // Under review
}

// ============================================================================
// BROKERAGES (Parent company with multiple agents)
// ============================================================================

model Brokerage {
  id             String @id @default(cuid())
  organizationId String

  // Brokerage info
  name    String
  slug    String
  email   String?
  phone   String?
  website String?

  // Address
  address String?
  city    String?
  state   String?
  zipCode String?

  // Branding
  logoUrl      String?
  primaryColor String?

  // Primary contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Settings
  isActive Boolean @default(true)

  // Analytics (denormalized)
  totalRevenueCents Int @default(0)
  activeAgentCount  Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agents             Client[]            @relation("BrokerageAgents")
  contracts          BrokerageContract[]
  orderPages         OrderPage[]         @relation("BrokerageOrderPages")
  mlsPresetOverrides MlsPresetOverride[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([isActive])
}

// ============================================================================
// BROKERAGE CONTRACTS (Pricing terms and discounts per brokerage)
// ============================================================================

model BrokerageContract {
  id          String @id @default(cuid())
  brokerageId String

  // Contract details
  name        String
  description String?

  // Pricing terms
  discountPercent    Float? @default(0) // Global discount percentage
  discountFixedCents Int?   @default(0) // Fixed discount amount

  // Per-service pricing overrides (JSON: { serviceId: priceCents })
  servicePricing Json?

  // Payment terms
  paymentTermsDays Int     @default(30) // Net 30, etc.
  autoInvoice      Boolean @default(false) // Auto-create invoices

  // Invoice handling
  invoiceSplitType    InvoiceSplitType @default(single)
  brokeragePayPercent Float? // % brokerage pays (for split invoices)

  // Validity
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brokerage Brokerage @relation(fields: [brokerageId], references: [id], onDelete: Cascade)

  @@index([brokerageId])
  @@index([isActive])
}

// ============================================================================
// MLS DOWNLOAD PRESETS (Image dimensions for MLS providers)
// ============================================================================

// System-wide MLS presets (seed data)
model MlsPreset {
  id             String  @id @default(cuid())
  organizationId String? // Null = system-wide default preset

  // Preset identification
  name        String // e.g., "HAR Standard", "Zillow Large"
  provider    String // e.g., "HAR", "Zillow", "Realtor.com", "NWMLS", "Custom"
  description String?

  // Dimensions
  width  Int // Max width in pixels
  height Int // Max height in pixels

  // Quality settings
  quality        Int     @default(90) // JPEG quality 1-100
  format         String  @default("jpeg") // "jpeg", "png", "webp"
  maxFileSizeKb  Int? // Max file size in KB (optional)
  maintainAspect Boolean @default(true) // Maintain aspect ratio

  // Processing options
  letterbox      Boolean @default(false) // Add padding to reach exact dimensions
  letterboxColor String? @default("#ffffff") // Padding color

  // Metadata
  isSystemPreset Boolean @default(false) // True = app-level default, cannot be deleted
  isActive       Boolean @default(true)
  sortOrder      Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider, name]) // One preset per provider/name per org
  @@index([organizationId])
  @@index([provider])
  @@index([isActive])
}

// Override settings at different levels (brokerage, client)
// This allows hierarchical override: App â Org â Brokerage â Client
model MlsPresetOverride {
  id String @id @default(cuid())

  // Exactly one of these must be set
  brokerageId String?
  clientId    String?

  // The preset being enabled/configured
  presetId String

  // Override settings (null = inherit from parent level)
  enabled   Boolean? // Override whether this preset is available
  isDefault Boolean? // Override whether this is the default preset

  // Custom dimension overrides (null = use preset defaults)
  customWidth     Int?
  customHeight    Int?
  customQuality   Int?
  customMaxSizeKb Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brokerage Brokerage? @relation(fields: [brokerageId], references: [id], onDelete: Cascade)
  client    Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([brokerageId, presetId])
  @@unique([clientId, presetId])
  @@index([brokerageId])
  @@index([clientId])
  @@index([presetId])
}

// ============================================================================
// INVOICE SPLITS (Track split/dual invoice configuration)
// ============================================================================

model InvoiceSplit {
  id             String @id @default(cuid())
  organizationId String

  // Parent invoice
  primaryInvoiceId   String
  secondaryInvoiceId String? // For dual invoices

  // Split type
  splitType InvoiceSplitType

  // Split details
  agentAmountCents     Int @default(0)
  brokerageAmountCents Int @default(0)

  // Line item assignments (JSON: { lineItemId: "agent" | "brokerage" })
  lineItemAssignments Json?

  createdAt DateTime @default(now())

  @@unique([primaryInvoiceId])
  @@index([organizationId])
  @@index([primaryInvoiceId])
  @@index([secondaryInvoiceId])
}

// ============================================================================
// PHOTOGRAPHER RATES (Pay rates per photographer per service)
// ============================================================================

model PhotographerRate {
  id             String  @id @default(cuid())
  organizationId String
  userId         String // Photographer (team member)
  serviceId      String? // Null = default rate for all services

  // Pay structure
  rateType  String @default("percentage") // "percentage", "fixed", "hourly"
  rateValue Int // Percentage (0-100) or cents

  // Minimum/maximum
  minPayCents Int? // Minimum pay per booking
  maxPayCents Int? // Maximum pay per booking

  // Override for specific booking types
  bookingTypeId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, userId, serviceId])
  @@index([organizationId])
  @@index([userId])
  @@index([serviceId])
}

// ============================================================================
// PHOTOGRAPHER EARNINGS (Earnings log per booking)
// ============================================================================

model PhotographerEarning {
  id             String  @id @default(cuid())
  organizationId String
  userId         String // Photographer
  bookingId      String?
  invoiceId      String?

  // Earning details
  description String
  amountCents Int
  status      EarningStatus @default(pending)

  // Calculation source
  rateType        String? // How this was calculated
  rateValue       Int?
  baseAmountCents Int? // What the earning was calculated from

  // Payout reference
  payoutItemId String?

  // Dates
  earnedAt   DateTime  @default(now())
  approvedAt DateTime?
  paidAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payoutItem PayoutItem? @relation(fields: [payoutItemId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([payoutItemId])
}

// ============================================================================
// PAYOUT BATCHES (Scheduled payout batches)
// ============================================================================

model PayoutBatch {
  id             String @id @default(cuid())
  organizationId String

  // Batch info
  batchNumber String // e.g., "PAY-2025-0001"
  status      PayoutStatus @default(pending)

  // Period covered
  periodStart DateTime
  periodEnd   DateTime

  // Totals
  totalAmountCents Int @default(0)
  itemCount        Int @default(0)

  // Processing
  processedAt  DateTime?
  failedReason String?

  // Stripe
  stripeTransferId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        PayoutItem[]

  @@unique([organizationId, batchNumber])
  @@index([organizationId])
  @@index([status])
  @@index([periodStart])
}

model PayoutItem {
  id      String @id @default(cuid())
  batchId String
  userId  String // Recipient photographer

  // Amount
  amountCents Int
  description String?

  // Status
  status       PayoutStatus @default(pending)
  failedReason String?

  // Stripe Connect
  stripeTransferId String?
  stripePayoutId   String?

  // Dates
  processedAt DateTime?
  paidAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  batch    PayoutBatch           @relation(fields: [batchId], references: [id], onDelete: Cascade)
  earnings PhotographerEarning[]

  @@index([batchId])
  @@index([userId])
  @@index([status])
}

// ============================================================================
// SPIRO FEATURE PARITY - PHASE 3: SMS NOTIFICATIONS & FIELD OPERATIONS
// ============================================================================

enum SMSDeliveryStatus {
  queued
  sent
  delivered
  failed
  undelivered
}

enum SMSTemplateType {
  booking_confirmation
  booking_reminder
  photographer_en_route
  photographer_arrived
  gallery_ready
  invoice_sent
  payment_received
  custom
}

enum CheckInType {
  arrival
  departure
  manual
}

enum SlackEventType {
  booking_created
  booking_confirmed
  booking_completed
  payment_received
  gallery_delivered
  new_lead
  custom
}

// Product module enums
enum ProductCatalogStatus {
  planning
  shooting
  editing
  delivered
  archived
}

enum ProductStatus {
  pending
  shot
  edited
  approved
  delivered
  archived
}

enum ProductPhotoStatus {
  raw
  edited
  approved
  rejected
}

// ============================================================================
// SMS TEMPLATES (Customizable SMS message templates)
// ============================================================================

model SMSTemplate {
  id             String @id @default(cuid())
  organizationId String

  // Template info
  name         String
  templateType SMSTemplateType
  content      String          @db.Text // Message with {{variables}}

  // Variables available in this template (for UI)
  availableVariables String[] @default([])

  // Settings
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // System default template

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  smsLogs      SMSLog[]

  @@unique([organizationId, templateType, isDefault])
  @@index([organizationId])
  @@index([templateType])
  @@index([isActive])
}

// ============================================================================
// SMS LOG (Track all sent SMS with delivery status)
// ============================================================================

model SMSLog {
  id             String @id @default(cuid())
  organizationId String

  // Message details
  templateId String?
  toPhone    String
  fromPhone  String
  content    String  @db.Text

  // Twilio tracking
  twilioMessageSid String?           @unique
  deliveryStatus   SMSDeliveryStatus @default(queued)
  errorCode        String?
  errorMessage     String?

  // Related entities
  bookingId String?
  clientId  String?
  userId    String? // Photographer (if sent to team)

  // Delivery timestamps
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template     SMSTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  booking      Booking?     @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([templateId])
  @@index([bookingId])
  @@index([clientId])
  @@index([deliveryStatus])
  @@index([createdAt])
}

// ============================================================================
// BOOKING CHECK-IN (Photographer check-in events)
// ============================================================================

model BookingCheckIn {
  id        String @id @default(cuid())
  bookingId String
  userId    String // Photographer

  // Check-in details
  checkInType CheckInType
  latitude    Float
  longitude   Float
  accuracy    Float? // GPS accuracy in meters

  // Address (reverse geocoded)
  address String?

  // Distance from expected location
  distanceFromLocation Float? // Meters from booking location

  // Photo proof (optional)
  photoUrl String?

  // Notes
  notes String?

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([userId])
  @@index([checkInType])
  @@index([createdAt])
}

// ============================================================================
// LOCATION PING (GPS pings during active booking)
// ============================================================================

model LocationPing {
  id        String @id @default(cuid())
  bookingId String
  userId    String // Photographer

  // Location data
  latitude  Float
  longitude Float
  accuracy  Float? // GPS accuracy in meters
  altitude  Float?
  speed     Float? // meters/second
  heading   Float? // Compass heading

  // Battery level (for monitoring)
  batteryLevel Float?

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================================================
// SLACK INTEGRATION (Slack workspace connection)
// ============================================================================

model SlackIntegration {
  id             String @id @default(cuid())
  organizationId String

  // Slack workspace info
  teamId   String
  teamName String

  // OAuth tokens
  accessToken    String  @db.Text
  botUserId      String?
  botAccessToken String? @db.Text

  // Webhook URL (for incoming messages)
  incomingWebhookUrl String?

  // Settings
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channels     SlackChannel[]

  @@unique([organizationId, teamId])
  @@index([organizationId])
  @@index([teamId])
}

// ============================================================================
// SLACK CHANNEL (Channel routing for events)
// ============================================================================

model SlackChannel {
  id            String @id @default(cuid())
  integrationId String

  // Channel info
  channelId   String
  channelName String

  // Event routing
  eventTypes SlackEventType[]

  // Settings
  isActive    Boolean @default(true)
  mentionHere Boolean @default(false) // @here mentions
  mentionAll  Boolean @default(false) // @channel mentions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  integration SlackIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, channelId])
  @@index([integrationId])
  @@index([channelId])
}

// ============================================================================
// DROPBOX INTEGRATION (Cloud storage sync)
// ============================================================================

model DropboxIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // Dropbox account info
  accountId   String // Dropbox account_id
  email       String
  displayName String

  // OAuth tokens
  accessToken  String  @db.Text
  refreshToken String? @db.Text

  // Sync settings
  syncEnabled Boolean @default(true)
  syncFolder  String  @default("/PhotoProOS") // Root folder in Dropbox
  autoSync    Boolean @default(true) // Auto-sync on file changes

  // Cursor for delta sync
  cursor String? @db.Text

  // Sync status
  lastSyncAt    DateTime?
  lastSyncError String?

  // Settings
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([accountId])
}

// ============================================================================
// QUICKBOOKS INTEGRATION (Accounting sync)
// ============================================================================

model QuickBooksIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // QuickBooks company info
  realmId     String // QuickBooks company ID (realm)
  companyName String

  // OAuth tokens
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  tokenExpiry  DateTime

  // Sync settings
  syncEnabled         Boolean @default(true)
  autoSyncInvoices    Boolean @default(true)
  autoCreateCustomers Boolean @default(true)
  syncFrequency       String  @default("realtime") // realtime, daily, manual

  // Account mappings
  defaultIncomeAccount  String?
  defaultExpenseAccount String?
  taxEnabled            Boolean @default(false)
  defaultTaxCodeId      String?

  // Sync status
  lastSyncAt    DateTime?
  lastSyncError String?

  // Sync cursors for incremental sync
  lastInvoiceSyncAt  DateTime?
  lastCustomerSyncAt DateTime?
  lastPaymentSyncAt  DateTime?

  // Settings
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  syncHistory  QuickBooksSyncHistory[]

  @@index([organizationId])
  @@index([realmId])
}

model QuickBooksSyncHistory {
  id            String @id @default(cuid())
  integrationId String

  // Sync details
  syncType    String // invoice, payment, customer, full
  action      String // created, updated, synced, error
  entityType  String // Invoice, Payment, Customer
  entityId    String? // PhotoProOS entity ID
  qbEntityId  String? // QuickBooks entity ID
  description String

  // Status
  status       String // success, error, skipped
  errorMessage String?

  createdAt DateTime @default(now())

  // Relations
  integration QuickBooksIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([createdAt])
  @@index([syncType])
}

// ============================================================================
// MAILCHIMP INTEGRATION (Email marketing sync)
// ============================================================================

model MailchimpIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // API credentials
  apiKey     String @db.Text // Encrypted API key
  datacenter String // e.g., "us21"

  // Connected audience
  audienceId   String?
  audienceName String?

  // Sync settings
  syncEnabled         Boolean @default(true)
  autoSyncNewClients  Boolean @default(true)
  defaultOptIn        Boolean @default(true)
  welcomeEmailTrigger Boolean @default(false)

  // Tag mappings (JSON: { clientType: mailchimpTag })
  tagMappings Json?

  // Sync status
  lastSyncAt     DateTime?
  lastSyncError  String?
  syncedContacts Int       @default(0)

  // Settings
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  syncHistory  MailchimpSyncHistory[]

  @@index([organizationId])
}

model MailchimpSyncHistory {
  id            String @id @default(cuid())
  integrationId String

  // Sync details
  action       String // synced, created, updated, removed, error
  description  String
  contactCount Int    @default(0)

  // Status
  status       String // success, error
  errorMessage String?

  createdAt DateTime @default(now())

  // Relations
  integration MailchimpIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([createdAt])
}

// ============================================================================
// CALENDLY INTEGRATION (Booking import)
// ============================================================================

model CalendlyIntegration {
  id             String @id @default(cuid())
  organizationId String @unique

  // API credentials
  apiToken String @db.Text // Personal Access Token

  // User info from Calendly
  userUri   String?
  userName  String?
  userEmail String?

  // Webhook
  webhookUri String? // Calendly webhook subscription URI

  // Sync settings
  syncEnabled         Boolean @default(true)
  autoCreateBookings  Boolean @default(true)
  notifyOnNewBookings Boolean @default(true)

  // Event type to service mappings
  eventMappings Json? // { calendlyEventType: serviceId }

  // Sync status
  lastSyncAt    DateTime?
  lastSyncError String?

  // Settings
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
}

// ============================================================================
// BOOKING SLOTS (Self-booking availability slots)
// ============================================================================

model BookingSlot {
  id             String  @id @default(cuid())
  organizationId String
  userId         String? // Specific photographer (null = any available)
  serviceId      String? // Specific service (null = any)

  // Time slot
  startTime DateTime
  endTime   DateTime
  timezone  String   @default("America/New_York")

  // Recurrence (for weekly availability patterns)
  isRecurring    Boolean   @default(false)
  recurrenceRule String? // RRULE format
  recurrenceEnd  DateTime?

  // Booking capacity
  maxBookings     Int @default(1) // How many can book this slot
  currentBookings Int @default(0)

  // Pricing override
  priceCentsOverride Int? // Override service price for this slot

  // Settings
  isActive Boolean @default(true)

  // Buffer times (override service defaults)
  bufferBeforeMinutes Int?
  bufferAfterMinutes  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([serviceId])
  @@index([startTime])
  @@index([isActive])
}

// ============================================================================
// SERVICE TERRITORIES (Geographic zones with pricing modifiers)
// ============================================================================

model ServiceTerritory {
  id             String  @id @default(cuid())
  organizationId String
  name           String
  description    String? @db.Text

  // Geographic bounds (ZIP codes or coordinates)
  zipCodes    String[] // Array of ZIP codes in this territory
  centerLat   Decimal? @db.Decimal(10, 7) // Center point latitude
  centerLng   Decimal? @db.Decimal(10, 7) // Center point longitude
  radiusMiles Float? // Radius in miles from center (alternative to ZIP codes)

  // Pricing
  pricingModifier Float @default(1.0) // 1.0 = normal, 1.2 = 20% more, 0.9 = 10% discount
  flatFeeOverride Int? // Flat fee override in cents (instead of modifier)
  travelFee       Int? // Additional travel fee in cents

  // Availability
  isActive            Boolean @default(true)
  minLeadTimeHours    Int? // Minimum hours notice for bookings
  maxLeadTimeDays     Int? // Maximum days in advance for bookings
  availableDaysOfWeek Int[] // 0=Sun, 1=Mon, etc. Empty = all days

  // Visual
  color String? // Hex color for map display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  services     TerritoryServiceOverride[]

  @@index([organizationId])
  @@index([isActive])
}

model TerritoryServiceOverride {
  id          String @id @default(cuid())
  territoryId String
  serviceId   String

  // Override pricing for this service in this territory
  pricingModifier Float? // Override territory default
  flatPrice       Int? // Fixed price in cents (overrides modifier)
  isAvailable     Boolean @default(true) // Service available in this territory?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  territory ServiceTerritory @relation(fields: [territoryId], references: [id], onDelete: Cascade)
  service   Service          @relation("ServiceTerritoryOverrides", fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([territoryId, serviceId])
  @@index([territoryId])
  @@index([serviceId])
}

// ============================================================================
// REFERRAL PROGRAM (Agent referral tracking and rewards)
// ============================================================================

enum ReferralStatus {
  pending // Referral submitted, not yet converted
  qualified // Lead qualified/booking made
  completed // Service delivered
  rewarded // Reward issued
  expired // Referral expired without conversion
}

enum ReferralRewardType {
  percentage // Percentage of invoice
  fixed // Fixed amount
  credit // Account credit
  gift_card // Gift card
}

model ReferralProgram {
  id             String  @id @default(cuid())
  organizationId String  @unique
  name           String  @default("Referral Program")
  description    String? @db.Text

  // Program settings
  isActive         Boolean @default(false)
  requiresApproval Boolean @default(true) // Manual approval before reward

  // Reward configuration
  rewardType     ReferralRewardType @default(percentage)
  rewardValue    Float              @default(10) // 10% or $10 depending on type
  maxRewardCents Int? // Cap on reward amount

  // Referred client discount
  referredDiscount      Float? // Discount for referred client (e.g., 5%)
  referredDiscountCents Int? // Fixed discount in cents

  // Expiration
  referralValidDays    Int  @default(90) // How long referral link is valid
  rewardExpirationDays Int? // How long until reward expires after issue

  // Tracking
  termsUrl String? // Link to referral program terms

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  referrers    Referrer[]
  referrals    Referral[]
}

model Referrer {
  id        String @id @default(cuid())
  programId String

  // Referrer info (can be client, agent, or external)
  clientId String? @unique // If referrer is an existing client
  name     String
  email    String
  phone    String?

  // Unique referral code
  referralCode String @unique

  // Stats
  totalReferrals      Int @default(0)
  successfulReferrals Int @default(0)
  totalEarned         Int @default(0) // Total rewards in cents

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  program   ReferralProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)
  client    Client?          @relation("ClientReferrer", fields: [clientId], references: [id], onDelete: SetNull)
  referrals Referral[]
  rewards   ReferralReward[]

  @@index([programId])
  @@index([clientId])
  @@index([referralCode])
}

model Referral {
  id         String @id @default(cuid())
  programId  String
  referrerId String

  // Referred person info
  referredName  String
  referredEmail String
  referredPhone String?

  // Conversion tracking
  status    ReferralStatus @default(pending)
  clientId  String? // Created client (after conversion)
  bookingId String? // First booking
  invoiceId String? // First invoice

  // Metadata
  source      String? // Where referral came from (link, form, etc.)
  landingPage String? // URL they landed on
  utmCampaign String?
  utmSource   String?

  // Timestamps
  submittedAt DateTime  @default(now())
  qualifiedAt DateTime?
  completedAt DateTime?
  expiresAt   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  program  ReferralProgram  @relation(fields: [programId], references: [id], onDelete: Cascade)
  referrer Referrer         @relation(fields: [referrerId], references: [id], onDelete: Cascade)
  client   Client?          @relation("ReferralClient", fields: [clientId], references: [id], onDelete: SetNull)
  booking  Booking?         @relation("ReferralBooking", fields: [bookingId], references: [id], onDelete: SetNull)
  invoice  Invoice?         @relation("ReferralInvoice", fields: [invoiceId], references: [id], onDelete: SetNull)
  rewards  ReferralReward[]

  @@index([programId])
  @@index([referrerId])
  @@index([status])
  @@index([referredEmail])
}

model ReferralReward {
  id         String @id @default(cuid())
  referrerId String
  referralId String

  // Reward details
  rewardType  ReferralRewardType
  amountCents Int
  description String?

  // Status
  isIssued  Boolean   @default(false)
  issuedAt  DateTime?
  isClaimed Boolean   @default(false)
  claimedAt DateTime?
  expiresAt DateTime?

  // Payment tracking
  paymentMethod String? // How reward was paid (check, paypal, credit, etc.)
  paymentRef    String? // Reference number

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  referrer Referrer @relation(fields: [referrerId], references: [id], onDelete: Cascade)
  referral Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referralId])
  @@index([isIssued])
}

// ============================================================================
// PLATFORM REFERRAL SYSTEM (PhotoProOS user-to-user referrals)
// ============================================================================

enum PlatformReferralStatus {
  pending // Referred user hasn't signed up yet
  signed_up // User signed up but hasn't subscribed
  subscribed // User subscribed (conversion!)
  churned // User canceled subscription
  expired // Referral link expired
}

enum PlatformRewardType {
  account_credit // Credit towards subscription
  extended_trial // Extra trial days
  percentage_discount // Discount on next billing
  free_month // Free month of subscription
}

// Global platform referral program settings (admin-managed)
model PlatformReferralSettings {
  id String @id @default("default")

  // Program settings
  isActive              Boolean @default(true)
  referralLinkValidDays Int     @default(30) // How long referral links are valid

  // Referrer rewards (when referred user subscribes)
  referrerRewardType         PlatformRewardType @default(account_credit)
  referrerRewardValue        Int                @default(2500) // $25 credit or 25 days, etc.
  referrerMaxRewardsPerMonth Int? // Cap monthly rewards

  // Referred user benefits
  referredTrialDays       Int  @default(21) // Extended trial (vs default 14)
  referredDiscountPercent Int? // First month discount
  referredDiscountMonths  Int  @default(1) // How many months discount applies

  // Reward expiration
  rewardExpirationDays Int? // How long until reward expires after issue

  // Tracking
  totalReferrals          Int @default(0)
  totalConversions        Int @default(0)
  totalRewardsIssuedCents Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Each user's referral profile
model PlatformReferrer {
  id     String @id @default(cuid())
  userId String @unique

  // Referral code (unique, shareable)
  referralCode String  @unique
  referralUrl  String? // Custom vanity URL if allowed

  // Stats
  totalReferrals      Int @default(0)
  successfulReferrals Int @default(0) // Converted to paid
  totalEarnedCents    Int @default(0)
  pendingCreditCents  Int @default(0) // Credited but not yet applied

  // Status
  isActive Boolean @default(true)
  isBanned Boolean @default(false) // For abuse prevention

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  referrals PlatformReferral[]
  rewards   PlatformReferralReward[]

  @@index([referralCode])
  @@index([userId])
}

// Individual referral tracking
model PlatformReferral {
  id         String @id @default(cuid())
  referrerId String

  // Referred person (before they become a user)
  referredEmail String
  referredName  String?

  // Tracking
  status                 PlatformReferralStatus @default(pending)
  referredUserId         String? // Set when they sign up
  referredOrganizationId String? // Set when org created

  // Attribution
  source      String? // Where link was shared (email, social, etc.)
  landingPage String? // Which page they landed on
  utmCampaign String?
  utmSource   String?
  utmMedium   String?

  // Timestamps
  clickedAt    DateTime? // When they clicked the link
  signedUpAt   DateTime? // When they created account
  subscribedAt DateTime? // When they started paid subscription
  expiresAt    DateTime // When referral link expires

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  referrer             PlatformReferrer         @relation(fields: [referrerId], references: [id], onDelete: Cascade)
  referredUser         User?                    @relation("ReferredByPlatform", fields: [referredUserId], references: [id], onDelete: SetNull)
  referredOrganization Organization?            @relation("ReferredOrgByPlatform", fields: [referredOrganizationId], references: [id], onDelete: SetNull)
  rewards              PlatformReferralReward[]

  @@index([referrerId])
  @@index([referredEmail])
  @@index([referredUserId])
  @@index([status])
  @@index([expiresAt])
}

// Rewards issued for platform referrals
model PlatformReferralReward {
  id         String @id @default(cuid())
  referrerId String
  referralId String

  // Reward details
  rewardType  PlatformRewardType
  valueCents  Int // Dollar value or days
  description String?

  // Status
  isApplied Boolean   @default(false) // Has it been used?
  appliedAt DateTime?
  expiresAt DateTime? // Rewards can expire

  // Stripe integration
  stripePromotionCodeId String? // If using Stripe promo codes
  stripeCouponId        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  referrer PlatformReferrer @relation(fields: [referrerId], references: [id], onDelete: Cascade)
  referral PlatformReferral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referralId])
  @@index([isApplied])
}

// ============================================================================
// PHASE 2: CLIENT QUESTIONNAIRE TEMPLATES SYSTEM
// ============================================================================

// System-provided and custom questionnaire templates
model QuestionnaireTemplate {
  id             String  @id @default(cuid())
  organizationId String? // Null = system template

  // Template identity
  name        String
  slug        String
  description String?  @db.Text
  industry    Industry

  // Template settings
  isSystemTemplate Boolean @default(false)
  isActive         Boolean @default(true)
  usageCount       Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization    Organization?                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  fields          QuestionnaireField[]
  legalAgreements QuestionnaireTemplateAgreement[]
  questionnaires  ClientQuestionnaire[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([industry])
  @@index([isSystemTemplate])
  @@index([isActive])
}

// Fields within a questionnaire template
model QuestionnaireField {
  id         String @id @default(cuid())
  templateId String

  // Field configuration
  label       String
  type        FormFieldType
  placeholder String?
  helpText    String?
  isRequired  Boolean       @default(false)
  sortOrder   Int           @default(0)

  // Section grouping
  section      String? // e.g., "Property Details", "Agent Information"
  sectionOrder Int     @default(0)

  // Validation rules (JSON: { minLength, maxLength, pattern, min, max, options })
  validation Json?

  // Conditional visibility
  conditionalOn    String? // Field ID this depends on
  conditionalValue String? // Value that triggers display

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  template QuestionnaireTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([sortOrder])
}

// Legal agreements attached to questionnaire templates
model QuestionnaireTemplateAgreement {
  id         String @id @default(cuid())
  templateId String

  // Agreement details
  agreementType     LegalAgreementType
  title             String
  content           String             @db.Text
  isRequired        Boolean            @default(true)
  requiresSignature Boolean            @default(false)
  sortOrder         Int                @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  template QuestionnaireTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([agreementType])
}

// Questionnaire assigned to a specific client
model ClientQuestionnaire {
  id             String @id @default(cuid())
  organizationId String
  clientId       String
  templateId     String

  // Optional: link to booking or project
  bookingId String?
  projectId String?

  // Assignment settings
  isRequired  Boolean                   @default(true)
  dueDate     DateTime?
  status      ClientQuestionnaireStatus @default(pending)
  startedAt   DateTime?
  completedAt DateTime?

  // Reminder settings
  sendReminders Boolean   @default(true)
  remindersSent Int       @default(0)
  lastReminder  DateTime?

  // Internal notes (visible only to photographer)
  internalNotes String?

  // Personal note to include in assignment email
  personalNote String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client                         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  template     QuestionnaireTemplate          @relation(fields: [templateId], references: [id], onDelete: Cascade)
  booking      Booking?                       @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  project      Project?                       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  responses    ClientQuestionnaireResponse[]
  agreements   ClientQuestionnaireAgreement[]
  emailLogs    EmailLog[]

  @@index([organizationId])
  @@index([clientId])
  @@index([templateId])
  @@index([bookingId])
  @@index([projectId])
  @@index([status])
  @@index([dueDate])
}

// Client's response to a questionnaire field
model ClientQuestionnaireResponse {
  id              String @id @default(cuid())
  questionnaireId String

  // Response data
  fieldLabel String // Store label for reference after template changes
  fieldType  String // Store type for proper rendering
  value      Json // Actual response value

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  questionnaire ClientQuestionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)

  @@index([questionnaireId])
}

// Legal agreement acceptance record
model ClientQuestionnaireAgreement {
  id              String @id @default(cuid())
  questionnaireId String

  // Agreement details (snapshot from template)
  agreementType LegalAgreementType
  title         String
  content       String             @db.Text

  // Acceptance status
  accepted   Boolean   @default(false)
  acceptedAt DateTime?

  // Signature data (if signature required)
  signatureData String?        @db.Text // Base64 encoded signature image
  signatureType SignatureType?

  // Audit fields
  acceptedIp        String?
  acceptedUserAgent String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  questionnaire ClientQuestionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)

  @@index([questionnaireId])
  @@index([agreementType])
  @@index([accepted])
}

// ============================================================================
// SUBSCRIPTION PLANS & PRICING (Application-Level SaaS Plans)
// ============================================================================

// Billing interval for subscription plans
enum BillingInterval {
  monthly
  yearly
}

// Status of a pricing experiment
enum ExperimentStatus {
  draft // Being configured
  active // Running and collecting data
  paused // Temporarily stopped
  completed // Finished, results available
  archived // No longer relevant
}

// Subscription plans for the application (Pro, Studio, Enterprise)
model SubscriptionPlan {
  id   String   @id @default(cuid())
  name String   @unique // "Pro", "Studio", "Enterprise"
  slug String   @unique // "pro", "studio", "enterprise"
  plan PlanName // Links to the enum

  // Display
  description    String? @db.Text
  tagline        String? // Short marketing tagline
  badgeText      String? // e.g., "Most Popular", "Best Value"
  displayOrder   Int     @default(0) // For ordering on pricing page
  isHighlighted  Boolean @default(false) // Highlight this plan (e.g., recommended)
  highlightColor String? // Custom highlight color

  // Pricing (default pricing, can be overridden by variants)
  monthlyPriceCents Int // Base monthly price in cents
  yearlyPriceCents  Int // Base yearly price in cents (usually discounted)

  // Stripe Product & Prices (default)
  stripeProductId      String?   @unique // Stripe Product ID (prod_xxx)
  stripeMonthlyPriceId String? // Stripe Price ID for monthly (price_xxx)
  stripeYearlyPriceId  String? // Stripe Price ID for yearly (price_xxx)
  stripeSyncedAt       DateTime?

  // Trial configuration
  trialDays Int @default(14) // Free trial duration

  // Status
  isActive Boolean @default(true) // Available for new signups
  isPublic Boolean @default(true) // Visible on public pricing page
  isLegacy Boolean @default(false) // Old plan, grandfathered users only

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  features        PlanFeature[]
  pricingVariants PricingVariant[]

  @@index([isActive, isPublic])
  @@index([plan])
}

// Features included in each plan
model PlanFeature {
  id     String @id @default(cuid())
  planId String

  // Feature definition
  name        String // "Unlimited Galleries", "Priority Support"
  description String? // Detailed description
  category    String? // "Core", "Support", "Integrations", etc.

  // Value (for limits and quotas)
  featureKey   String // Unique key like "galleries_limit", "storage_gb", "team_members"
  featureValue String // Can be "unlimited", a number, or "true"/"false"

  // Display
  displayOrder  Int     @default(0)
  isHighlighted Boolean @default(false) // Show with emphasis
  tooltip       String? // Help text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  plan SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, featureKey])
  @@index([planId])
  @@index([featureKey])
}

// A/B Testing: Pricing experiments for testing different price points
model PricingExperiment {
  id   String @id @default(cuid())
  name String // "Q1 2025 Price Test", "Enterprise Discount Test"
  slug String @unique

  // Description
  description String? @db.Text
  hypothesis  String? @db.Text // What we're testing

  // Experiment configuration
  status    ExperimentStatus @default(draft)
  startDate DateTime?
  endDate   DateTime?

  // Traffic allocation
  trafficPercent Int @default(50) // Percent of traffic to see experiment (vs control)

  // Landing page targeting
  landingPagePaths String[] // e.g., ["/pricing", "/enterprise"] - which pages to run on

  // Results tracking
  controlConversions      Int     @default(0)
  controlImpressions      Int     @default(0)
  variantConversions      Int     @default(0)
  variantImpressions      Int     @default(0)
  winningVariantId        String?
  statisticalSignificance Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  variants PricingVariant[]

  @@index([status])
  @@index([startDate, endDate])
}

// Pricing variants for A/B testing different price points
model PricingVariant {
  id           String  @id @default(cuid())
  experimentId String?
  planId       String

  // Variant details
  name        String // "10% Discount", "Premium Pricing", "Control"
  description String?
  isControl   Boolean @default(false) // Is this the control variant?

  // Override pricing (null = use plan's default pricing)
  monthlyPriceCents Int?
  yearlyPriceCents  Int?

  // Override trial
  trialDays Int?

  // Stripe Prices for this variant
  stripeMonthlyPriceId String?
  stripeYearlyPriceId  String?
  stripeSyncedAt       DateTime?

  // Display overrides
  badgeText     String? // Override badge
  isHighlighted Boolean?

  // Stats
  impressions Int @default(0)
  conversions Int @default(0)

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  experiment PricingExperiment? @relation(fields: [experimentId], references: [id], onDelete: SetNull)
  plan       SubscriptionPlan   @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([experimentId])
  @@index([planId])
  @@index([isActive])
}

// ============================================================================
// EMAIL LOGGING SYSTEM
// ============================================================================

// Log of all emails sent from the system
model EmailLog {
  id             String @id @default(cuid())
  organizationId String

  // Recipient info
  toEmail  String
  toName   String?
  clientId String?

  // Email details
  emailType EmailType
  subject   String
  status    EmailStatus @default(pending)

  // Optional linking to related entities
  questionnaireId String?
  bookingId       String?
  projectId       String?
  invoiceId       String?
  contractId      String?
  galleryId       String?

  // Resend tracking
  resendId     String? // ID from Resend API
  errorMessage String? @db.Text

  // Timestamps
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  organization  Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client        Client?              @relation(fields: [clientId], references: [id], onDelete: SetNull)
  questionnaire ClientQuestionnaire? @relation(fields: [questionnaireId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([clientId])
  @@index([emailType])
  @@index([status])
  @@index([questionnaireId])
  @@index([createdAt])
}

// ============================================================================
// API KEYS & WEBHOOKS FOR INTEGRATIONS
// ============================================================================

// Webhook event types for external integrations
enum WebhookEventType {
  // Gallery events
  gallery_created
  gallery_delivered
  gallery_viewed
  gallery_paid
  // Booking events
  booking_created
  booking_confirmed
  booking_cancelled
  booking_completed
  // Invoice events
  invoice_created
  invoice_sent
  invoice_paid
  invoice_overdue
  // Payment events
  payment_received
  payment_failed
  payment_refunded
  // Client events
  client_created
  client_updated
  // Contract events
  contract_sent
  contract_signed
  // Project events
  project_created
  project_completed
}

// API keys for third-party integrations
model ApiKey {
  id             String    @id @default(cuid())
  organizationId String
  name           String // User-provided name for the key
  keyPrefix      String // Visible prefix (e.g., "sk_live_xxxx") for identification
  keyHash        String // SHA-256 hash of the full key (never store plaintext)
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  scopes         String[]  @default(["read", "write"]) // Permissions: read, write, admin
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, keyPrefix])
  @@index([organizationId])
  @@index([keyHash])
  @@index([isActive])
}

// Webhook endpoints for sending event notifications
model WebhookEndpoint {
  id             String    @id @default(cuid())
  organizationId String
  url            String // The URL to send webhook payloads to
  description    String? // Optional user description
  secret         String // HMAC signing secret for verification
  events         String[] // Array of WebhookEventType values to subscribe to
  isActive       Boolean   @default(true)
  lastDeliveryAt DateTime?
  failureCount   Int       @default(0) // Consecutive failures (reset on success)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([organizationId])
  @@index([isActive])
}

// Webhook delivery attempts for debugging and retry logic
model WebhookDelivery {
  id                String    @id @default(cuid())
  webhookEndpointId String
  eventType         String // The event that triggered this delivery
  payload           Json // The full payload that was sent
  responseStatus    Int? // HTTP status code from the receiver
  responseBody      String?   @db.Text // Response body (truncated if too large)
  deliveredAt       DateTime? // When the webhook was successfully delivered
  attemptCount      Int       @default(1) // Number of delivery attempts
  success           Boolean   @default(false)
  errorMessage      String? // Error message if delivery failed
  createdAt         DateTime  @default(now())

  endpoint WebhookEndpoint @relation(fields: [webhookEndpointId], references: [id], onDelete: Cascade)

  @@index([webhookEndpointId])
  @@index([createdAt])
  @@index([success])
}

// Integration activity logs for debugging and monitoring
model IntegrationLog {
  id             String   @id @default(cuid())
  organizationId String
  provider       String // Integration provider: google_calendar, dropbox, slack, stripe, etc.
  eventType      String // Event type: connected, disconnected, sync_started, sync_completed, error, etc.
  message        String // Human-readable description of the event
  details        Json? // Additional structured data about the event
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, provider])
  @@index([createdAt])
}

// ============================================================================
// UNIFIED EMAIL INBOX (Gmail/Outlook Integration)
// ============================================================================

// Connected email accounts for unified inbox
model EmailAccount {
  id             String @id @default(cuid())
  organizationId String

  // Provider info
  provider EmailProvider // GMAIL or OUTLOOK
  email    String // User's email address

  // OAuth tokens (encrypted in application layer)
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  tokenExpiry  DateTime

  // Sync state
  syncCursor  String? // For incremental sync (Gmail historyId or Outlook deltaLink)
  lastSyncAt  DateTime?
  syncEnabled Boolean   @default(true)

  // Status
  isActive     Boolean @default(true)
  errorMessage String? // Last sync error if any

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  threads      EmailThread[]

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([provider])
  @@index([isActive])
}

// Email conversations (threads) - groups related messages together
model EmailThread {
  id             String @id @default(cuid())
  organizationId String
  emailAccountId String

  // Thread metadata
  subject           String
  snippet           String   @db.Text // Preview text of latest message
  participantEmails String[] // All email addresses in the thread

  // Client linking (auto-matched or manually linked)
  clientId String?

  // Status flags
  isRead     Boolean @default(false)
  isStarred  Boolean @default(false)
  isArchived Boolean @default(false)
  isDraft    Boolean @default(false)

  // Provider IDs for sync
  providerThreadId String // Gmail thread ID or Outlook conversation ID

  // Timestamps
  lastMessageAt DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  emailAccount EmailAccount   @relation(fields: [emailAccountId], references: [id], onDelete: Cascade)
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?        @relation("ClientEmailThreads", fields: [clientId], references: [id], onDelete: SetNull)
  messages     EmailMessage[]

  @@unique([emailAccountId, providerThreadId])
  @@index([organizationId])
  @@index([emailAccountId])
  @@index([clientId])
  @@index([isRead])
  @@index([isArchived])
  @@index([lastMessageAt])
}

// Individual email messages within a thread
model EmailMessage {
  id       String @id @default(cuid())
  threadId String

  // Provider ID for sync
  providerMessageId String // Gmail message ID or Outlook message ID

  // Message headers
  fromEmail  String
  fromName   String?
  toEmails   String[]
  toNames    String[]
  ccEmails   String[]
  bccEmails  String[]
  replyTo    String?
  subject    String
  inReplyTo  String? // Message-ID of parent message
  references String[] // Message-ID chain for threading

  // Message body
  bodyHtml String? @db.Text
  bodyText String? @db.Text

  // Direction
  direction EmailDirection // INBOUND or OUTBOUND

  // Status
  isRead Boolean @default(false)

  // Attachments
  hasAttachments Boolean @default(false)

  // Timestamps
  sentAt    DateTime
  createdAt DateTime @default(now())

  thread      EmailThread       @relation(fields: [threadId], references: [id], onDelete: Cascade)
  attachments EmailAttachment[]

  @@unique([threadId, providerMessageId])
  @@index([threadId])
  @@index([direction])
  @@index([sentAt])
  @@index([fromEmail])
}

// Email attachments stored in S3/Cloudflare R2
model EmailAttachment {
  id        String @id @default(cuid())
  messageId String

  // File info
  filename    String
  contentType String
  size        Int // Size in bytes

  // Storage
  storageKey String // S3/R2 key for the file
  storageUrl String? // Pre-signed URL (temporary) or public URL

  // Provider ID for sync
  providerAttachmentId String?

  createdAt DateTime @default(now())

  message EmailMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

// ============================================================================
// GALLERY ADD-ONS & UPSELLS
// ============================================================================

// Catalog of available add-ons that can be offered on galleries
model GalleryAddon {
  id             String @id @default(cuid())
  organizationId String

  // Add-on info
  name        String
  description String?
  iconName    String? // Icon identifier (lucide icon name)

  // Pricing
  priceCents   Int? // Base price in cents (null = "Request Quote")
  pricePerItem Boolean @default(false) // If true, price is per photo

  // Categorization
  category GalleryAddonCategory @default(other)

  // Industry targeting (null = available to all industries)
  industries ClientIndustry[] // Which industries this add-on applies to

  // Turnaround
  estimatedTurnaround String? // e.g., "24-48 hours", "3-5 business days"

  // Display
  sortOrder Int     @default(0)
  imageUrl  String? // Preview/sample image

  // Settings
  isActive          Boolean @default(true)
  requiresSelection Boolean @default(false) // Requires selecting specific photos
  maxPhotos         Int? // Maximum photos that can be selected (null = unlimited)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  requests     GalleryAddonRequest[]

  @@index([organizationId])
  @@index([isActive])
  @@index([category])
}

// Client requests for gallery add-ons
model GalleryAddonRequest {
  id             String  @id @default(cuid())
  organizationId String
  projectId      String // The gallery
  addonId        String
  clientEmail    String? // Email of requesting client
  clientId       String? // If associated with a client record

  // Status
  status GalleryAddonRequestStatus @default(pending)

  // Request details
  notes          String?  @db.Text // Client notes/instructions
  selectedPhotos String[] // Asset IDs of selected photos (if requiresSelection)

  // Quote (filled by photographer)
  quoteCents       Int? // Quoted price
  quoteDescription String?   @db.Text // Quote details
  quotedAt         DateTime?

  // Approval
  approvedAt DateTime?
  declinedAt DateTime?

  // Completion
  completedAt  DateTime?
  deliveryNote String?   @db.Text // Note when delivering completed work

  // Invoice link
  invoiceId String? // If an invoice was created for this

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  addon        GalleryAddon @relation(fields: [addonId], references: [id], onDelete: Cascade)
  client       Client?      @relation(fields: [clientId], references: [id], onDelete: SetNull)
  invoice      Invoice?     @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([projectId])
  @@index([addonId])
  @@index([clientId])
  @@index([status])
}

// ============================================================================
// PROJECT CHAT / MESSAGING
// ============================================================================

// Messages for project-based communication
model ProjectMessage {
  id             String @id @default(cuid())
  organizationId String
  projectId      String

  // Sender info - can be team member or client
  senderType   String // "team" or "client"
  senderUserId String? // Clerk user ID for team members
  senderName   String // Display name
  senderEmail  String? // Email (for clients without user ID)
  senderAvatar String? // Avatar URL

  // Message content
  content String @db.Text

  // Visibility toggle - internal (team only) or client (visible to all)
  visibility MessageVisibility @default(client)

  // Attachments (stored as JSON array of { filename, url, size, type })
  attachments Json?

  // Read receipts
  readBy String[] // Array of user IDs who have read this message
  readAt DateTime? // When client read (for client messages)

  // Threading (optional - for replies)
  parentId String? // Parent message ID for threading

  // Status
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parent       ProjectMessage?  @relation("MessageReplies", fields: [parentId], references: [id], onDelete: SetNull)
  replies      ProjectMessage[] @relation("MessageReplies")

  @@index([organizationId])
  @@index([projectId])
  @@index([visibility])
  @@index([createdAt])
  @@index([parentId])
}

// ============================================================================
// PROJECT EXPENSES / P&L
// ============================================================================

// Individual expense entries for a project
model ProjectExpense {
  id             String @id @default(cuid())
  organizationId String
  projectId      String

  // Expense details
  description String
  category    ExpenseCategory @default(other)
  amountCents Int // Amount in cents
  currency    String          @default("USD")

  // Vendor/payee info
  vendor       String? // Who was paid
  teamMemberId String? // If paid to team member (for contractor pay)

  // Date tracking
  expenseDate DateTime  @default(now()) // When expense occurred
  paidDate    DateTime? // When expense was paid (null if unpaid)
  isPaid      Boolean   @default(true)

  // Receipt/documentation
  receiptUrl String? // URL to receipt image
  notes      String? @db.Text

  // Tracking
  createdBy String? // User ID who created this

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project      Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([projectId])
  @@index([category])
  @@index([expenseDate])
}

// ============================================================================
// MESSAGING SYSTEM
// ============================================================================

// Conversation - Container for all message threads
model Conversation {
  id             String           @id @default(cuid())
  organizationId String
  type           ConversationType @default(direct)

  // Metadata
  name        String? // Required for group/channel, optional for direct
  description String?
  avatarUrl   String? // Custom avatar for group chats

  // For client_support: link to client
  clientId String?

  // For project-specific conversations
  projectId String?

  // Settings
  isArchived     Boolean @default(false)
  isMuted        Boolean @default(false)
  allowReactions Boolean @default(true)
  allowThreads   Boolean @default(true)

  // Real-time support fields (for polling optimization)
  lastMessageAt DateTime?
  lastMessageId String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  archivedAt DateTime?

  // Relations
  organization Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client?                   @relation("ConversationClient", fields: [clientId], references: [id], onDelete: SetNull)
  project      Project?                  @relation("ConversationProject", fields: [projectId], references: [id], onDelete: SetNull)
  participants ConversationParticipant[]
  messages     Message[]
  chatRequest  ChatRequest?

  @@index([organizationId])
  @@index([clientId])
  @@index([projectId])
  @@index([type])
  @@index([lastMessageAt])
  @@index([isArchived])
}

// ConversationParticipant - Who's in each conversation
model ConversationParticipant {
  id             String @id @default(cuid())
  conversationId String

  // Participant can be team member OR client (not both)
  userId   String? // Clerk user ID for team members
  clientId String? // Client ID for clients

  role ConversationParticipantRole @default(member)

  // Individual settings per participant
  isMuted  Boolean @default(false)
  isPinned Boolean @default(false)

  // Read tracking
  lastReadAt        DateTime?
  lastReadMessageId String?

  // Notification preferences (overrides org defaults)
  notifyOnMessage Boolean @default(true)
  notifyOnMention Boolean @default(true)

  // Brokerage context (for broker-level access)
  addedByBrokerId String? // Track who added this participant
  hasBrokerAccess Boolean @default(false) // Full broker visibility

  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client       Client?      @relation("ParticipantClient", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@unique([conversationId, clientId])
  @@index([conversationId])
  @@index([userId])
  @@index([clientId])
  @@index([lastReadAt])
}

// Message - Individual messages within conversations
model Message {
  id             String @id @default(cuid())
  conversationId String

  // Sender (either team member or client)
  senderUserId   String? // Clerk user ID for team
  senderClientId String? // Client ID for clients
  senderName     String // Cached display name
  senderAvatar   String? // Cached avatar URL

  // Content
  content     String  @db.Text
  contentHtml String? @db.Text // Pre-rendered HTML for rich text

  // Threading
  parentId    String? // For thread replies
  threadCount Int     @default(0) // Denormalized reply count

  // Attachments (stored as JSON array)
  attachments Json? // [{filename, url, size, type, thumbnailUrl}]

  // Mentions (stored as JSON array of user/client IDs)
  mentions Json? // [{type: "user"|"client", id: string}]

  // Status
  isEdited       Boolean   @default(false)
  editedAt       DateTime?
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  isPinned       Boolean   @default(false)
  pinnedAt       DateTime?
  pinnedByUserId String?

  // System messages
  isSystemMessage Boolean @default(false)
  systemAction    String? // "member_added", "member_removed", "conversation_created", etc.

  // Real-time sync
  clientMessageId String? // Client-side ID for optimistic updates

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  conversation Conversation         @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderUser   User?                @relation("MessageSender", fields: [senderUserId], references: [id], onDelete: SetNull)
  senderClient Client?              @relation("MessageSenderClient", fields: [senderClientId], references: [id], onDelete: SetNull)
  parent       Message?             @relation("MessageThread", fields: [parentId], references: [id], onDelete: SetNull)
  replies      Message[]            @relation("MessageThread")
  reactions    MessageReaction[]
  readReceipts MessageReadReceipt[]

  @@index([conversationId])
  @@index([parentId])
  @@index([createdAt])
  @@index([senderUserId])
  @@index([senderClientId])
  @@index([isDeleted])
}

// MessageReaction - Emoji reactions on messages
model MessageReaction {
  id        String              @id @default(cuid())
  messageId String
  userId    String? // Team member
  clientId  String? // Or client
  type      MessageReactionType

  createdAt DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client  Client? @relation("ReactionClient", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, type])
  @@unique([messageId, clientId, type])
  @@index([messageId])
}

// MessageReadReceipt - Track who read each message
model MessageReadReceipt {
  id        String   @id @default(cuid())
  messageId String
  userId    String?
  clientId  String?
  readAt    DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  client  Client? @relation("ReadReceiptClient", fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@unique([messageId, clientId])
  @@index([messageId])
}

// ChatRequest - Client chat approval workflow
model ChatRequest {
  id             String  @id @default(cuid())
  organizationId String
  clientId       String
  conversationId String? @unique // Created when approved

  // Request details
  subject        String // Client's topic/reason
  initialMessage String @db.Text

  // Status
  status ChatRequestStatus @default(pending)

  // Response
  respondedAt       DateTime?
  respondedByUserId String?
  rejectionReason   String?

  // Expiration
  expiresAt DateTime? // Optional auto-expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  respondedBy  User?         @relation("ChatRequestResponder", fields: [respondedByUserId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([clientId])
  @@index([status])
  @@index([createdAt])
}
