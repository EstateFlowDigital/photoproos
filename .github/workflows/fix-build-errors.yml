name: Auto-fix Build Errors

on:
  # Triggered by Railway webhook via repository_dispatch
  repository_dispatch:
    types: [railway-build-failed]

  # Manual trigger with error logs
  workflow_dispatch:
    inputs:
      error_logs:
        description: 'Paste the build error logs here'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  fix-build-errors:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get error logs
        id: get-logs
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "logs<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.client_payload.logs }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "logs<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.inputs.error_logs }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code to fix errors
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Create a prompt file with the error logs
          cat << 'PROMPT_EOF' > /tmp/fix-prompt.txt
          You are fixing TypeScript build errors in a Next.js application.

          Here are the build error logs:

          ${{ steps.get-logs.outputs.logs }}

          Instructions:
          1. Analyze the error messages carefully
          2. Read the relevant files to understand the context
          3. Fix each error one by one
          4. Make minimal changes - only fix what's broken
          5. Do NOT add new features or refactor unrelated code
          6. After fixing, verify by running: npx tsc --noEmit

          Start by reading the files mentioned in the errors, then make the necessary fixes.
          PROMPT_EOF

          # Run Claude Code with the prompt
          claude --dangerously-skip-permissions -p "$(cat /tmp/fix-prompt.txt)"

      - name: Verify TypeScript compiles
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            fix: auto-fix build errors from Railway

            ðŸ¤– Generated with Claude Code

            Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
          title: "fix: Auto-fix build errors from Railway"
          body: |
            ## Automated Build Error Fix

            This PR was automatically generated by Claude Code in response to a failed Railway build.

            ### Error Logs
            ```
            ${{ steps.get-logs.outputs.logs }}
            ```

            ### Changes Made
            Please review the changes carefully before merging.

            ---
            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          branch: fix/auto-build-errors-${{ github.run_id }}
          delete-branch: true
          labels: |
            automated
            build-fix
